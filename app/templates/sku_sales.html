{% extends "base.html" %}

{% block title %}Ventas por SKU{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Ventas por SKU</h1>
    <p class="text-gray-600">Total de productos vendidos agrupados por SKU</p>
</div>

<!-- Filtro de fechas -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
    <div class="flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
            <input type="date" name="date_from" id="date_from"
                   class="border rounded px-3 py-2 text-sm">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
            <input type="date" name="date_to" id="date_to"
                   class="border rounded px-3 py-2 text-sm">
        </div>
        <button type="button" id="btn-filtrar"
                class="bg-yellow-400 text-gray-800 font-semibold px-4 py-2 rounded hover:bg-yellow-500 transition text-sm">
            Filtrar
        </button>
        <button type="button" id="btn-limpiar"
                class="border border-gray-300 text-gray-600 px-4 py-2 rounded hover:bg-gray-100 transition text-sm">
            Limpiar
        </button>
    </div>
</div>

<div class="bg-white rounded-lg shadow overflow-hidden">
    <div id="sku-sales-table">
        <div class="animate-pulse p-4 space-y-3">
            {% for i in range(10) %}
            <div class="h-12 bg-gray-200 rounded"></div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const today = new Date();
    const monthAgo = new Date();
    monthAgo.setMonth(monthAgo.getMonth() - 1);

    document.getElementById('date_to').value = today.toISOString().split('T')[0];
    document.getElementById('date_from').value = monthAgo.toISOString().split('T')[0];

    function loadInventoryForSkus() {
        var rows = document.querySelectorAll('#sku-sales-table tr[data-sku]');
        if (!rows.length) return;
        var skus = [];
        rows.forEach(function(row) { skus.push(row.getAttribute('data-sku')); });
        fetch('/api/items/inventory-sku-sales?skus=' + encodeURIComponent(skus.join(',')))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                rows.forEach(function(row) {
                    var sku = row.getAttribute('data-sku');
                    var inv = data[sku];
                    var mtyCell = row.querySelector('.inv-mty');
                    var cdmxCell = row.querySelector('.inv-cdmx');
                    if (inv) {
                        var mty = inv.MTY || 0;
                        var cdmx = inv.CDMX || 0;
                        mtyCell.innerHTML = '<span class="font-medium ' + (mty > 0 ? 'text-green-700' : 'text-red-600') + '">' + mty + '</span>';
                        cdmxCell.innerHTML = '<span class="font-medium ' + (cdmx > 0 ? 'text-green-700' : 'text-red-600') + '">' + cdmx + '</span>';
                    } else {
                        mtyCell.innerHTML = '<span class="text-gray-400 text-xs">N/A</span>';
                        cdmxCell.innerHTML = '<span class="text-gray-400 text-xs">N/A</span>';
                    }
                });
            })
            .catch(function() {
                rows.forEach(function(row) {
                    row.querySelector('.inv-mty').innerHTML = '<span class="text-red-400 text-xs">Error</span>';
                    row.querySelector('.inv-cdmx').innerHTML = '<span class="text-red-400 text-xs">Error</span>';
                });
            });
    }

    // ── Paginación SKU (client-side) ──────────────────────────────────────────
    var _SKU_PER_PAGE = 20;
    var _skuPage      = 1;
    var _skuViewAll   = false;

    function _getAllSkuRows() {
        return Array.from(document.querySelectorAll('#sku-tbody tr.sku-data-row'));
    }

    function _applySkuPage(page) {
        var rows = _getAllSkuRows();
        if (!rows.length) return;

        var total      = rows.length;
        var totalPages = Math.ceil(total / _SKU_PER_PAGE);
        _skuPage = Math.max(1, Math.min(page, totalPages));

        if (_skuViewAll) {
            rows.forEach(function(r) { r.classList.remove('hidden'); });
        } else {
            var start = (_skuPage - 1) * _SKU_PER_PAGE;
            var end   = start + _SKU_PER_PAGE;
            rows.forEach(function(r, i) {
                r.classList.toggle('hidden', i < start || i >= end);
            });
        }
        _renderSkuPagination(total, _skuPage, totalPages);
    }

    function _renderSkuPagination(total, page, totalPages) {
        var container = document.getElementById('sku-pagination');
        if (!container) return;

        if (total <= _SKU_PER_PAGE && !_skuViewAll) {
            container.innerHTML = '';
            return;
        }

        var start = _skuViewAll ? 1 : (page - 1) * _SKU_PER_PAGE + 1;
        var end   = _skuViewAll ? total : Math.min(page * _SKU_PER_PAGE, total);

        // Botones de página con ellipsis
        var pageBtns = '';
        if (!_skuViewAll) {
            var last = 0;
            for (var p = 1; p <= totalPages; p++) {
                var near = p >= page - 2 && p <= page + 2;
                var edge = p === 1 || p === totalPages;
                if (!near && !edge) continue;
                if (last > 0 && p - last > 1) pageBtns += '<span class="px-1 text-gray-300 select-none text-xs">…</span>';
                last = p;
                if (p === page) {
                    pageBtns += '<button class="min-w-[32px] h-8 px-2 rounded-lg text-xs font-semibold border bg-yellow-400 text-gray-800 border-yellow-400 cursor-default">' + p + '</button>';
                } else {
                    pageBtns += '<button onclick="window._paginateSkus(' + p + ')" class="min-w-[32px] h-8 px-2 rounded-lg text-xs font-semibold border border-gray-200 text-gray-600 hover:border-yellow-400 hover:text-yellow-700 transition">' + p + '</button>';
                }
            }
        }

        container.innerHTML =
            '<div class="px-4 py-3 border-t border-gray-100 bg-white flex flex-wrap items-center justify-between gap-3">' +
            '<span class="text-xs text-gray-400">Mostrando <strong class="text-gray-600">' + start + '–' + end + '</strong> de <strong class="text-gray-600">' + total + '</strong> SKUs</span>' +
            '<div class="flex items-center gap-1 flex-wrap">' +
            (!_skuViewAll ?
                '<button onclick="window._paginateSkus(' + (page - 1) + ')" ' + (page <= 1 ? 'disabled' : '') +
                ' class="h-8 px-3 rounded-lg text-xs font-semibold border border-gray-200 text-gray-600 hover:border-yellow-400 hover:text-yellow-700 disabled:opacity-30 disabled:cursor-not-allowed transition">‹ Ant</button>' +
                pageBtns +
                '<button onclick="window._paginateSkus(' + (page + 1) + ')" ' + (page >= totalPages ? 'disabled' : '') +
                ' class="h-8 px-3 rounded-lg text-xs font-semibold border border-gray-200 text-gray-600 hover:border-yellow-400 hover:text-yellow-700 disabled:opacity-30 disabled:cursor-not-allowed transition">Sig ›</button>'
            : '') +
            '<button onclick="window._paginateSkus(0, true)" class="h-8 px-3 rounded-lg text-xs font-semibold border transition ml-1 ' +
            (_skuViewAll ? 'border-yellow-300 bg-yellow-50 text-yellow-700 hover:bg-white' : 'border-gray-200 text-gray-500 hover:border-yellow-400 hover:text-yellow-700') + '">' +
            (_skuViewAll ? '← Paginar' : 'Ver todos') + '</button>' +
            '</div></div>';
    }

    window._paginateSkus = function(page, toggle) {
        if (toggle !== undefined) {
            _skuViewAll = !_skuViewAll;
            _skuPage = 1;
            _applySkuPage(1);
        } else {
            _applySkuPage(page);
        }
    };

    function _initSkuPagination() {
        _skuPage    = 1;
        _skuViewAll = false;
        _applySkuPage(1);
    }
    // ── Fin paginación SKU ────────────────────────────────────────────────────

    function loadSkuTable(url) {
        var target = document.getElementById('sku-sales-table');
        target.innerHTML = '<div class="p-8 text-center text-gray-500"><svg class="animate-spin h-8 w-8 mx-auto mb-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Cargando ordenes, esto puede tardar unos segundos...</div>';
        document.getElementById('btn-filtrar').disabled = true;
        document.getElementById('btn-filtrar').classList.add('opacity-50');
        fetch(url)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                target.innerHTML = html;
                document.getElementById('btn-filtrar').disabled = false;
                document.getElementById('btn-filtrar').classList.remove('opacity-50');
                loadInventoryForSkus();
                _initSkuPagination();
            });
    }

    document.getElementById('btn-filtrar').addEventListener('click', function() {
        var dateFrom = document.getElementById('date_from').value;
        var dateTo = document.getElementById('date_to').value;
        var params = [];
        if (dateFrom) params.push('date_from=' + dateFrom);
        if (dateTo) params.push('date_to=' + dateTo);
        loadSkuTable('/partials/sku-sales-table?' + params.join('&'));
    });

    document.getElementById('btn-limpiar').addEventListener('click', function() {
        document.getElementById('date_from').value = '';
        document.getElementById('date_to').value = '';
        loadSkuTable('/partials/sku-sales-table');
    });

    // Carga inicial con fechas por defecto
    loadSkuTable('/partials/sku-sales-table?date_from=' + document.getElementById('date_from').value + '&date_to=' + document.getElementById('date_to').value);
</script>
{% endblock %}

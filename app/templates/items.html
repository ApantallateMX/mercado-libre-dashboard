{% extends "base.html" %}

{% block title %}Centro de Productos{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-3 md:mb-4">
    <h1 class="text-xl md:text-2xl font-bold text-gray-800">Centro de Productos</h1>
    <p class="text-sm text-gray-600 hidden md:block">Inteligencia y optimizacion para alcanzar la meta de $500k/dia</p>
</div>

<!-- Tabs (4) -->
<div class="bg-white rounded-lg shadow mb-4 md:mb-6">
    <div class="flex border-b" id="product-tabs">
        <button data-tab="summary" data-url="/partials/products-summary"
                class="tab-btn flex-1 md:flex-none px-3 md:px-4 py-3 min-h-[44px] text-xs md:text-sm font-medium border-b-2 whitespace-nowrap border-yellow-400 text-yellow-700 bg-yellow-50 active:bg-yellow-100">
            Resumen
        </button>
        <button data-tab="inventory" data-url="/partials/products-inventory"
                class="tab-btn flex-1 md:flex-none px-3 md:px-4 py-3 min-h-[44px] text-xs md:text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 active:bg-gray-50">
            Inventario
        </button>
        <button data-tab="stock" data-url="/partials/products-stock-issues"
                class="tab-btn flex-1 md:flex-none px-3 md:px-4 py-3 min-h-[44px] text-xs md:text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 active:bg-gray-50">
            Stock
        </button>
        <button data-tab="unpublished" data-url="/partials/products-not-published"
                class="tab-btn flex-1 md:flex-none px-3 md:px-4 py-3 min-h-[44px] text-xs md:text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 active:bg-gray-50">
            Sin Publicar
        </button>
    </div>
</div>

<!-- Tab content -->
<div id="tab-content">
    <!-- Default: skeleton loading -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for i in range(4) %}
        <div class="bg-white rounded-lg shadow p-6 animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
            <div class="h-8 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-3 bg-gray-200 rounded w-1/3"></div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de edicion (full-screen mobile, centered desktop) -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end md:items-center justify-center">
    <div class="bg-white md:rounded-xl shadow-2xl w-full md:max-w-2xl h-[95vh] md:h-auto md:max-h-[90vh] overflow-y-auto rounded-t-2xl md:m-4">
        <div id="edit-modal-content" class="p-4 md:p-6">
            Cargando...
        </div>
    </div>
</div>

<!-- Modal de confirmacion -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-end md:items-center justify-center">
    <div class="bg-white md:rounded-xl shadow-2xl w-full md:max-w-md rounded-t-2xl md:m-4 p-5 md:p-6">
        <h3 id="confirm-title" class="text-lg font-bold text-gray-800 mb-3"></h3>
        <div id="confirm-details" class="text-sm text-gray-600 mb-5 max-h-60 overflow-y-auto"></div>
        <div class="flex gap-3">
            <button id="confirm-cancel" class="flex-1 md:flex-none px-4 py-3 md:py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 active:bg-gray-100">
                Cancelar
            </button>
            <button id="confirm-accept" class="flex-1 md:flex-none px-4 py-3 md:py-2 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 active:bg-yellow-700">
                Si, modificar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var activeTab = 'summary';

    function switchTab(tabName, url) {
        // Update tab styles
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
            if (btn.dataset.tab === tabName) {
                btn.className = 'tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-yellow-400 text-yellow-700 bg-yellow-50';
            } else {
                btn.className = 'tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            }
        });
        activeTab = tabName;

        var content = document.getElementById('tab-content');

        // Show loading
        content.innerHTML = '<div class="flex justify-center py-12"><svg class="animate-spin h-8 w-8 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg></div>';

        // Fetch content
        fetch(url, {headers: {'ngrok-skip-browser-warning': 'true'}})
            .then(function(r) { return r.text(); })
            .then(function(html) {
                if (activeTab === tabName) {
                    content.innerHTML = html;
                    // Execute inline scripts (innerHTML doesn't run them)
                    content.querySelectorAll('script').forEach(function(oldScript) {
                        var newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    // Re-process htmx in loaded content
                    if (window.htmx) htmx.process(content);
                }
            })
            .catch(function(e) {
                content.innerHTML = '<div class="text-center py-8 text-red-500">Error cargando contenido: ' + e.message + '</div>';
            });
    }

    // Bind tab clicks
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var url = btn.dataset.url;
            // Persist inventory tab state
            if (btn.dataset.tab === 'inventory' && window._lastInventoryUrl) {
                url = window._lastInventoryUrl;
            }
            switchTab(btn.dataset.tab, url);
        });
    });

    // Load default tab
    switchTab('summary', '/partials/products-summary');

    // Expose for external use
    window.switchProductTab = switchTab;

    // Stock update function (used by items-grid tab)
    window.updateStock = function(itemId) {
        var input = document.getElementById('new-stock-' + itemId);
        var quantity = parseInt(input.value);
        var msg = document.getElementById('msg-' + itemId);
        var stockDisplay = document.getElementById('stock-display-' + itemId);

        if (isNaN(quantity) || quantity < 0) {
            msg.textContent = 'Cantidad invalida';
            msg.className = 'text-xs mt-1 block text-red-600';
            return;
        }

        msg.textContent = 'Actualizando...';
        msg.className = 'text-xs mt-1 block text-gray-500';

        fetch('/api/items/' + itemId + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: quantity})
        })
        .then(function(r) {
            if (r.ok) {
                msg.textContent = 'Actualizado';
                msg.className = 'text-xs mt-1 block text-green-600';
                if (stockDisplay) stockDisplay.textContent = quantity;
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            msg.textContent = 'Error: ' + e.message;
            msg.className = 'text-xs mt-1 block text-red-600';
        });
    };

    // ── Change FULL to merchant shipping ──
    window.changeToMerchant = function(itemId) {
        if (!confirm('Cambiar de FULL a envio propio?\n\nPerdera beneficios de Fulfillment (envio gratis, mayor exposicion). Solo haga esto si necesita gestionar el stock manualmente.')) {
            return;
        }
        var msg = document.getElementById('msg-' + itemId);
        if (msg) {
            msg.textContent = 'Cambiando logistica...';
            msg.className = 'text-xs mt-1 block text-gray-500';
        }
        fetch('/api/items/' + itemId + '/shipping', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({logistic_type: 'xd_drop_off'})
        })
        .then(function(r) {
            if (r.ok) {
                if (msg) {
                    msg.textContent = 'Cambiado a envio propio. Recargando...';
                    msg.className = 'text-xs mt-1 block text-green-600';
                }
                setTimeout(function() {
                    // Reload current tab
                    var activeBtn = document.querySelector('.tab-btn.bg-yellow-50');
                    if (activeBtn) activeBtn.click();
                }, 1500);
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            if (msg) {
                msg.textContent = 'Error: ' + e.message;
                msg.className = 'text-xs mt-1 block text-red-600';
            }
        });
    };

    // ── Inline stock sync for all product tabs ──

    // Call API to update stock, with inline feedback
    window.inlineStockSync = function(itemId, qty, msgEl, onSuccess) {
        msgEl.textContent = '...';
        msgEl.className = 'text-[10px] text-gray-400 ml-1 inline';
        fetch('/api/items/' + itemId + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: qty})
        })
        .then(function(r) {
            if (r.ok) {
                msgEl.textContent = 'OK';
                msgEl.className = 'text-[10px] text-green-600 ml-1 inline font-semibold';
                setTimeout(function() { msgEl.textContent = ''; }, 2000);
                if (onSuccess) onSuccess(qty);
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            msgEl.textContent = e.message;
            msgEl.className = 'text-[10px] text-red-600 ml-1 inline';
        });
    };

    // Quick sync: set MeLi stock = 60% of BM total (safety stock for other channels)
    window.quickSyncBM = function(btn, itemId, bmTotal) {
        var cell = btn.closest('[data-stock-cell]');
        var msgEl = cell.querySelector('[data-stock-msg]');
        var displayEl = cell.querySelector('[data-stock-val]');
        btn.disabled = true;
        btn.textContent = '...';
        var safeQty = Math.floor(bmTotal * 0.6);
        window.inlineStockSync(itemId, safeQty, msgEl, function(qty) {
            displayEl.textContent = qty;
            displayEl.className = 'cursor-pointer font-semibold hover:text-purple-600 hover:underline ' +
                (qty > 5 ? 'text-green-600' : qty > 0 ? 'text-yellow-600' : 'text-red-600');
            // Hide BM button if stock now matches
            btn.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = 'BM';
        });
    };

    // ── Confirmation modal ──
    var _confirmCallback = null;
    var _modalHadChanges = false;

    window.confirmAction = function(title, detailsHtml, onConfirm) {
        var modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-details').innerHTML = detailsHtml;
        modal.classList.remove('hidden');
        _confirmCallback = onConfirm;
    };

    document.getElementById('confirm-cancel').addEventListener('click', function() {
        document.getElementById('confirm-modal').classList.add('hidden');
        _confirmCallback = null;
    });

    document.getElementById('confirm-accept').addEventListener('click', function() {
        document.getElementById('confirm-modal').classList.add('hidden');
        if (_confirmCallback) {
            _confirmCallback();
            _confirmCallback = null;
        }
    });

    document.getElementById('confirm-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            _confirmCallback = null;
        }
    });

    // ── Edit modal ──
    window.openEditModal = function(itemId) {
        _modalHadChanges = false;
        var modal = document.getElementById('edit-modal');
        var content = document.getElementById('edit-modal-content');
        modal.classList.remove('hidden');
        content.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 mx-auto mb-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Cargando...</div>';

        fetch('/partials/item-edit/' + itemId, {headers: {'ngrok-skip-browser-warning': 'true'}})
            .then(function(r) { return r.text(); })
            .then(function(html) {
                content.innerHTML = html;
                // Execute inline scripts from the partial
                content.querySelectorAll('script').forEach(function(oldScript) {
                    var newScript = document.createElement('script');
                    newScript.textContent = oldScript.textContent;
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            })
            .catch(function() { content.innerHTML = '<p class="text-center text-red-500 py-4">Error cargando item</p>'; });
    };

    window.closeEditModal = function(forceReload) {
        document.getElementById('edit-modal').classList.add('hidden');
        window._onDealChange = null;
        if (forceReload || _modalHadChanges) {
            var activeBtn = document.querySelector('.tab-btn.bg-yellow-50');
            if (activeBtn) activeBtn.click();
        }
    };

    // Close modal on backdrop click
    document.getElementById('edit-modal').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    // Save individual field with confirmation
    window.saveField = function(itemId, endpoint, bodyData, btnId, msgId) {
        var fieldName = endpoint.charAt(0).toUpperCase() + endpoint.slice(1);
        var detailText = '';
        if (bodyData.title) detailText = 'Titulo: ' + bodyData.title;
        else if (bodyData.plain_text) detailText = 'Descripcion: ' + bodyData.plain_text.substring(0, 80) + '...';
        else if (bodyData.status) detailText = 'Estado: ' + bodyData.status;
        else if (bodyData.free_shipping !== undefined) detailText = 'Envio gratis: ' + (bodyData.free_shipping ? 'Si' : 'No');
        else if (bodyData.pictures) detailText = 'Fotos: ' + bodyData.pictures.length + ' imagenes';
        else if (bodyData.attributes) detailText = 'Atributos: ' + bodyData.attributes.length + ' campos';
        else if (bodyData.price !== undefined) detailText = 'Precio: $' + bodyData.price;
        else if (bodyData.quantity !== undefined) detailText = 'Stock: ' + bodyData.quantity;
        else detailText = JSON.stringify(bodyData).substring(0, 100);

        confirmAction(
            'Confirmar cambio',
            '<p class="mb-2">Estas seguro de modificar <strong>' + fieldName + '</strong>?</p>' +
            '<p class="bg-gray-50 p-2 rounded text-xs text-gray-600">' + detailText + '</p>' +
            '<p class="text-gray-400 text-xs mt-1">Item: ' + itemId + '</p>',
            function() {
                var btn = document.getElementById(btnId);
                var msg = document.getElementById(msgId);
                btn.disabled = true;
                btn.textContent = '...';
                msg.textContent = '';

                fetch('/api/items/' + itemId + '/' + endpoint, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                    body: JSON.stringify(bodyData)
                })
                .then(function(r) {
                    if (r.ok) {
                        msg.textContent = 'Guardado';
                        msg.className = 'text-xs text-green-600';
                        btn.textContent = 'Guardar';
                        btn.disabled = false;
                        _modalHadChanges = true;
                    } else {
                        return r.json().then(function(d) { throw new Error(d.detail || 'Error'); });
                    }
                })
                .catch(function(e) {
                    msg.textContent = 'Error: ' + e.message;
                    msg.className = 'text-xs text-red-600';
                    btn.textContent = 'Guardar';
                    btn.disabled = false;
                });
            }
        );
    };

    // Show inline editor replacing stock number
    window.showStockEditor = function(el, itemId, currentStock, bmTotal) {
        var cell = el.closest('[data-stock-cell]');
        var msgEl = cell.querySelector('[data-stock-msg]');
        var displayEl = cell.querySelector('[data-stock-val]');
        var bmBtn = cell.querySelector('[data-bm-btn]');

        // Hide display, show input
        var prefill = (bmTotal > 0 && bmTotal !== currentStock) ? bmTotal : currentStock;
        displayEl.style.display = 'none';
        if (bmBtn) bmBtn.style.display = 'none';

        var wrap = document.createElement('span');
        wrap.className = 'inline-flex items-center gap-1';
        wrap.setAttribute('data-editor', '');
        wrap.innerHTML = '<input type="number" min="0" value="' + prefill + '" ' +
            'class="w-14 px-1 py-0.5 border rounded text-xs text-right focus:ring-1 focus:ring-purple-400 focus:outline-none">' +
            '<button class="text-green-600 hover:text-green-800 text-sm font-bold leading-none" title="Guardar">&#10003;</button>' +
            '<button class="text-gray-400 hover:text-red-500 text-sm font-bold leading-none" title="Cancelar">&#10007;</button>';
        cell.insertBefore(wrap, msgEl);

        var inp = wrap.querySelector('input');
        var okBtn = wrap.querySelectorAll('button')[0];
        var cancelBtn = wrap.querySelectorAll('button')[1];
        inp.focus();
        inp.select();

        function closeEditor() {
            wrap.remove();
            displayEl.style.display = '';
            if (bmBtn) bmBtn.style.display = '';
        }

        cancelBtn.onclick = closeEditor;
        okBtn.onclick = function() {
            var val = parseInt(inp.value);
            if (isNaN(val) || val < 0) { inp.classList.add('border-red-400'); return; }
            closeEditor();
            window.inlineStockSync(itemId, val, msgEl, function(qty) {
                displayEl.textContent = qty;
                displayEl.className = 'cursor-pointer font-semibold hover:text-purple-600 hover:underline ' +
                    (qty > 5 ? 'text-green-600' : qty > 0 ? 'text-yellow-600' : 'text-red-600');
                // Update BM button visibility
                if (bmBtn) {
                    if (bmTotal > 0 && bmTotal !== qty) { bmBtn.classList.remove('hidden'); }
                    else { bmBtn.classList.add('hidden'); }
                }
            });
        };
        inp.onkeydown = function(e) {
            if (e.key === 'Enter') okBtn.onclick();
            if (e.key === 'Escape') closeEditor();
        };
    };
})();
</script>
{% endblock %}

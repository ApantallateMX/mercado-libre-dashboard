{% extends "base.html" %}

{% block title %}Centro de Productos{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">Centro de Productos</h1>
        <p class="text-gray-600">Inteligencia y optimizacion para alcanzar la meta de $500k/dia</p>
    </div>
</div>

<!-- Tabs -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="flex border-b overflow-x-auto" id="product-tabs">
        <button data-tab="summary" data-url="/partials/products-summary"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-yellow-400 text-yellow-700 bg-yellow-50">
            Resumen
        </button>
        <button data-tab="all" data-url="/partials/products-all"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Todos
        </button>
        <button data-tab="top" data-url="/partials/products-top-sellers"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Top Ventas
        </button>
        <button data-tab="stock" data-url="/partials/products-high-stock"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Mayor Stock
        </button>
        <button data-tab="low" data-url="/partials/products-low-sellers"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Baja Venta
        </button>
        <button data-tab="full" data-url="/partials/products-full"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            FULL
        </button>
        <button data-tab="deals" data-url="/partials/products-deals"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Deals
        </button>
        <button data-tab="unpublished" data-url="/partials/products-not-published"
                class="tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Sin Publicar
        </button>
    </div>
</div>

<!-- Tab content -->
<div id="tab-content">
    <!-- Default: skeleton loading -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for i in range(4) %}
        <div class="bg-white rounded-lg shadow p-6 animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
            <div class="h-8 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-3 bg-gray-200 rounded w-1/3"></div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var tabCache = {};
    var activeTab = 'summary';

    function switchTab(tabName, url) {
        // Update tab styles
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
            if (btn.dataset.tab === tabName) {
                btn.className = 'tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-yellow-400 text-yellow-700 bg-yellow-50';
            } else {
                btn.className = 'tab-btn px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            }
        });
        activeTab = tabName;

        var content = document.getElementById('tab-content');

        // Show loading
        content.innerHTML = '<div class="flex justify-center py-12"><svg class="animate-spin h-8 w-8 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg></div>';

        // Fetch content
        fetch(url, {headers: {'ngrok-skip-browser-warning': 'true'}})
            .then(function(r) { return r.text(); })
            .then(function(html) {
                if (activeTab === tabName) {
                    content.innerHTML = html;
                    // Execute inline scripts (innerHTML doesn't run them)
                    content.querySelectorAll('script').forEach(function(oldScript) {
                        var newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    // Re-process htmx in loaded content
                    if (window.htmx) htmx.process(content);
                }
            })
            .catch(function(e) {
                content.innerHTML = '<div class="text-center py-8 text-red-500">Error cargando contenido: ' + e.message + '</div>';
            });
    }

    // Bind tab clicks
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            switchTab(btn.dataset.tab, btn.dataset.url);
        });
    });

    // Load default tab
    switchTab('summary', '/partials/products-summary');

    // Expose for external use (e.g. "Sin stock con ventas" button)
    window.switchProductTab = switchTab;

    // Stock update function (used by items-grid tab)
    window.updateStock = function(itemId) {
        var input = document.getElementById('new-stock-' + itemId);
        var quantity = parseInt(input.value);
        var msg = document.getElementById('msg-' + itemId);
        var stockDisplay = document.getElementById('stock-display-' + itemId);

        if (isNaN(quantity) || quantity < 0) {
            msg.textContent = 'Cantidad invalida';
            msg.className = 'text-xs mt-1 block text-red-600';
            return;
        }

        msg.textContent = 'Actualizando...';
        msg.className = 'text-xs mt-1 block text-gray-500';

        fetch('/api/items/' + itemId + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: quantity})
        })
        .then(function(r) {
            if (r.ok) {
                msg.textContent = 'Actualizado';
                msg.className = 'text-xs mt-1 block text-green-600';
                if (stockDisplay) stockDisplay.textContent = quantity;
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            msg.textContent = 'Error: ' + e.message;
            msg.className = 'text-xs mt-1 block text-red-600';
        });
    };

    // ── Change FULL to merchant shipping ──
    window.changeToMerchant = function(itemId) {
        if (!confirm('Cambiar de FULL a envio propio?\n\nPerdera beneficios de Fulfillment (envio gratis, mayor exposicion). Solo haga esto si necesita gestionar el stock manualmente.')) {
            return;
        }
        var msg = document.getElementById('msg-' + itemId);
        if (msg) {
            msg.textContent = 'Cambiando logistica...';
            msg.className = 'text-xs mt-1 block text-gray-500';
        }
        fetch('/api/items/' + itemId + '/shipping', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({logistic_type: 'xd_drop_off'})
        })
        .then(function(r) {
            if (r.ok) {
                if (msg) {
                    msg.textContent = 'Cambiado a envio propio. Recargando...';
                    msg.className = 'text-xs mt-1 block text-green-600';
                }
                setTimeout(function() {
                    // Reload current tab
                    var activeBtn = document.querySelector('.tab-btn.bg-yellow-50');
                    if (activeBtn) activeBtn.click();
                }, 1500);
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            if (msg) {
                msg.textContent = 'Error: ' + e.message;
                msg.className = 'text-xs mt-1 block text-red-600';
            }
        });
    };

    // ── Inline stock sync for all product tabs ──

    // Call API to update stock, with inline feedback
    window.inlineStockSync = function(itemId, qty, msgEl, onSuccess) {
        msgEl.textContent = '...';
        msgEl.className = 'text-[10px] text-gray-400 ml-1 inline';
        fetch('/api/items/' + itemId + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: qty})
        })
        .then(function(r) {
            if (r.ok) {
                msgEl.textContent = 'OK';
                msgEl.className = 'text-[10px] text-green-600 ml-1 inline font-semibold';
                setTimeout(function() { msgEl.textContent = ''; }, 2000);
                if (onSuccess) onSuccess(qty);
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            msgEl.textContent = e.message;
            msgEl.className = 'text-[10px] text-red-600 ml-1 inline';
        });
    };

    // Quick sync: set MeLi stock = BM total in one click
    window.quickSyncBM = function(btn, itemId, bmTotal) {
        var cell = btn.closest('[data-stock-cell]');
        var msgEl = cell.querySelector('[data-stock-msg]');
        var displayEl = cell.querySelector('[data-stock-val]');
        btn.disabled = true;
        btn.textContent = '...';
        window.inlineStockSync(itemId, bmTotal, msgEl, function(qty) {
            displayEl.textContent = qty;
            displayEl.className = 'cursor-pointer font-semibold hover:text-purple-600 hover:underline ' +
                (qty > 5 ? 'text-green-600' : qty > 0 ? 'text-yellow-600' : 'text-red-600');
            // Hide BM button if stock now matches
            btn.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = 'BM';
        });
    };

    // Show inline editor replacing stock number
    window.showStockEditor = function(el, itemId, currentStock, bmTotal) {
        var cell = el.closest('[data-stock-cell]');
        var msgEl = cell.querySelector('[data-stock-msg]');
        var displayEl = cell.querySelector('[data-stock-val]');
        var bmBtn = cell.querySelector('[data-bm-btn]');

        // Hide display, show input
        var prefill = (bmTotal > 0 && bmTotal !== currentStock) ? bmTotal : currentStock;
        displayEl.style.display = 'none';
        if (bmBtn) bmBtn.style.display = 'none';

        var wrap = document.createElement('span');
        wrap.className = 'inline-flex items-center gap-1';
        wrap.setAttribute('data-editor', '');
        wrap.innerHTML = '<input type="number" min="0" value="' + prefill + '" ' +
            'class="w-14 px-1 py-0.5 border rounded text-xs text-right focus:ring-1 focus:ring-purple-400 focus:outline-none">' +
            '<button class="text-green-600 hover:text-green-800 text-sm font-bold leading-none" title="Guardar">&#10003;</button>' +
            '<button class="text-gray-400 hover:text-red-500 text-sm font-bold leading-none" title="Cancelar">&#10007;</button>';
        cell.insertBefore(wrap, msgEl);

        var inp = wrap.querySelector('input');
        var okBtn = wrap.querySelectorAll('button')[0];
        var cancelBtn = wrap.querySelectorAll('button')[1];
        inp.focus();
        inp.select();

        function closeEditor() {
            wrap.remove();
            displayEl.style.display = '';
            if (bmBtn) bmBtn.style.display = '';
        }

        cancelBtn.onclick = closeEditor;
        okBtn.onclick = function() {
            var val = parseInt(inp.value);
            if (isNaN(val) || val < 0) { inp.classList.add('border-red-400'); return; }
            closeEditor();
            window.inlineStockSync(itemId, val, msgEl, function(qty) {
                displayEl.textContent = qty;
                displayEl.className = 'cursor-pointer font-semibold hover:text-purple-600 hover:underline ' +
                    (qty > 5 ? 'text-green-600' : qty > 0 ? 'text-yellow-600' : 'text-red-600');
                // Update BM button visibility
                if (bmBtn) {
                    if (bmTotal > 0 && bmTotal !== qty) { bmBtn.classList.remove('hidden'); }
                    else { bmBtn.classList.add('hidden'); }
                }
            });
        };
        inp.onkeydown = function(e) {
            if (e.key === 'Enter') okBtn.onclick();
            if (e.key === 'Escape') closeEditor();
        };
    };
})();
</script>
{% endblock %}

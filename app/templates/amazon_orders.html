{% extends "base.html" %}
{% block title %}Ventas Amazon{% endblock %}

{% block content %}

{% if not amazon_accounts %}
<!-- Sin cuenta conectada -->
<div class="flex flex-col items-center justify-center py-20 text-center">
    <div class="w-20 h-20 rounded-full bg-orange-100 flex items-center justify-center mb-4">
        <span class="text-3xl font-black text-[#FF9900]">AMZ</span>
    </div>
    <h2 class="text-xl font-bold text-gray-700 mb-2">Sin cuenta Amazon conectada</h2>
    <p class="text-gray-400 text-sm mb-5">Conecta tu cuenta para ver el historial de órdenes</p>
    <a href="/auth/amazon/connect"
       class="bg-[#FF9900] text-white font-semibold px-6 py-3 rounded-xl hover:bg-orange-600 transition text-sm">
        Conectar Amazon
    </a>
</div>

{% else %}

<!-- ─── FILTROS DE FECHA ──────────────────────────────────────────────────── -->
<div class="bg-white rounded-xl shadow px-4 py-3 mb-5 flex flex-wrap gap-3 items-center">

    <!-- Presets rápidos -->
    <div class="flex gap-2 flex-wrap">
        <button onclick="setDatePreset(7)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="7">
            7 días
        </button>
        <button onclick="setDatePreset(15)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="15">
            15 días
        </button>
        <button onclick="setDatePreset(30)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="30">
            30 días
        </button>
        <button onclick="setDatePreset(60)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="60">
            60 días
        </button>
    </div>

    <div class="h-4 w-px bg-gray-200 hidden md:block"></div>

    <!-- Rango custom -->
    <div class="flex items-center gap-2 flex-wrap">
        <label class="text-xs text-gray-500">Desde:</label>
        <input type="date" id="amz-date-from"
               class="border border-gray-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-[#FF9900]">
        <label class="text-xs text-gray-500">Hasta:</label>
        <input type="date" id="amz-date-to"
               class="border border-gray-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-[#FF9900]">
        <button onclick="loadOrders()"
                class="bg-[#FF9900] text-white text-xs font-semibold px-3 py-1.5 rounded-lg hover:bg-orange-600 transition">
            Buscar
        </button>
    </div>

    <!-- Indicador de refresh -->
    <div class="ml-auto flex items-center gap-2">
        <span id="orders-status" class="text-xs text-gray-400"></span>
        <button onclick="loadOrders(true)"
                class="text-xs text-gray-400 hover:text-[#FF9900] transition"
                title="Actualizar">↻</button>
    </div>
</div>

<!-- ─── CONTENEDOR HTMX ───────────────────────────────────────────────────── -->
<div id="amz-orders-container">
    <!-- Skeleton mientras carga -->
    <div id="amz-orders-skeleton">
        <!-- Stats skeleton -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            {% for i in range(4) %}
            <div class="bg-white rounded-xl shadow p-4 animate-pulse">
                <div class="h-2 bg-gray-200 rounded w-1/2 mb-3"></div>
                <div class="h-7 bg-orange-100 rounded w-3/4 mb-2"></div>
                <div class="h-2 bg-gray-100 rounded w-1/3"></div>
            </div>
            {% endfor %}
        </div>
        <!-- Table skeleton -->
        <div class="bg-white rounded-xl shadow overflow-hidden animate-pulse">
            <div class="h-10 bg-gray-800 opacity-80"></div>
            {% for i in range(8) %}
            <div class="h-12 border-b border-gray-100 px-4 flex items-center gap-4">
                <div class="h-3 bg-gray-200 rounded w-24"></div>
                <div class="h-3 bg-gray-200 rounded w-40"></div>
                <div class="h-3 bg-orange-100 rounded w-12"></div>
                <div class="h-3 bg-gray-100 rounded w-8"></div>
                <div class="h-3 bg-green-100 rounded w-16"></div>
                <div class="h-3 bg-gray-100 rounded w-14"></div>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Contenido real (insertado via JS) -->
    <div id="amz-orders-content" class="hidden"></div>
</div>

{% endif %}

<script>
(function () {
    // ── Helpers de fecha ──────────────────────────────────────────────────────
    function todayMX() {
        // México CST = UTC-6
        const now = new Date();
        const mx  = new Date(now.getTime() - 6 * 60 * 60 * 1000);
        return mx.toISOString().slice(0, 10);
    }

    function subtractDays(dateStr, days) {
        const d = new Date(dateStr + 'T12:00:00Z');
        d.setDate(d.getDate() - days);
        return d.toISOString().slice(0, 10);
    }

    // ── Inicializar inputs con valores por defecto (7 días) ───────────────────
    const today = todayMX();
    const fromEl = document.getElementById('amz-date-from');
    const toEl   = document.getElementById('amz-date-to');
    if (fromEl && toEl) {
        toEl.value   = today;
        fromEl.value = subtractDays(today, 6);  // 7 días inclusive
    }

    // Resaltar preset activo
    function markActivePreset(days) {
        document.querySelectorAll('.preset-btn').forEach(btn => {
            const isActive = parseInt(btn.dataset.days) === days;
            btn.classList.toggle('bg-orange-50',     isActive);
            btn.classList.toggle('border-[#FF9900]', isActive);
            btn.classList.toggle('text-orange-700',  isActive);
        });
    }
    markActivePreset(7);

    // ── setDatePreset ─────────────────────────────────────────────────────────
    window.setDatePreset = function (days) {
        if (!fromEl || !toEl) return;
        toEl.value   = today;
        fromEl.value = subtractDays(today, days - 1);
        markActivePreset(days);
        loadOrders();
    };

    // ── Toggle expand de items ────────────────────────────────────────────────
    // NOTA: definido aquí (no en el partial) porque innerHTML no ejecuta scripts
    window.toggleOrderItems = async function (orderId) {
        const expandRow = document.getElementById('expand-' + orderId);
        const btn       = document.getElementById('btn-'    + orderId);
        if (!expandRow || !btn) return;

        if (expandRow.dataset.loaded === 'true') {
            const hidden = expandRow.classList.contains('hidden');
            expandRow.classList.toggle('hidden', !hidden);
            btn.textContent = hidden ? '▲' : '▼';
            return;
        }

        btn.textContent = '⏳';
        btn.disabled    = true;

        try {
            const params = new URLSearchParams({
                amount:   btn.dataset.amount   || '0',
                status:   btn.dataset.status   || '',
                canal:    btn.dataset.canal    || '',
                date:     btn.dataset.date     || '',
                units:    btn.dataset.units    || '0',
                currency: btn.dataset.currency || 'MXN',
            });
            const resp = await fetch('/api/amazon/orders/' + orderId + '/items?' + params);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const html = await resp.text();

            const td = expandRow.querySelector('td');
            if (td) td.innerHTML = html;

            expandRow.dataset.loaded = 'true';
            expandRow.classList.remove('hidden');
            btn.textContent = '▲';
            btn.disabled    = false;
            expandRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (e) {
            btn.textContent = '✕';
            btn.disabled    = false;
            console.error('[Amazon] items error:', e);
        }
    };

    // ── Paginación ────────────────────────────────────────────────────────────
    const _PER_PAGE = 20;
    let _curPage    = 1;
    let _viewAll    = false;

    function _getAllOrderRows() {
        return Array.from(document.querySelectorAll('#amz-orders-tbody tr[id^="order-row-"]'));
    }

    function _applyPage(page) {
        const rows = _getAllOrderRows();
        if (!rows.length) return;

        const total      = rows.length;
        const totalPages = Math.ceil(total / _PER_PAGE);
        _curPage = Math.max(1, Math.min(page, totalPages));

        if (_viewAll) {
            rows.forEach(r => r.classList.remove('hidden'));
        } else {
            const start = (_curPage - 1) * _PER_PAGE;
            const end   = start + _PER_PAGE;
            rows.forEach((r, i) => {
                const visible = i >= start && i < end;
                r.classList.toggle('hidden', !visible);
                // Si la fila se oculta, ocultar también su expand row
                if (!visible) {
                    const orderId   = r.id.replace('order-row-', '');
                    const expandRow = document.getElementById('expand-' + orderId);
                    if (expandRow) expandRow.classList.add('hidden');
                }
            });
        }

        _renderPagination(total, _curPage, totalPages);
        _enrichVisibleRows();
    }

    function _renderPagination(total, page, totalPages) {
        const container = document.getElementById('orders-pagination');
        if (!container) return;

        // Sin paginación si caben todas en una página
        if (total <= _PER_PAGE && !_viewAll) {
            container.innerHTML = '';
            return;
        }

        const start = _viewAll ? 1 : (page - 1) * _PER_PAGE + 1;
        const end   = _viewAll ? total : Math.min(page * _PER_PAGE, total);

        // Botones de página con ellipsis
        let pageBtns = '';
        if (!_viewAll) {
            let lastRendered = 0;
            for (let p = 1; p <= totalPages; p++) {
                const near = p >= page - 2 && p <= page + 2;
                const edge = p === 1 || p === totalPages;
                if (!near && !edge) continue;

                if (lastRendered && p - lastRendered > 1) {
                    pageBtns += `<span class="px-1 text-gray-300 select-none">…</span>`;
                }
                lastRendered = p;

                const active = p === page;
                pageBtns += `
                <button onclick="window._paginateOrders(${p})"
                        class="min-w-[32px] h-8 px-2 rounded-lg text-xs font-semibold border transition
                               ${active
                                   ? 'bg-[#FF9900] text-white border-[#FF9900] cursor-default'
                                   : 'border-gray-200 text-gray-600 hover:border-[#FF9900] hover:text-orange-700'}">
                    ${p}
                </button>`;
            }
        }

        container.innerHTML = `
        <div class="px-4 py-3 border-t border-gray-100 bg-white flex flex-wrap items-center justify-between gap-3">
            <span class="text-xs text-gray-400">
                Mostrando <strong class="text-gray-600">${start}–${end}</strong> de
                <strong class="text-gray-600">${total}</strong> órdenes
            </span>
            <div class="flex items-center gap-1 flex-wrap">
                ${!_viewAll ? `
                <button onclick="window._paginateOrders(${page - 1})"
                        ${page <= 1 ? 'disabled' : ''}
                        class="h-8 px-3 rounded-lg text-xs font-semibold border border-gray-200
                               text-gray-600 hover:border-[#FF9900] hover:text-orange-700
                               disabled:opacity-30 disabled:cursor-not-allowed transition">
                    ‹ Ant
                </button>
                ${pageBtns}
                <button onclick="window._paginateOrders(${page + 1})"
                        ${page >= totalPages ? 'disabled' : ''}
                        class="h-8 px-3 rounded-lg text-xs font-semibold border border-gray-200
                               text-gray-600 hover:border-[#FF9900] hover:text-orange-700
                               disabled:opacity-30 disabled:cursor-not-allowed transition">
                    Sig ›
                </button>` : ''}
                <button onclick="window._paginateOrders(0, true)"
                        class="h-8 px-3 rounded-lg text-xs font-semibold border transition ml-1
                               ${_viewAll
                                   ? 'border-orange-300 bg-orange-50 text-orange-700 hover:bg-white'
                                   : 'border-gray-200 text-gray-500 hover:border-[#FF9900] hover:text-orange-700'}">
                    ${_viewAll ? '← Paginar' : 'Ver todos'}
                </button>
            </div>
        </div>`;
    }

    window._paginateOrders = function(page, toggleViewAll) {
        if (toggleViewAll !== undefined) {
            _viewAll = !_viewAll;
            _curPage = 1;
            _applyPage(1);
        } else {
            _applyPage(page);
        }
    };

    function _initPagination() {
        _curPage = 1;
        _viewAll = false;
        _applyPage(1);
    }

    // ── Lazy load Producto + SKU ──────────────────────────────────────────────
    let _preview_loaded = new Set();

    async function _fetchPreview(orderId) {
        if (_preview_loaded.has(orderId)) return;
        _preview_loaded.add(orderId);

        const prodCell = document.getElementById('prod-' + orderId);
        const skuCell  = document.getElementById('sku-'  + orderId);
        if (!prodCell || !skuCell) return;

        try {
            const resp = await fetch('/api/amazon/orders/' + orderId + '/preview');
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const d = await resp.json();

            // Producto
            if (d.title && d.title !== '—') {
                const extra = d.items_count > 1
                    ? ` <span class="text-gray-400">(+${d.items_count - 1} más)</span>` : '';
                prodCell.innerHTML =
                    `<span class="text-gray-800 text-xs leading-snug block truncate max-w-[200px]"
                           title="${d.title}">${d.title}</span>${extra}`;
            } else {
                prodCell.innerHTML = '<span class="text-gray-400 text-xs">—</span>';
            }

            // SKU
            skuCell.innerHTML = d.sku !== '—'
                ? `<span class="font-mono text-xs font-semibold text-[#146EB4]">${d.sku}</span>`
                : '<span class="text-gray-400 text-xs">—</span>';

            // Precio: si la orden es Pending y el total en tabla es "—", rellenar con items_total
            const amtCell = document.getElementById('amt-' + orderId);
            if (amtCell && amtCell.dataset.pending === 'true' && amtCell.textContent.trim() === '—') {
                if (d.items_total && d.items_total > 0) {
                    const fmt = '$' + d.items_total.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    amtCell.classList.remove('text-gray-400');
                    amtCell.classList.add('text-amber-600');
                    amtCell.innerHTML = `<span title="Precio estimado de items — pendiente de pago">~${fmt}</span>`;
                }
            }

        } catch (e) {
            prodCell.innerHTML = '<span class="text-gray-400 text-xs">—</span>';
        }
    }

    async function _enrichVisibleRows() {
        // Solo filas VISIBLES (no hidden) — máx 15 por llamada (Amazon burst = 30 req)
        const rows = _getAllOrderRows()
            .filter(r => !r.classList.contains('hidden'))
            .slice(0, 15);
        const BATCH = 3;
        const DELAY = 800;

        for (let i = 0; i < rows.length; i += BATCH) {
            const batch = rows.slice(i, i + BATCH);
            const ids   = batch.map(r => r.id.replace('order-row-', ''));
            await Promise.all(ids.map(_fetchPreview));
            if (i + BATCH < rows.length) {
                await new Promise(r => setTimeout(r, DELAY));
            }
        }
    }

    // ── loadOrders ────────────────────────────────────────────────────────────
    window.loadOrders = async function (forceRefresh) {
        if (!fromEl || !toEl) return;
        const dateFrom = fromEl.value;
        const dateTo   = toEl.value;

        const statusEl  = document.getElementById('orders-status');
        const skeleton  = document.getElementById('amz-orders-skeleton');
        const content   = document.getElementById('amz-orders-content');
        if (!skeleton || !content) return;

        // Resetear caché de previews al cargar nuevo rango
        _preview_loaded = new Set();

        // Mostrar skeleton
        skeleton.classList.remove('hidden');
        content.classList.add('hidden');
        if (statusEl) statusEl.textContent = 'Cargando…';

        try {
            const url = '/api/amazon/orders?date_from=' + dateFrom + '&date_to=' + dateTo
                      + (forceRefresh ? '&_t=' + Date.now() : '');
            const resp = await fetch(url);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const html = await resp.text();

            content.innerHTML = html;
            content.classList.remove('hidden');
            skeleton.classList.add('hidden');
            if (statusEl) statusEl.textContent = 'Actualizado ' + new Date().toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});

            // Iniciar paginación (muestra pág 1, oculta el resto, enriquece filas visibles)
            _initPagination();
        } catch (e) {
            skeleton.classList.add('hidden');
            content.innerHTML = '<p class="text-red-500 p-6 text-center">Error al cargar órdenes: ' + e.message + '</p>';
            content.classList.remove('hidden');
            if (statusEl) statusEl.textContent = 'Error';
            console.error('[Amazon Orders] loadOrders error:', e);
        }
    };

    // ── Carga inicial ─────────────────────────────────────────────────────────
    {% if amazon_accounts %}
    loadOrders();
    {% endif %}
})();
</script>

{% endblock %}

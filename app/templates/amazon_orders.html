{% extends "base.html" %}
{% block title %}Ventas Amazon{% endblock %}

{% block content %}

{% if not amazon_accounts %}
<!-- Sin cuenta conectada -->
<div class="flex flex-col items-center justify-center py-20 text-center">
    <div class="w-20 h-20 rounded-full bg-orange-100 flex items-center justify-center mb-4">
        <span class="text-3xl font-black text-[#FF9900]">AMZ</span>
    </div>
    <h2 class="text-xl font-bold text-gray-700 mb-2">Sin cuenta Amazon conectada</h2>
    <p class="text-gray-400 text-sm mb-5">Conecta tu cuenta para ver el historial de órdenes</p>
    <a href="/auth/amazon/connect"
       class="bg-[#FF9900] text-white font-semibold px-6 py-3 rounded-xl hover:bg-orange-600 transition text-sm">
        Conectar Amazon
    </a>
</div>

{% else %}

<!-- ─── FILTROS DE FECHA ──────────────────────────────────────────────────── -->
<div class="bg-white rounded-xl shadow px-4 py-3 mb-5 flex flex-wrap gap-3 items-center">

    <!-- Presets rápidos -->
    <div class="flex gap-2 flex-wrap">
        <button onclick="setDatePreset(7)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="7">
            7 días
        </button>
        <button onclick="setDatePreset(15)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="15">
            15 días
        </button>
        <button onclick="setDatePreset(30)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="30">
            30 días
        </button>
        <button onclick="setDatePreset(60)"
                class="preset-btn text-xs font-medium px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-[#FF9900] hover:text-orange-700 transition"
                data-days="60">
            60 días
        </button>
    </div>

    <div class="h-4 w-px bg-gray-200 hidden md:block"></div>

    <!-- Rango custom -->
    <div class="flex items-center gap-2 flex-wrap">
        <label class="text-xs text-gray-500">Desde:</label>
        <input type="date" id="amz-date-from"
               class="border border-gray-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-[#FF9900]">
        <label class="text-xs text-gray-500">Hasta:</label>
        <input type="date" id="amz-date-to"
               class="border border-gray-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-[#FF9900]">
        <button onclick="loadOrders()"
                class="bg-[#FF9900] text-white text-xs font-semibold px-3 py-1.5 rounded-lg hover:bg-orange-600 transition">
            Buscar
        </button>
    </div>

    <!-- Indicador de refresh -->
    <div class="ml-auto flex items-center gap-2">
        <span id="orders-status" class="text-xs text-gray-400"></span>
        <button onclick="loadOrders(true)"
                class="text-xs text-gray-400 hover:text-[#FF9900] transition"
                title="Actualizar">↻</button>
    </div>
</div>

<!-- ─── CONTENEDOR HTMX ───────────────────────────────────────────────────── -->
<div id="amz-orders-container">
    <!-- Skeleton mientras carga -->
    <div id="amz-orders-skeleton">
        <!-- Stats skeleton -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            {% for i in range(4) %}
            <div class="bg-white rounded-xl shadow p-4 animate-pulse">
                <div class="h-2 bg-gray-200 rounded w-1/2 mb-3"></div>
                <div class="h-7 bg-orange-100 rounded w-3/4 mb-2"></div>
                <div class="h-2 bg-gray-100 rounded w-1/3"></div>
            </div>
            {% endfor %}
        </div>
        <!-- Table skeleton -->
        <div class="bg-white rounded-xl shadow overflow-hidden animate-pulse">
            <div class="h-10 bg-gray-800 opacity-80"></div>
            {% for i in range(8) %}
            <div class="h-12 border-b border-gray-100 px-4 flex items-center gap-4">
                <div class="h-3 bg-gray-200 rounded w-24"></div>
                <div class="h-3 bg-gray-200 rounded w-40"></div>
                <div class="h-3 bg-orange-100 rounded w-12"></div>
                <div class="h-3 bg-gray-100 rounded w-8"></div>
                <div class="h-3 bg-green-100 rounded w-16"></div>
                <div class="h-3 bg-gray-100 rounded w-14"></div>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Contenido real (insertado via JS) -->
    <div id="amz-orders-content" class="hidden"></div>
</div>

{% endif %}

<script>
(function () {
    // ── Helpers de fecha ──────────────────────────────────────────────────────
    function todayMX() {
        // México CST = UTC-6
        const now = new Date();
        const mx  = new Date(now.getTime() - 6 * 60 * 60 * 1000);
        return mx.toISOString().slice(0, 10);
    }

    function subtractDays(dateStr, days) {
        const d = new Date(dateStr + 'T12:00:00Z');
        d.setDate(d.getDate() - days);
        return d.toISOString().slice(0, 10);
    }

    // ── Inicializar inputs con valores por defecto (7 días) ───────────────────
    const today = todayMX();
    const fromEl = document.getElementById('amz-date-from');
    const toEl   = document.getElementById('amz-date-to');
    if (fromEl && toEl) {
        toEl.value   = today;
        fromEl.value = subtractDays(today, 6);  // 7 días inclusive
    }

    // Resaltar preset activo
    function markActivePreset(days) {
        document.querySelectorAll('.preset-btn').forEach(btn => {
            const isActive = parseInt(btn.dataset.days) === days;
            btn.classList.toggle('bg-orange-50',     isActive);
            btn.classList.toggle('border-[#FF9900]', isActive);
            btn.classList.toggle('text-orange-700',  isActive);
        });
    }
    markActivePreset(7);

    // ── setDatePreset ─────────────────────────────────────────────────────────
    window.setDatePreset = function (days) {
        if (!fromEl || !toEl) return;
        toEl.value   = today;
        fromEl.value = subtractDays(today, days - 1);
        markActivePreset(days);
        loadOrders();
    };

    // ── loadOrders ────────────────────────────────────────────────────────────
    window.loadOrders = async function (forceRefresh) {
        if (!fromEl || !toEl) return;
        const dateFrom = fromEl.value;
        const dateTo   = toEl.value;

        const statusEl  = document.getElementById('orders-status');
        const skeleton  = document.getElementById('amz-orders-skeleton');
        const content   = document.getElementById('amz-orders-content');
        if (!skeleton || !content) return;

        // Mostrar skeleton
        skeleton.classList.remove('hidden');
        content.classList.add('hidden');
        if (statusEl) statusEl.textContent = 'Cargando…';

        try {
            const url = '/api/amazon/orders?date_from=' + dateFrom + '&date_to=' + dateTo
                      + (forceRefresh ? '&_t=' + Date.now() : '');
            const resp = await fetch(url);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const html = await resp.text();

            content.innerHTML = html;
            content.classList.remove('hidden');
            skeleton.classList.add('hidden');
            if (statusEl) statusEl.textContent = 'Actualizado ' + new Date().toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
        } catch (e) {
            skeleton.classList.add('hidden');
            content.innerHTML = '<p class="text-red-500 p-6 text-center">Error al cargar órdenes: ' + e.message + '</p>';
            content.classList.remove('hidden');
            if (statusEl) statusEl.textContent = 'Error';
            console.error('[Amazon Orders] loadOrders error:', e);
        }
    };

    // ── Carga inicial ─────────────────────────────────────────────────────────
    {% if amazon_accounts %}
    loadOrders();
    {% endif %}
})();
</script>

{% endblock %}

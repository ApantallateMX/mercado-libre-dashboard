{% extends "base.html" %}
{% block title %}Centro de Productos Amazon{% endblock %}

{% block content %}

{% if not amazon_accounts %}
<!-- Sin cuenta conectada -->
<div class="flex flex-col items-center justify-center py-20 text-center">
    <div class="w-20 h-20 rounded-full bg-orange-100 flex items-center justify-center mb-4">
        <span class="text-3xl font-black text-[#FF9900]">AMZ</span>
    </div>
    <h2 class="text-xl font-bold text-gray-700 mb-2">Sin cuenta Amazon conectada</h2>
    <p class="text-gray-400 text-sm mb-5">Conecta tu cuenta para ver el catÃ¡logo de productos</p>
    <a href="/auth/amazon/connect" class="bg-[#FF9900] text-white font-semibold px-6 py-3 rounded-xl hover:bg-orange-600 transition text-sm">
        Conectar Amazon
    </a>
</div>

{% else %}

<!-- â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bg-white rounded-xl shadow mb-5 overflow-hidden">
    <div class="flex border-b border-gray-100 overflow-x-auto" id="amz-prod-tabs">

        <button data-tab="resumen" data-url="/api/amazon/products/resumen"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-[#FF9900] text-orange-700 bg-orange-50">
            ğŸ“Š Resumen
        </button>

        <button data-tab="inventario" data-url="/api/amazon/products/inventario"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            ğŸ“¦ Inventario
        </button>

        <button data-tab="stock" data-url="/api/amazon/products/stock"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            âš ï¸ Stock
        </button>

        <button data-tab="sin-publicar" data-url="/api/amazon/products/sin-publicar"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            ğŸš« Sin Publicar
        </button>

    </div>
</div>

<!-- â”€â”€â”€ CONTENEDOR DEL TAB ACTIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="amz-prod-tab-content">
    <!-- Skeleton inicial -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% for i in range(4) %}
        <div class="bg-white p-5 rounded-xl shadow animate-pulse">
            <div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>
            <div class="h-7 bg-orange-100 rounded w-3/4 mb-2"></div>
            <div class="h-3 bg-gray-100 rounded w-1/3"></div>
        </div>
        {% endfor %}
    </div>
</div>

{% endif %}

{% endblock %}

{% block scripts %}
{% if amazon_accounts %}
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Centro de Productos Amazon v2 â€” navegaciÃ³n entre tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var _amzProdActiveTab = null;

function loadAmzProdTab(tabName, url, btn) {
    if (_amzProdActiveTab === tabName) return;
    _amzProdActiveTab = tabName;

    // Resaltar tab activo
    document.querySelectorAll('.amz-prod-tab').forEach(function(b) {
        b.classList.remove('border-[#FF9900]', 'text-orange-700', 'bg-orange-50');
        b.classList.add('border-transparent', 'text-gray-500');
    });
    if (btn) {
        btn.classList.add('border-[#FF9900]', 'text-orange-700', 'bg-orange-50');
        btn.classList.remove('border-transparent', 'text-gray-500');
    }

    // Skeleton mientras carga
    var container = document.getElementById('amz-prod-tab-content');
    container.innerHTML =
        '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">' +
        Array(4).fill(
            '<div class="bg-white p-5 rounded-xl shadow animate-pulse">' +
            '<div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>' +
            '<div class="h-7 bg-orange-100 rounded w-3/4 mb-2"></div>' +
            '<div class="h-3 bg-gray-100 rounded w-1/3"></div></div>'
        ).join('') + '</div>';

    fetch(url)
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.text();
        })
        .then(function(html) {
            container.innerHTML = html;
        })
        .catch(function(e) {
            container.innerHTML =
                '<div class="bg-white rounded-xl p-8 text-center">' +
                '<p class="text-red-500 font-semibold mb-1">Error cargando secciÃ³n</p>' +
                '<p class="text-gray-400 text-sm">' + e.message + '</p></div>';
        });
}

// Clic en tabs
document.querySelectorAll('.amz-prod-tab').forEach(function(btn) {
    btn.addEventListener('click', function() {
        loadAmzProdTab(
            this.getAttribute('data-tab'),
            this.getAttribute('data-url'),
            this
        );
    });
});

// Carga inicial: tab Resumen
var firstTab = document.querySelector('.amz-prod-tab[data-tab="resumen"]');
if (firstTab) {
    loadAmzProdTab('resumen', firstTab.getAttribute('data-url'), firstTab);
}

// â”€â”€ FunciÃ³n global para cambiar de tab desde los partials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchAmzProdTab = function(tabName) {
    var btn = document.querySelector('.amz-prod-tab[data-tab="' + tabName + '"]');
    if (btn) {
        _amzProdActiveTab = null; // Forzar recarga
        loadAmzProdTab(tabName, btn.getAttribute('data-url'), btn);
    }
};

// â”€â”€ FunciÃ³n global para actualizar precio inline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.updateAmzPrice = function(sku, currentPrice) {
    var newPrice = parseFloat(prompt('Nuevo precio para ' + sku + ':\n(Precio actual: $' + currentPrice + ')', currentPrice));
    if (!newPrice || isNaN(newPrice) || newPrice <= 0) return;

    fetch('/api/amazon/products/' + encodeURIComponent(sku) + '/price', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({price: newPrice})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            alert('Precio actualizado a $' + newPrice.toLocaleString('es-MX'));
            _amzProdActiveTab = null;
            var btn = document.querySelector('.amz-prod-tab[data-tab="inventario"]');
            if (btn) loadAmzProdTab('inventario', btn.getAttribute('data-url'), btn);
        } else {
            alert('Error: ' + JSON.stringify(data));
        }
    })
    .catch(function(e) { alert('Error: ' + e.message); });
};
</script>
{% endif %}
{% endblock %}

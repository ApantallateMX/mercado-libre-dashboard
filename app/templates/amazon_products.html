{% extends "base.html" %}
{% block title %}Centro de Productos Amazon{% endblock %}

{% block content %}

{% if not amazon_accounts %}
<!-- Sin cuenta conectada -->
<div class="flex flex-col items-center justify-center py-20 text-center">
    <div class="w-20 h-20 rounded-full bg-orange-100 flex items-center justify-center mb-4">
        <span class="text-3xl font-black text-[#FF9900]">AMZ</span>
    </div>
    <h2 class="text-xl font-bold text-gray-700 mb-2">Sin cuenta Amazon conectada</h2>
    <p class="text-gray-400 text-sm mb-5">Conecta tu cuenta para ver el catÃ¡logo de productos</p>
    <a href="/auth/amazon/connect" class="bg-[#FF9900] text-white font-semibold px-6 py-3 rounded-xl hover:bg-orange-600 transition text-sm">
        Conectar Amazon
    </a>
</div>

{% else %}

<!-- â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bg-white rounded-xl shadow mb-5 overflow-hidden">
    <div class="flex border-b border-gray-100 overflow-x-auto" id="amz-prod-tabs">

        <button data-tab="resumen" data-url="/api/amazon/products/resumen"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-[#FF9900] text-orange-700 bg-orange-50">
            ğŸ“Š Resumen
        </button>

        <button data-tab="inventario" data-url="/api/amazon/products/inventario"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            ğŸ“¦ Inventario
        </button>

        <button data-tab="stock" data-url="/api/amazon/products/stock"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            âš ï¸ Stock
        </button>

        <button data-tab="sin-publicar" data-url="/api/amazon/products/sin-publicar"
                class="amz-prod-tab flex-1 md:flex-none px-5 py-3 min-h-[44px] text-sm font-medium border-b-2 whitespace-nowrap transition
                       border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            ğŸš« Sin Publicar
        </button>

    </div>
</div>

<!-- â”€â”€â”€ CONTENEDOR DEL TAB ACTIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="amz-prod-tab-content">
    <!-- Skeleton inicial -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% for i in range(4) %}
        <div class="bg-white p-5 rounded-xl shadow animate-pulse">
            <div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>
            <div class="h-7 bg-orange-100 rounded w-3/4 mb-2"></div>
            <div class="h-3 bg-gray-100 rounded w-1/3"></div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL DE EDICIÃ“N DE LISTING â€” vive en el template principal para que
     el JS estÃ© disponible aunque el partial se recargue via innerHTML
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="amz-edit-modal"
     class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
     onclick="if(event.target===this)window.closeAmzEdit()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md" onclick="event.stopPropagation()">

        <!-- Header -->
        <div class="flex items-start justify-between px-5 py-4 border-b">
            <div>
                <h3 class="font-semibold text-gray-800 text-sm">Editar Listing Amazon</h3>
                <p id="amz-edit-meta" class="text-xs text-gray-400 mt-0.5 font-mono"></p>
            </div>
            <button onclick="window.closeAmzEdit()"
                    class="text-gray-300 hover:text-gray-600 text-xl leading-none mt-0.5 transition">âœ•</button>
        </div>

        <!-- Body -->
        <div class="px-5 py-4 space-y-4">
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">TÃ­tulo del Producto</label>
                <input id="amz-edit-title" type="text" maxlength="200"
                       class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg outline-none
                              focus:border-[#FF9900] focus:ring-2 focus:ring-[#FF9900]/20 transition"
                       placeholder="TÃ­tulo del listing...">
                <p class="text-[10px] text-gray-400 mt-0.5">MÃ¡x. 200 caracteres</p>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Precio (MXN)</label>
                <div class="flex items-center">
                    <span class="px-3 py-2 bg-gray-50 border border-r-0 border-gray-200 rounded-l-lg text-sm text-gray-500 select-none">$</span>
                    <input id="amz-edit-price" type="number" min="0.01" step="0.01"
                           class="flex-1 px-3 py-2 text-sm border border-gray-200 rounded-r-lg outline-none
                                  focus:border-[#FF9900] focus:ring-2 focus:ring-[#FF9900]/20 transition"
                           placeholder="0.00">
                </div>
            </div>
            <div id="amz-edit-qty-group" class="hidden">
                <label class="block text-xs font-semibold text-gray-600 mb-1">Stock FBM (unidades disponibles)</label>
                <input id="amz-edit-qty" type="number" min="0" step="1"
                       class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg outline-none
                              focus:border-[#FF9900] focus:ring-2 focus:ring-[#FF9900]/20 transition"
                       placeholder="0">
                <p class="text-[10px] text-gray-400 mt-0.5">Solo aplica a listings FBM. Para FBA gestiona desde Seller Central.</p>
            </div>
            <div id="amz-edit-error" class="hidden px-3 py-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-700"></div>
        </div>

        <!-- Footer -->
        <div class="px-5 py-3 border-t bg-gray-50 rounded-b-xl flex items-center justify-between gap-3">
            <a id="amz-edit-sc-link" href="#" target="_blank"
               class="text-xs text-[#FF9900] hover:underline">Ver en Seller Central â†—</a>
            <div class="flex gap-2">
                <button onclick="window.closeAmzEdit()"
                        class="px-4 py-2 text-xs font-semibold border border-gray-200 rounded-lg text-gray-600 hover:border-gray-300 transition bg-white">
                    Cancelar
                </button>
                <button id="amz-edit-save-btn" onclick="window.saveAmzEdit()"
                        class="px-4 py-2 text-xs font-semibold bg-[#FF9900] text-white rounded-lg hover:bg-orange-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Guardar cambios
                </button>
            </div>
        </div>
    </div>
</div>

{% endif %}

{% endblock %}

{% block scripts %}
{% if amazon_accounts %}
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Centro de Productos Amazon v2 â€” navegaciÃ³n entre tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var _amzProdActiveTab = null;

function loadAmzProdTab(tabName, url, btn) {
    if (_amzProdActiveTab === tabName) return;
    _amzProdActiveTab = tabName;

    // Resaltar tab activo
    document.querySelectorAll('.amz-prod-tab').forEach(function(b) {
        b.classList.remove('border-[#FF9900]', 'text-orange-700', 'bg-orange-50');
        b.classList.add('border-transparent', 'text-gray-500');
    });
    if (btn) {
        btn.classList.add('border-[#FF9900]', 'text-orange-700', 'bg-orange-50');
        btn.classList.remove('border-transparent', 'text-gray-500');
    }

    // Skeleton mientras carga
    var container = document.getElementById('amz-prod-tab-content');
    container.innerHTML =
        '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">' +
        Array(4).fill(
            '<div class="bg-white p-5 rounded-xl shadow animate-pulse">' +
            '<div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>' +
            '<div class="h-7 bg-orange-100 rounded w-3/4 mb-2"></div>' +
            '<div class="h-3 bg-gray-100 rounded w-1/3"></div></div>'
        ).join('') + '</div>';

    fetch(url)
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.text();
        })
        .then(function(html) {
            container.innerHTML = html;
            if (tabName === 'inventario') {
                window._applyInvColState();
            }
        })
        .catch(function(e) {
            container.innerHTML =
                '<div class="bg-white rounded-xl p-8 text-center">' +
                '<p class="text-red-500 font-semibold mb-1">Error cargando secciÃ³n</p>' +
                '<p class="text-gray-400 text-sm">' + e.message + '</p></div>';
        });
}

// â”€â”€ Tab Inventario: carga con URL especÃ­fica (filtros, bÃºsqueda, paginaciÃ³n) â”€â”€
window._loadInvTab = function(url) {
    var container = document.getElementById('amz-prod-tab-content');
    // Skeleton tabla
    container.innerHTML =
        '<div class="bg-white rounded-xl shadow p-8 text-center text-gray-400 animate-pulse">' +
        '<svg class="animate-spin h-7 w-7 mx-auto mb-3 text-[#FF9900]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">' +
        '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
        '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>' +
        'Cargando inventarioâ€¦</div>';
    fetch(url)
        .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(function(html) {
            container.innerHTML = html;
            window._applyInvColState();
        })
        .catch(function(e) {
            container.innerHTML =
                '<div class="bg-white rounded-xl p-8 text-center">' +
                '<p class="text-red-500 font-semibold mb-1">Error</p>' +
                '<p class="text-gray-400 text-sm">' + e.message + '</p></div>';
        });
};

// â”€â”€ Helpers para leer el estado actual del inventario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _invState() {
    var s = document.getElementById('amz-inv-state');
    return {
        filter:   s ? s.getAttribute('data-filter')   : 'all',
        sort:     s ? s.getAttribute('data-sort')      : 'units',
        q:        s ? s.getAttribute('data-q')         : '',
        page:     s ? parseInt(s.getAttribute('data-page'))     : 1,
        perPage:  s ? parseInt(s.getAttribute('data-per-page')) : 20,
    };
}

function _invUrl(overrides) {
    var st = _invState();
    var f  = overrides.filter   !== undefined ? overrides.filter   : st.filter;
    var so = overrides.sort     !== undefined ? overrides.sort     : st.sort;
    var q  = overrides.q        !== undefined ? overrides.q        : st.q;
    var p  = overrides.page     !== undefined ? overrides.page     : 1;
    var pp = overrides.perPage  !== undefined ? overrides.perPage  : st.perPage;
    return '/api/amazon/products/inventario?filter=' + f +
           '&sort=' + so +
           '&q=' + encodeURIComponent(q) +
           '&page=' + p +
           '&per_page=' + pp;
}

window._filterInv = function(filterVal) {
    window._loadInvTab(_invUrl({ filter: filterVal }));
};

window._sortInv = function(sortVal) {
    window._loadInvTab(_invUrl({ sort: sortVal }));
};

window._submitInvSearch = function() {
    var inp = document.getElementById('inv-search');
    if (!inp) return;
    window._loadInvTab(_invUrl({ q: inp.value.trim(), page: 1 }));
};

window._refreshInv = function() {
    var st = _invState();
    window._loadInvTab(_invUrl({ page: st.page }));
};

// â”€â”€ Column toggles (persistidos en localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _invColState = {};

window._toggleInvCol = function(checkbox) {
    var col = checkbox.getAttribute('data-col');
    _invColState[col] = checkbox.checked;
    try { localStorage.setItem('amz_inv_cols', JSON.stringify(_invColState)); } catch(e) {}
    _applyColVis(col, checkbox.checked);
};

window._applyInvColState = function() {
    try {
        var saved = JSON.parse(localStorage.getItem('amz_inv_cols') || '{}');
        _invColState = saved;
    } catch(e) { _invColState = {}; }
    document.querySelectorAll('.amz-col-toggle').forEach(function(cb) {
        var col = cb.getAttribute('data-col');
        if (col in _invColState) {
            cb.checked = _invColState[col];
        }
        _applyColVis(col, cb.checked);
    });
};

function _applyColVis(col, visible) {
    document.querySelectorAll('.' + col).forEach(function(cell) {
        cell.style.display = visible ? '' : 'none';
    });
}

// Clic en tabs
document.querySelectorAll('.amz-prod-tab').forEach(function(btn) {
    btn.addEventListener('click', function() {
        loadAmzProdTab(
            this.getAttribute('data-tab'),
            this.getAttribute('data-url'),
            this
        );
    });
});

// Carga inicial: tab Resumen
var firstTab = document.querySelector('.amz-prod-tab[data-tab="resumen"]');
if (firstTab) {
    loadAmzProdTab('resumen', firstTab.getAttribute('data-url'), firstTab);
}

// â”€â”€ FunciÃ³n global para cambiar de tab desde los partials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchAmzProdTab = function(tabName) {
    var btn = document.querySelector('.amz-prod-tab[data-tab="' + tabName + '"]');
    if (btn) {
        _amzProdActiveTab = null; // Forzar recarga
        loadAmzProdTab(tabName, btn.getAttribute('data-url'), btn);
    }
};

// â”€â”€ Modal de ediciÃ³n de listing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _editSku = null;
var _editFulfillmentType = null;

window.openAmzEdit = async function(sku, asin, scUrl) {
    _editSku = sku;
    _editFulfillmentType = null;

    document.getElementById('amz-edit-meta').textContent = 'SKU: ' + sku + '  |  ASIN: ' + (asin || 'â€”');
    document.getElementById('amz-edit-sc-link').href = scUrl || 'https://sellercentral.amazon.com.mx/inventory';
    document.getElementById('amz-edit-title').value = '';
    document.getElementById('amz-edit-price').value = '';
    document.getElementById('amz-edit-qty').value = '';
    document.getElementById('amz-edit-qty-group').classList.add('hidden');
    document.getElementById('amz-edit-error').classList.add('hidden');
    var btn = document.getElementById('amz-edit-save-btn');
    btn.textContent = 'Cargando...';
    btn.disabled = true;
    document.getElementById('amz-edit-modal').classList.remove('hidden');

    try {
        var res = await fetch('/api/amazon/products/' + encodeURIComponent(sku) + '/details');
        if (res.ok) {
            var data = await res.json();
            document.getElementById('amz-edit-title').value = data.title || '';
            document.getElementById('amz-edit-price').value = data.price > 0 ? data.price : '';
            _editFulfillmentType = data.fulfillment_type;
            if (data.fulfillment_type === 'FBM') {
                document.getElementById('amz-edit-qty').value = data.qty != null ? data.qty : 0;
                document.getElementById('amz-edit-qty-group').classList.remove('hidden');
            }
        } else {
            document.getElementById('amz-edit-error').textContent = 'No se pudieron cargar los datos del listing.';
            document.getElementById('amz-edit-error').classList.remove('hidden');
        }
    } catch(e) {
        console.warn('[AmzEdit] Error cargando detalles:', e);
    }

    btn.textContent = 'Guardar cambios';
    btn.disabled = false;
};

window.closeAmzEdit = function() {
    document.getElementById('amz-edit-modal').classList.add('hidden');
    _editSku = null;
};

window.saveAmzEdit = async function() {
    if (!_editSku) return;

    var title = document.getElementById('amz-edit-title').value.trim();
    var priceVal = document.getElementById('amz-edit-price').value;
    var qtyVal = document.getElementById('amz-edit-qty').value;
    var price = parseFloat(priceVal);
    var qty = parseInt(qtyVal);

    var body = {};
    if (title) body.title = title;
    if (priceVal !== '' && price > 0) body.price = price;
    if (_editFulfillmentType === 'FBM' && qtyVal !== '' && !isNaN(qty) && qty >= 0) body.qty = qty;

    if (Object.keys(body).length === 0) {
        document.getElementById('amz-edit-error').textContent = 'No hay cambios para guardar.';
        document.getElementById('amz-edit-error').classList.remove('hidden');
        return;
    }

    var btn = document.getElementById('amz-edit-save-btn');
    btn.textContent = 'Guardando...';
    btn.disabled = true;
    document.getElementById('amz-edit-error').classList.add('hidden');

    try {
        var res = await fetch('/api/amazon/products/' + encodeURIComponent(_editSku), {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body),
        });
        var data = await res.json();

        if (data.ok || (data.results && Object.keys(data.results).length > 0)) {
            window.closeAmzEdit();
            setTimeout(function() { window._refreshInv && window._refreshInv(); }, 1000);
        } else {
            var errMsg = (data.errors || ['Error desconocido']).join(' | ');
            document.getElementById('amz-edit-error').textContent = errMsg;
            document.getElementById('amz-edit-error').classList.remove('hidden');
            btn.textContent = 'Guardar cambios';
            btn.disabled = false;
        }
    } catch(e) {
        document.getElementById('amz-edit-error').textContent = 'Error de red: ' + e.message;
        document.getElementById('amz-edit-error').classList.remove('hidden');
        btn.textContent = 'Guardar cambios';
        btn.disabled = false;
    }
};

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var modal = document.getElementById('amz-edit-modal');
        if (modal && !modal.classList.contains('hidden')) window.closeAmzEdit();
    }
});

// â”€â”€ FunciÃ³n global para actualizar precio inline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.updateAmzPrice = function(sku, currentPrice) {
    var newPrice = parseFloat(prompt('Nuevo precio para ' + sku + ':\n(Precio actual: $' + currentPrice + ')', currentPrice));
    if (!newPrice || isNaN(newPrice) || newPrice <= 0) return;

    fetch('/api/amazon/products/' + encodeURIComponent(sku) + '/price', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({price: newPrice})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            alert('Precio actualizado a $' + newPrice.toLocaleString('es-MX'));
            _amzProdActiveTab = null;
            var btn = document.querySelector('.amz-prod-tab[data-tab="inventario"]');
            if (btn) loadAmzProdTab('inventario', btn.getAttribute('data-url'), btn);
        } else {
            alert('Error: ' + JSON.stringify(data));
        }
    })
    .catch(function(e) { alert('Error: ' + e.message); });
};
</script>
{% endif %}
{% endblock %}

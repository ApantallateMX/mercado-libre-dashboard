{% extends "base.html" %}
{% block title %}Inventario Global — MeLi Dashboard{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Centro de Inventario Global</h1>
            <p class="text-xs text-gray-500 mt-1">BinManager × 4 cuentas MeLi — SKUs con stock disponible</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-600">Threshold crítico:</label>
                <input type="number" id="threshold-input" value="10" min="1" max="50"
                       class="w-16 px-2 py-1 border border-gray-300 rounded text-xs text-center">
            </div>
            <button onclick="startBulkConcentration()" id="bulk-btn"
                    class="hidden px-4 py-2 bg-amber-600 text-white text-sm font-bold rounded-lg hover:bg-amber-700 transition flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
                Concentrar en Bulk
            </button>
            <button onclick="startScan()" id="scan-btn"
                    class="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 active:bg-indigo-800 transition flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Escanear Inventario
            </button>
        </div>
    </div>

    <!-- Progress bar (hidden initially) -->
    <div id="scan-progress" class="hidden mb-4 bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700" id="progress-label">Iniciando escaneo...</span>
            <span class="text-xs text-gray-500" id="progress-pct">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="progress-bar" class="bg-indigo-600 h-3 rounded-full transition-all duration-500 relative overflow-hidden" style="width: 2%">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse"></div>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-2 font-mono" id="progress-detail"></p>
    </div>

    <!-- KPI summary (hidden initially) -->
    <div id="kpi-grid" class="hidden grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-indigo-400">
            <p class="text-xs text-gray-500">SKUs Escaneados</p>
            <p class="text-2xl font-bold text-indigo-600" id="kpi-total">—</p>
        </div>
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-green-400">
            <p class="text-xs text-gray-500">Con Stock BM</p>
            <p class="text-2xl font-bold text-green-600" id="kpi-with-stock">—</p>
        </div>
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-red-400">
            <p class="text-xs text-gray-500">Stock Crítico</p>
            <p class="text-2xl font-bold text-red-600" id="kpi-critical">—</p>
        </div>
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-yellow-400">
            <p class="text-xs text-gray-500">Sin Stock BM</p>
            <p class="text-2xl font-bold text-yellow-600" id="kpi-zero">—</p>
        </div>
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-purple-400">
            <p class="text-xs text-gray-500">Oportunidad</p>
            <p class="text-2xl font-bold text-purple-600" id="kpi-opportunity">—</p>
            <p class="text-[10px] text-gray-400">BM>0, MeLi=0</p>
        </div>
    </div>

    <!-- Filter tabs -->
    <div id="filter-tabs" class="hidden flex gap-2 mb-4 flex-wrap">
        <button onclick="filterTable('all')" class="filter-tab active px-3 py-1.5 rounded-lg text-xs font-semibold bg-indigo-600 text-white" data-filter="all">Todos</button>
        <button onclick="filterTable('critical')" class="filter-tab px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="critical">Stock Crítico</button>
        <button onclick="filterTable('opportunity')" class="filter-tab px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="opportunity">Oportunidad</button>
        <button onclick="filterTable('zero')" class="filter-tab px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="zero">Sin Stock</button>
        <button onclick="filterTable('ok')" class="filter-tab px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200" data-filter="ok">OK</button>
        <div class="ml-auto flex items-center gap-2">
            <input type="text" id="search-input" placeholder="Buscar SKU / producto..."
                   oninput="searchTable(this.value)"
                   class="px-3 py-1.5 border border-gray-300 rounded-lg text-xs w-48 focus:ring-2 focus:ring-indigo-300">
        </div>
    </div>

    <!-- Results table -->
    <div id="results-container" class="hidden">
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full text-xs" id="inventory-table">
                <thead class="bg-indigo-50 border-b sticky top-0">
                    <tr>
                        <th class="text-left px-3 py-2.5 text-gray-600 font-semibold">SKU</th>
                        <th class="text-left px-3 py-2.5 text-gray-600 font-semibold">Producto / Marca</th>
                        <th class="text-right px-3 py-2.5 text-gray-600 font-semibold">Retail USD</th>
                        <th class="text-right px-3 py-2.5 text-gray-600 font-semibold">BM Disp.</th>
                        <th class="text-right px-3 py-2.5 text-gray-600 font-semibold">MTY</th>
                        <th class="text-right px-3 py-2.5 text-gray-600 font-semibold">CDMX</th>
                        <!-- Account columns inserted dynamically -->
                        <th class="text-center px-3 py-2.5 text-gray-600 font-semibold" id="th-accounts" colspan="4">Cuentas MeLi</th>
                        <th class="text-center px-3 py-2.5 text-gray-600 font-semibold">Estado</th>
                        <th class="text-center px-3 py-2.5 text-gray-600 font-semibold">Acción</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody" class="divide-y divide-gray-100">
                    <!-- Filled dynamically -->
                </tbody>
            </table>
        </div>
        <p class="text-xs text-gray-400 mt-2 text-center" id="table-footer"></p>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="bg-white rounded-lg shadow p-12 text-center">
        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
        </svg>
        <p class="text-gray-500 font-medium">Haz clic en "Escanear Inventario" para ver el estado de todos los SKUs</p>
        <p class="text-gray-400 text-xs mt-1">Se consultará BinManager y las 4 cuentas MeLi en paralelo</p>
    </div>
</div>

<!-- Concentration Modal -->
<div id="conc-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
        <h3 class="text-base font-bold text-gray-900 mb-1" id="conc-modal-title">Concentrar Stock</h3>
        <p class="text-xs text-gray-500 mb-4" id="conc-modal-sku"></p>
        <div id="conc-modal-body" class="space-y-2 mb-4 max-h-64 overflow-y-auto text-sm"></div>
        <div class="flex gap-3 pt-3 border-t border-gray-100">
            <button id="conc-cancel-btn" onclick="document.getElementById('conc-modal').classList.add('hidden')"
                    class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                Cancelar
            </button>
            <button id="conc-confirm-btn"
                    class="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700">
                Confirmar Concentrar
            </button>
        </div>
        <span id="conc-modal-msg" class="text-xs block text-center mt-2"></span>
    </div>
</div>

<!-- Bulk Concentration Modal -->
<div id="bulk-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
        <h3 class="text-base font-bold text-gray-900 mb-1">Concentración en Bulk</h3>
        <p class="text-xs text-gray-500 mb-3" id="bulk-subtitle">Procesando SKUs con ganador claro...</p>
        <div class="w-full bg-gray-100 rounded-full h-2 mb-1">
            <div id="bulk-bar" class="bg-amber-500 h-2 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
        <div class="flex justify-between text-[10px] text-gray-400 mb-3">
            <span id="bulk-progress-label">0 / 0</span>
            <span id="bulk-pct">0%</span>
        </div>
        <div id="bulk-current-sku" class="text-xs text-gray-500 bg-gray-50 rounded px-2 py-1 mb-3 font-mono min-h-[24px]">—</div>
        <div id="bulk-log" class="text-[10px] text-gray-500 max-h-32 overflow-y-auto space-y-0.5 mb-4 border rounded p-2 bg-gray-50 hidden"></div>
        <div class="flex gap-3">
            <button id="bulk-stop-btn" onclick="stopBulk()"
                    class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">
                Detener
            </button>
            <button id="bulk-close-btn" onclick="document.getElementById('bulk-modal').classList.add('hidden')"
                    class="hidden flex-1 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700">
                Cerrar
            </button>
        </div>
        <div id="bulk-summary" class="hidden mt-3 text-xs text-center text-gray-600 font-medium"></div>
    </div>
</div>

<script>
var _scanData = [];
var _currentFilter = 'all';
var _pendingConc = null;
var _accountNicknames = {};
var _pollInterval = null;

// Status badge config
var _statusConfig = {
    ok:          { label: 'OK',          cls: 'bg-green-100 text-green-700' },
    critical:    { label: 'Crítico',     cls: 'bg-red-100 text-red-700' },
    opportunity: { label: 'Oportunidad', cls: 'bg-purple-100 text-purple-700' },
    zero:        { label: 'Sin Stock',   cls: 'bg-gray-100 text-gray-500' },
};

function getStatus(row, threshold) {
    var bmAvail = row.bm_avail || 0;
    var hasMeliActive = Object.values(row.accounts || {}).some(function(a) { return (a.meli_stock || 0) > 0; });
    if (bmAvail === 0) return 'zero';
    if (bmAvail > 0 && bmAvail <= threshold && hasMeliActive) return 'critical';
    if (bmAvail > 0 && !hasMeliActive) return 'opportunity';
    return 'ok';
}

function startScan() {
    var threshold = parseInt(document.getElementById('threshold-input').value) || 10;
    document.getElementById('scan-btn').disabled = true;
    document.getElementById('scan-btn').innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="30 10" stroke-linecap="round"/></svg> Escaneando...';
    document.getElementById('scan-progress').classList.remove('hidden');
    document.getElementById('results-container').classList.add('hidden');
    document.getElementById('kpi-grid').classList.add('hidden');
    document.getElementById('filter-tabs').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('progress-label').className = 'text-sm font-medium text-gray-700';
    setProgress(1, 'Iniciando escaneo...', 'Conectando con MeLi y BinManager');

    fetch('/api/inventory/global-scan-start?threshold=' + threshold, {
        method: 'POST',
        headers: {'ngrok-skip-browser-warning': 'true'}
    })
    .then(function(r) { return r.json(); })
    .then(function() { _startPolling(); })
    .catch(function(e) { _onScanError('Error iniciando scan: ' + e.message); });
}

function _startPolling() {
    if (_pollInterval) clearInterval(_pollInterval);
    _pollInterval = setInterval(_pollStatus, 2000);
    _pollStatus(); // poll inmediato
}

function _pollStatus() {
    fetch('/api/inventory/global-scan-status', {headers: {'ngrok-skip-browser-warning': 'true'}})
    .then(function(r) { return r.json(); })
    .then(function(state) {
        if (state.status === 'running') {
            setProgress(state.pct || 0, state.label || '', state.detail || '');
        } else if (state.status === 'done') {
            clearInterval(_pollInterval);
            _pollInterval = null;
            // Mostrar 100% brevemente antes de renderizar
            setProgress(100, state.label || 'Completado', '');
            document.getElementById('progress-label').className = 'text-sm font-medium text-green-600';
            setTimeout(function() {
                if (state.result) {
                    var threshold = parseInt(document.getElementById('threshold-input').value) || 10;
                    _scanData = state.result.rows || [];
                    _accountNicknames = state.result.account_nicknames || {};
                    renderResults(threshold);
                } else {
                    document.getElementById('scan-progress').classList.add('hidden');
                }
                resetScanBtn();
            }, 800);
        } else if (state.status === 'error') {
            clearInterval(_pollInterval);
            _pollInterval = null;
            _onScanError(state.error || 'Error desconocido');
        }
    })
    .catch(function(e) {
        // Error de red transitorio — seguir intentando
        console.warn('Poll error:', e);
    });
}

function _onScanError(msg) {
    document.getElementById('progress-label').textContent = 'Error: ' + msg;
    document.getElementById('progress-label').className = 'text-sm font-medium text-red-600';
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('scan-progress').classList.add('hidden');
    resetScanBtn();
}

function resetScanBtn() {
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('scan-btn').innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Escanear Inventario';
}

window.addEventListener('DOMContentLoaded', function() {
    // Verificar si hay un scan en curso o ya completado al cargar la página
    fetch('/api/inventory/global-scan-status', {headers: {'ngrok-skip-browser-warning': 'true'}})
    .then(function(r) { return r.json(); })
    .then(function(state) {
        if (state.status === 'running') {
            document.getElementById('scan-progress').classList.remove('hidden');
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('scan-btn').innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="30 10" stroke-linecap="round"/></svg> Escaneando...';
            setProgress(state.pct || 0, state.label || '', state.detail || '');
            _startPolling();
        } else if (state.status === 'done' && state.result) {
            var threshold = parseInt(document.getElementById('threshold-input').value) || 10;
            _scanData = state.result.rows || [];
            _accountNicknames = state.result.account_nicknames || {};
            renderResults(threshold);
        }
    })
    .catch(function() { /* silencioso — el usuario puede iniciar manualmente */ });
});

function setProgress(pct, label, detail) {
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-pct').textContent = Math.round(pct) + '%';
    if (label !== undefined) document.getElementById('progress-label').textContent = label;
    if (detail !== undefined) document.getElementById('progress-detail').textContent = detail;
}

function renderResults(threshold) {
    var rows = _scanData;
    var total = rows.length;
    var withStock = rows.filter(function(r) { return (r.bm_avail || 0) > 0; }).length;
    var critical = rows.filter(function(r) { return getStatus(r, threshold) === 'critical'; }).length;
    var zero = rows.filter(function(r) { return getStatus(r, threshold) === 'zero'; }).length;
    var opportunity = rows.filter(function(r) { return getStatus(r, threshold) === 'opportunity'; }).length;

    document.getElementById('kpi-total').textContent = total;
    document.getElementById('kpi-with-stock').textContent = withStock;
    document.getElementById('kpi-critical').textContent = critical;
    document.getElementById('kpi-zero').textContent = zero;
    document.getElementById('kpi-opportunity').textContent = opportunity;
    document.getElementById('kpi-grid').classList.remove('hidden');
    document.getElementById('filter-tabs').classList.remove('hidden');
    document.getElementById('results-container').classList.remove('hidden');
    document.getElementById('scan-progress').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('bulk-btn').classList.remove('hidden');

    filterTable(_currentFilter, threshold);
}

function filterTable(filter, threshold) {
    _currentFilter = filter;
    threshold = threshold || parseInt(document.getElementById('threshold-input').value) || 10;

    // Update active tab
    document.querySelectorAll('.filter-tab').forEach(function(t) {
        if (t.getAttribute('data-filter') === filter) {
            t.className = 'filter-tab active px-3 py-1.5 rounded-lg text-xs font-semibold bg-indigo-600 text-white';
        } else {
            t.className = 'filter-tab px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200';
        }
    });

    var filtered = _scanData.filter(function(r) {
        if (filter === 'all') return true;
        return getStatus(r, threshold) === filter;
    });

    renderTable(filtered, threshold);
}

function searchTable(q) {
    var threshold = parseInt(document.getElementById('threshold-input').value) || 10;
    var lq = q.toLowerCase();
    var filtered = _scanData.filter(function(r) {
        if (_currentFilter !== 'all' && getStatus(r, threshold) !== _currentFilter) return false;
        return !lq || (r.sku || '').toLowerCase().includes(lq) || (r.title || '').toLowerCase().includes(lq) || (r.brand || '').toLowerCase().includes(lq);
    });
    renderTable(filtered, threshold);
}

var _ACCOUNT_COLORS = {
    'APANTALLATEMX':    '#3B82F6',
    'AUTOBOT':          '#10B981',
    'BLOWTECHNOLOGIES': '#8B5CF6',
    'LUTEMAMEXICO':     '#F97316',
};

function renderTable(rows, threshold) {
    var tbody = document.getElementById('inventory-tbody');
    var accountIds = Object.keys(_accountNicknames);

    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="12" class="px-4 py-8 text-center text-gray-400 text-sm">No hay resultados para este filtro</td></tr>';
        document.getElementById('table-footer').textContent = '';
        return;
    }

    var html = '';
    rows.forEach(function(row) {
        var status = getStatus(row, threshold);
        var sc = _statusConfig[status] || _statusConfig.ok;
        var bmAvail = row.bm_avail || 0;
        var bmReserved = row.bm_reserved || 0;
        var bmColor = bmAvail === 0 ? '#dc2626' : (bmAvail <= threshold ? '#ea580c' : '#16a34a');
        var retail = row.retail_price_usd;
        var retailHtml = (retail && retail > 0 && retail < 9999)
            ? '<span class="text-blue-600 font-mono">$' + retail.toLocaleString('en', {maximumFractionDigits:0}) + '</span>'
            : '<span class="text-gray-300">—</span>';

        // Account cells
        var accCells = '';
        accountIds.forEach(function(uid) {
            var acc = (row.accounts || {})[uid] || {};
            var nick = _accountNicknames[uid] || uid;
            var shortNick = nick.split(/[^A-Z0-9]/i)[0].slice(0,8);
            var color = _ACCOUNT_COLORS[nick.toUpperCase()] || '#6B7280';
            if (!acc.listed) {
                accCells += '<td class="px-2 py-2 text-center"><span class="text-gray-200 text-[10px]">—</span></td>';
            } else {
                var meli = acc.meli_stock || 0;
                var sold30 = acc.sold_30d || 0;
                var cellColor = meli === 0 ? '#dc2626' : '#16a34a';
                accCells += '<td class="px-2 py-2 text-center">'
                    + '<div class="flex flex-col items-center">'
                    + '<span style="color:' + cellColor + '" class="font-bold text-xs">' + meli + '</span>'
                    + '<span class="text-[9px] text-gray-400">' + sold30 + 'v</span>'
                    + '</div></td>';
            }
        });

        var actionHtml = '';
        if (status === 'critical' || status === 'opportunity') {
            if (row.sku) {
                actionHtml = '<button onclick="openConcModal(\'' + row.sku.replace(/'/g, '') + '\',' + bmAvail + ')"'
                    + ' class="px-2 py-1 bg-red-600 text-white rounded text-[10px] font-medium hover:bg-red-700">Concentrar</button>';
            }
        }

        html += '<tr class="hover:bg-gray-50/50" data-status="' + status + '" data-sku="' + (row.sku || '').toLowerCase() + '">'
            + '<td class="px-3 py-2"><span class="font-mono text-xs text-gray-700 font-semibold">' + (row.sku || '—') + '</span></td>'
            + '<td class="px-3 py-2 max-w-[180px]">'
            + '<div class="truncate text-xs text-gray-800" title="' + (row.title || '') + '">' + (row.title || '—').slice(0,50) + '</div>'
            + (row.brand ? '<div class="text-[10px] text-gray-400">' + row.brand + '</div>' : '')
            + '</td>'
            + '<td class="px-3 py-2 text-right">' + retailHtml + '</td>'
            + '<td class="px-3 py-2 text-right">'
            + '<span style="color:' + bmColor + '" class="font-bold text-xs">' + bmAvail + '</span>'
            + (bmReserved > 0 ? '<div class="text-[10px] text-orange-500 font-medium">Res: ' + bmReserved + '</div>' : '')
            + '</td>'
            + '<td class="px-3 py-2 text-right text-xs ' + ((row.mty||0) > 0 ? 'text-green-600 font-semibold' : 'text-gray-300') + '">' + (row.mty||0) + '</td>'
            + '<td class="px-3 py-2 text-right text-xs ' + ((row.cdmx||0) > 0 ? 'text-green-600 font-semibold' : 'text-gray-300') + '">' + (row.cdmx||0) + '</td>'
            + accCells
            + '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded-full text-[10px] font-semibold ' + sc.cls + '">' + sc.label + '</span></td>'
            + '<td class="px-3 py-2 text-center">' + actionHtml + '</td>'
            + '</tr>';
    });

    tbody.innerHTML = html;
    document.getElementById('table-footer').textContent = rows.length + ' de ' + _scanData.length + ' SKUs mostrados';

    // Update account header
    var thAccounts = document.getElementById('th-accounts');
    if (thAccounts) {
        thAccounts.colSpan = accountIds.length;
        var nickLabels = accountIds.map(function(uid) {
            var nick = _accountNicknames[uid] || uid;
            var color = _ACCOUNT_COLORS[nick.toUpperCase()] || '#6B7280';
            return '<span style="color:' + color + '" class="font-semibold">' + nick.slice(0,8) + '</span>';
        }).join(' / ');
        thAccounts.innerHTML = 'Cuentas MeLi<div class="text-[9px] font-normal">' + nickLabels + '</div>';
    }
}

var _selectedWinnerUid = null;
var _concExecuted = false;
var _bulkRunning = false;

function _resetConcBtn() {
    var btn = document.getElementById('conc-confirm-btn');
    btn.textContent = 'Confirmar Concentrar';
    btn.className = 'flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700';
    btn.disabled = false;
    btn.onclick = executeConcentration;
    var cancelBtn = document.getElementById('conc-cancel-btn');
    if (cancelBtn) {
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.onclick = function() { document.getElementById('conc-modal').classList.add('hidden'); };
    }
}

function openConcModal(sku, bmAvail) {
    var totalBmAvail = bmAvail || 0;
    _concExecuted = false;
    document.getElementById('conc-modal-title').textContent = 'Concentrar Stock — ' + sku;
    document.getElementById('conc-modal-sku').textContent = 'Consultando análisis...';
    document.getElementById('conc-modal-body').innerHTML = '<div class="text-center text-gray-400 py-4">Cargando...</div>';
    document.getElementById('conc-modal-msg').textContent = '';
    _resetConcBtn();
    document.getElementById('conc-modal').classList.remove('hidden');
    _pendingConc = null;
    _selectedWinnerUid = null;

    fetch('/api/stock/concentration/preview?sku=' + encodeURIComponent(sku), {
        headers: {'ngrok-skip-browser-warning': 'true'}
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        _pendingConc = d;
        _pendingConc._bmAvail = totalBmAvail;
        document.getElementById('conc-modal-sku').textContent = 'SKU: ' + sku + ' — BM Disponible: ' + totalBmAvail;

        var details = d.details || [];
        var winner = d.winner || {};
        _selectedWinnerUid = winner.user_id || null;

        if (d.action === 'no_items_found') {
            document.getElementById('conc-modal-body').innerHTML =
                '<div class="text-red-600 bg-red-50 rounded p-3 text-sm">No se encontró el SKU en ninguna cuenta de MeLi.</div>';
            document.getElementById('conc-confirm-btn').disabled = true;
            return;
        }

        if (d.action === 'single_account') {
            document.getElementById('conc-modal-body').innerHTML =
                '<div class="text-blue-600 bg-blue-50 rounded p-3 text-sm">' + (d.message || 'Solo existe en una cuenta.') + '</div>';
            document.getElementById('conc-confirm-btn').disabled = true;
            return;
        }

        document.getElementById('conc-confirm-btn').disabled = false;
        _renderConcDetails(details, totalBmAvail, d);
    })
    .catch(function(e) {
        document.getElementById('conc-modal-body').innerHTML = '<div class="text-red-600 text-sm">Error: ' + e.message + '</div>';
    });
}

function _renderConcDetails(details, totalBmAvail, d) {
    var fullItems = d.full_items || [];
    var fullIds = fullItems.map(function(f) { return f.item_id; });

    var periodLabels = {
        '30 días':    '<span class="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">30d</span>',
        'histórico':  '<span class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">Histórico</span>',
        'sin_ventas': '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">Sin ventas</span>',
    };
    var periodBadge = periodLabels[d.period_used] || '';
    var msgCls = d.manual_selection ? 'text-yellow-700 bg-yellow-50 border border-yellow-200' : 'text-gray-600 bg-gray-50';
    var msgHtml = '<div class="text-xs ' + msgCls + ' rounded p-2 mb-2 flex items-center gap-1">'
        + periodBadge + ' <span>' + (d.message || '') + '</span></div>';

    // Tabla resumen de acciones
    var tableHtml = '<table class="w-full text-xs mb-3 border-collapse">'
        + '<thead><tr class="bg-gray-100 text-gray-500 text-[10px]">'
        + '<th class="px-2 py-1 text-left">Cuenta</th>'
        + '<th class="px-2 py-1 text-left">MLM</th>'
        + '<th class="px-2 py-1 text-center">30d</th>'
        + '<th class="px-2 py-1 text-center">Hist.</th>'
        + '<th class="px-2 py-1 text-center">MeLi</th>'
        + '<th class="px-2 py-1 text-center">Acción</th>'
        + '</tr></thead><tbody>';

    // Filas de items Merchant (seleccionables)
    details.forEach(function(a) {
        if (a.is_full) return; // FULL se muestra aparte
        var isWinner = a.user_id === _selectedWinnerUid;
        var rowCls = isWinner ? 'bg-green-50' : 'hover:bg-gray-50';
        var accionHtml = isWinner
            ? '<span class="text-green-700 font-bold">→ +' + totalBmAvail + ' u.</span>'
            : '<span class="text-red-500">→ 0 u.</span>';
        var winnerCol = isWinner
            ? '<span class="text-[10px] bg-green-200 text-green-800 px-1 rounded">★</span> '
            : '';
        var radioHtml = '<input type="radio" name="conc-winner" value="' + a.user_id + '"'
            + (isWinner ? ' checked' : '')
            + ' class="accent-green-600 mr-1" onchange="selectConcWinner(\'' + a.user_id + '\')">';
        var v30cls = a.sold_30d > 0 ? 'text-blue-600 font-bold' : 'text-gray-400';
        var histCls = a.sold_total > 0 ? 'font-bold text-gray-700' : 'text-gray-400';
        tableHtml += '<tr class="border-t ' + rowCls + ' cursor-pointer" onclick="selectConcWinner(\'' + a.user_id + '\')">'
            + '<td class="px-2 py-1.5">' + radioHtml + winnerCol
            + '<span class="font-semibold">' + (a.nickname || a.user_id).slice(0,12) + '</span></td>'
            + '<td class="px-2 py-1.5 font-mono text-[10px] text-gray-500">'
            + '<a href="https://www.mercadolibre.com.mx/p/' + a.item_id + '" target="_blank" class="hover:text-blue-600">'
            + a.item_id + '</a></td>'
            + '<td class="px-2 py-1.5 text-center ' + v30cls + '">' + (a.sold_30d || 0) + '</td>'
            + '<td class="px-2 py-1.5 text-center ' + histCls + '">' + (a.sold_total || 0) + '</td>'
            + '<td class="px-2 py-1.5 text-center text-gray-600 font-medium">' + (a.available_quantity || 0) + '</td>'
            + '<td class="px-2 py-1.5 text-center">' + accionHtml + '</td>'
            + '</tr>';
    });

    // Filas FULL (no seleccionables, solo informativas)
    fullItems.forEach(function(f) {
        tableHtml += '<tr class="border-t bg-blue-50">'
            + '<td class="px-2 py-1.5">'
            + '<span class="text-[10px] bg-blue-600 text-white px-1.5 py-0.5 rounded font-bold mr-1">FULL</span>'
            + '<span class="font-semibold text-xs">' + (f.nickname || '').slice(0,12) + '</span></td>'
            + '<td class="px-2 py-1.5 font-mono text-[10px] text-gray-500">' + f.item_id + '</td>'
            + '<td class="px-2 py-1.5 text-center text-gray-400">' + (f.sold_30d || 0) + '</td>'
            + '<td class="px-2 py-1.5 text-center text-gray-400">' + (f.sold_total || 0) + '</td>'
            + '<td class="px-2 py-1.5 text-center text-blue-600 font-medium">' + (f.available_quantity || 0) + '</td>'
            + '<td class="px-2 py-1.5 text-center"><span class="text-blue-600 text-xs">Sin cambio</span></td>'
            + '</tr>';
    });

    tableHtml += '</tbody></table>';

    // Nota FULL si aplica
    var fullNote = '';
    if (fullItems.length) {
        fullNote = '<div class="text-[10px] text-blue-600 bg-blue-50 rounded px-2 py-1 mb-2">'
            + '&#9432; Los items FULL permanecen activos — su inventario lo gestiona MeLi. '
            + 'El stock BM disponible se asigna al listado Merchant ganador.</div>';
    }

    document.getElementById('conc-modal-body').innerHTML = msgHtml + fullNote + tableHtml;
}

function selectConcWinner(uid) {
    _selectedWinnerUid = uid;
    if (_pendingConc) {
        var winner = (_pendingConc.details || []).find(function(d) { return d.user_id === uid; });
        if (winner) _pendingConc.winner = winner;
        _renderConcDetails(_pendingConc.details || [], _pendingConc._bmAvail || 0, _pendingConc);
    }
}

function executeConcentration() {
    if (!_pendingConc || !_selectedWinnerUid || _concExecuted) return;
    var btn = document.getElementById('conc-confirm-btn');
    btn.disabled = true;
    btn.textContent = 'Ejecutando...';
    document.getElementById('conc-modal-msg').textContent = '';

    var winner = (_pendingConc.details || []).find(function(d) { return d.user_id === _selectedWinnerUid; })
        || _pendingConc.winner || {};

    fetch('/api/stock/concentration/execute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({
            sku: _pendingConc.sku,
            winner_user_id: _selectedWinnerUid,
            total_stock: _pendingConc._bmAvail || _pendingConc.total_stock || 0,
            dry_run: false
        })
    })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(res) {
        if (!res.ok) throw new Error(res.data.detail || JSON.stringify(res.data));
        _concExecuted = true;
        var data = res.data;
        var winnerNick = data.winner_nickname || winner.nickname || _selectedWinnerUid;
        var winnerItemId = data.winner_item_id || '';
        var zeroed = data.zeroed_accounts || [];
        var fullSkipped = data.full_skipped || [];

        var msgEl = document.getElementById('conc-modal-msg');
        var lines = [];
        lines.push('✓ ' + winnerNick + ' (' + winnerItemId + ') ← ' + (_pendingConc._bmAvail || 0) + ' u.');
        if (zeroed.length) lines.push('→ 0 en: ' + zeroed.join(', '));
        if (fullSkipped.length) lines.push('FULL sin cambio: ' + fullSkipped.join(', '));
        if (data.errors && data.errors.length) {
            lines.push('⚠ ' + data.errors.length + ' error(es):');
            data.errors.forEach(function(err) {
                var acct = err.nickname || err.user_id || '?';
                var item = err.item_id ? ' (' + err.item_id + ')' : '';
                var msg = err.error || err.action || 'Error desconocido';
                lines.push('  • ' + acct + item + ': ' + msg);
            });
        }
        msgEl.innerHTML = lines.map(function(l) { return '<div>' + l + '</div>'; }).join('');
        msgEl.className = data.ok
            ? 'text-xs block text-center mt-2 text-green-700 font-semibold'
            : 'text-xs block text-center mt-2 text-orange-600 font-semibold';

        // Cambiar botón a "Siguiente" que cierra el modal
        btn.disabled = false;
        btn.textContent = 'Siguiente SKU';
        btn.className = 'flex-1 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700';
        btn.onclick = function() { document.getElementById('conc-modal').classList.add('hidden'); };

        // Remover el row de la tabla
        var sku = _pendingConc.sku || '';
        _removeSKUFromList(sku);
    })
    .catch(function(e) {
        btn.disabled = false;
        btn.textContent = 'Confirmar Concentrar';
        btn.onclick = executeConcentration;
        var msgEl = document.getElementById('conc-modal-msg');
        msgEl.textContent = 'Error: ' + e.message;
        msgEl.className = 'text-xs block text-center mt-2 text-red-600';
    });
}

function _removeSKUFromList(sku) {
    var rows = document.querySelectorAll('[data-sku="' + sku.toLowerCase() + '"]');
    rows.forEach(function(row) {
        row.style.opacity = '0.3';
        row.style.transition = 'opacity 0.4s';
        setTimeout(function() { row.style.display = 'none'; }, 500);
    });
    _scanData = (_scanData || []).filter(function(r) {
        return (r.sku || '').toLowerCase() !== sku.toLowerCase();
    });
    // Actualizar contador del footer
    var visible = document.querySelectorAll('#inventory-tbody tr:not([style*="display: none"])').length;
    var footer = document.getElementById('table-footer');
    if (footer) footer.textContent = visible + ' de ' + _scanData.length + ' SKUs';
}

// ─── Bulk Concentration ──────────────────────────────────────────────────────

function startBulkConcentration() {
    // Candidatos: SKUs visibles con estado crítico u oportunidad
    var threshold = parseInt(document.getElementById('threshold-input').value) || 10;
    var candidates = (_scanData || []).filter(function(r) {
        var st = getStatus(r, threshold);
        return (st === 'critical' || st === 'opportunity') && r.sku;
    });

    if (!candidates.length) {
        alert('No hay SKUs candidatos visibles para concentrar.');
        return;
    }

    if (!confirm('Se procesarán ' + candidates.length + ' SKUs.\n'
        + 'Solo se ejecutarán los que tengan ganador claro (no manual).\n'
        + '¿Continuar?')) return;

    // Inicializar modal de bulk
    document.getElementById('bulk-modal').classList.remove('hidden');
    document.getElementById('bulk-subtitle').textContent = candidates.length + ' SKUs candidatos';
    document.getElementById('bulk-bar').style.width = '0%';
    document.getElementById('bulk-progress-label').textContent = '0 / ' + candidates.length;
    document.getElementById('bulk-pct').textContent = '0%';
    document.getElementById('bulk-current-sku').textContent = '—';
    document.getElementById('bulk-log').innerHTML = '';
    document.getElementById('bulk-log').classList.remove('hidden');
    document.getElementById('bulk-summary').classList.add('hidden');
    document.getElementById('bulk-stop-btn').classList.remove('hidden');
    document.getElementById('bulk-close-btn').classList.add('hidden');
    _bulkRunning = true;

    _runBulk(candidates, 0, {done: 0, skipped: 0, errors: 0});
}

function stopBulk() {
    _bulkRunning = false;
    document.getElementById('bulk-stop-btn').classList.add('hidden');
    document.getElementById('bulk-close-btn').classList.remove('hidden');
    document.getElementById('bulk-subtitle').textContent = 'Detenido por el usuario';
}

function _addBulkLog(sku, status, msg) {
    var logEl = document.getElementById('bulk-log');
    var icons = {ok: '✓', skip: '—', error: '✗'};
    var colors = {ok: 'text-green-600', skip: 'text-gray-400', error: 'text-red-500'};
    var div = document.createElement('div');
    div.className = 'flex gap-1 ' + (colors[status] || 'text-gray-500');
    div.innerHTML = '<span class="font-mono w-28 shrink-0">' + sku + '</span>'
        + '<span>' + (icons[status] || '') + ' ' + msg + '</span>';
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
}

function _runBulk(candidates, idx, stats) {
    if (!_bulkRunning || idx >= candidates.length) {
        // Finalizado
        _bulkRunning = false;
        document.getElementById('bulk-stop-btn').classList.add('hidden');
        document.getElementById('bulk-close-btn').classList.remove('hidden');
        var summEl = document.getElementById('bulk-summary');
        summEl.classList.remove('hidden');
        summEl.textContent = '✓ ' + stats.done + ' concentrados · '
            + stats.skipped + ' omitidos · '
            + stats.errors + ' errores de ' + candidates.length + ' SKUs';
        document.getElementById('bulk-subtitle').textContent = 'Completado';
        renderTable();
        return;
    }

    var row = candidates[idx];
    var sku = row.sku;
    var bmAvail = row.bm_avail || 0;
    var pct = Math.round((idx / candidates.length) * 100);
    document.getElementById('bulk-bar').style.width = pct + '%';
    document.getElementById('bulk-progress-label').textContent = (idx + 1) + ' / ' + candidates.length;
    document.getElementById('bulk-pct').textContent = pct + '%';
    document.getElementById('bulk-current-sku').textContent = sku;

    fetch('/api/stock/concentration/preview?sku=' + encodeURIComponent(sku), {
        headers: {'ngrok-skip-browser-warning': 'true'}
    })
    .then(function(r) { return r.json(); })
    .then(function(preview) {
        if (preview.action !== 'concentrar' || !preview.winner || preview.manual_selection) {
            var reason = preview.manual_selection ? 'sin ventas (manual)' : preview.action;
            _addBulkLog(sku, 'skip', reason);
            stats.skipped++;
            setTimeout(function() { _runBulk(candidates, idx + 1, stats); }, 200);
            return;
        }
        // Ejecutar
        fetch('/api/stock/concentration/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({
                sku: sku,
                winner_user_id: preview.winner.user_id,
                total_stock: bmAvail,
                dry_run: false
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                _addBulkLog(sku, 'ok', preview.winner.nickname + ' ← ' + bmAvail + 'u');
                stats.done++;
                _removeSKUFromList(sku);
            } else {
                var errDetail = (data.errors || []).map(function(e) {
                    return (e.nickname || e.user_id || '?') + ': ' + (e.error || e.action || '?');
                }).join(' | ');
                _addBulkLog(sku, 'error', (data.summary || 'error') + (errDetail ? ' — ' + errDetail : ''));
                stats.errors++;
            }
            setTimeout(function() { _runBulk(candidates, idx + 1, stats); }, 600);
        })
        .catch(function(e) {
            _addBulkLog(sku, 'error', e.message);
            stats.errors++;
            setTimeout(function() { _runBulk(candidates, idx + 1, stats); }, 600);
        });
    })
    .catch(function(e) {
        _addBulkLog(sku, 'error', e.message);
        stats.errors++;
        setTimeout(function() { _runBulk(candidates, idx + 1, stats); }, 600);
    });
}
</script>
{% endblock %}

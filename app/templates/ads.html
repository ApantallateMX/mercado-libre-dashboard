{% extends "base.html" %}

{% block title %}Mercado Ads{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Mercado Ads</h1>
    <p class="text-gray-600">Rendimiento de tu publicidad en Mercado Libre</p>
</div>

<!-- Filtro de fechas -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
    <div class="flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
            <input type="date" id="ads_date_from" class="border rounded px-3 py-2 text-sm">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
            <input type="date" id="ads_date_to" class="border rounded px-3 py-2 text-sm">
        </div>
        <button type="button" id="btn-ads-filtrar"
                class="bg-yellow-400 text-gray-800 font-semibold px-4 py-2 rounded hover:bg-yellow-500 transition text-sm">
            Filtrar
        </button>
        <button type="button" id="btn-ads-limpiar"
                class="border border-gray-300 text-gray-600 px-4 py-2 rounded hover:bg-gray-100 transition text-sm">
            Limpiar
        </button>
    </div>
</div>

<!-- 1. KPIs primarios (5 columnas) -->
<div id="ads-metrics" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
    {% for i in range(5) %}
    <div class="bg-white p-6 rounded-lg shadow animate-pulse">
        <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
        <div class="h-8 bg-gray-200 rounded w-3/4"></div>
    </div>
    {% endfor %}
</div>

<!-- 2. KPIs secundarios (4 columnas, compactas) -->
<div id="ads-metrics-2" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    {% for i in range(4) %}
    <div class="bg-white p-3 rounded-lg shadow animate-pulse">
        <div class="h-3 bg-gray-200 rounded w-1/2 mb-1"></div>
        <div class="h-5 bg-gray-200 rounded w-3/4"></div>
    </div>
    {% endfor %}
</div>

<!-- 3. Grafica Gasto vs Ingresos (compacta) -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-base font-semibold text-gray-800">Gasto vs Ingresos</h2>
        <div class="flex gap-2">
            <button type="button" id="btn-chart-day"
                    class="px-2 py-1 text-xs rounded font-medium bg-yellow-400 text-gray-800">
                Diario
            </button>
            <button type="button" id="btn-chart-month"
                    class="px-2 py-1 text-xs rounded font-medium bg-gray-200 text-gray-600 hover:bg-gray-300">
                Mensual
            </button>
        </div>
    </div>
    <div class="px-4 py-3">
        <div id="spend-chart-loading" class="animate-pulse h-44 bg-gray-100 rounded flex items-center justify-center text-gray-400">
            Cargando grafica...
        </div>
        <canvas id="spend-chart" class="hidden" height="180"></canvas>
    </div>
</div>

<!-- 4. Campanas (gestion con acciones) -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center gap-2">
        <h2 class="text-lg font-semibold text-gray-800">Campanas</h2>
        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">Gestion</span>
    </div>
    <div id="ads-campaigns-table">
        <div class="animate-pulse p-4 space-y-3">
            {% for i in range(5) %}
            <div class="h-12 bg-gray-200 rounded"></div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 5. Rendimiento por Producto (tabla unificada ordenable) -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center gap-2">
        <h2 class="text-lg font-semibold text-gray-800">Rendimiento por Producto</h2>
        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">Ordenable</span>
    </div>
    <div id="ads-performance-table">
        <div class="animate-pulse p-4 space-y-3">
            {% for i in range(5) %}
            <div class="h-12 bg-gray-200 rounded"></div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 6. Productos quemando dinero -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center gap-2">
        <h2 class="text-lg font-semibold text-red-600">Productos sin Ventas con Gasto</h2>
        <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">Requiere atencion</span>
    </div>
    <div id="ads-burning-table">
        <div class="animate-pulse p-4 space-y-3">
            {% for i in range(3) %}
            <div class="h-12 bg-gray-200 rounded"></div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 7. Productos Sin Publicidad (oportunidades) -->
<div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-blue-200 flex items-center gap-2">
        <h2 class="text-lg font-semibold text-blue-700">Productos Sin Publicidad</h2>
        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Oportunidades</span>
    </div>
    <div id="ads-no-ads-table">
        <div class="animate-pulse p-4 space-y-3">
            {% for i in range(3) %}
            <div class="h-12 bg-gray-200 rounded"></div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const today = new Date();
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);

    document.getElementById('ads_date_to').value = today.toISOString().split('T')[0];
    document.getElementById('ads_date_from').value = weekAgo.toISOString().split('T')[0];

    function getDateParams() {
        var df = document.getElementById('ads_date_from').value;
        var dt = document.getElementById('ads_date_to').value;
        var params = [];
        if (df) params.push('date_from=' + df);
        if (dt) params.push('date_to=' + dt);
        return params.join('&');
    }

    function showSpinner(el) {
        el.innerHTML = '<div class="p-8 text-center text-gray-500"><svg class="animate-spin h-8 w-8 mx-auto mb-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Cargando datos de Ads...</div>';
    }

    // === No-Ads functions (defined globally so they work when partial loads) ===

    function toggleAllNoAds(master) {
        document.querySelectorAll('.noads-check').forEach(function(cb) { cb.checked = master.checked; });
        updateAssignBtn();
    }

    function updateAssignBtn() {
        var checked = document.querySelectorAll('.noads-check:checked').length;
        var btn = document.getElementById('btn-assign-ads');
        var select = document.getElementById('noads-campaign-select');
        if (btn) {
            btn.disabled = checked === 0 || !select.value;
            btn.textContent = checked > 0 ? 'Asignar ' + checked + ' producto' + (checked > 1 ? 's' : '') : 'Asignar seleccionados';
        }
    }

    function assignSelectedToAds() {
        var campaignId = document.getElementById('noads-campaign-select').value;
        if (!campaignId) { alert('Selecciona una campana'); return; }

        var checks = document.querySelectorAll('.noads-check:checked');
        var itemIds = [];
        checks.forEach(function(cb) { itemIds.push(cb.value); });
        if (itemIds.length === 0) return;

        var btn = document.getElementById('btn-assign-ads');
        var status = document.getElementById('assign-status');
        btn.disabled = true;
        btn.textContent = 'Asignando...';
        status.textContent = '';

        fetch('/api/ads/assign-to-campaign', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({item_ids: itemIds, campaign_id: parseInt(campaignId)})
        })
        .then(function(r) {
            if (r.ok) return r.json();
            return r.json().then(function(d) { throw new Error(d.detail || 'Error'); });
        })
        .then(function(data) {
            status.textContent = itemIds.length + ' producto(s) asignado(s)';
            status.className = 'text-xs text-green-600 font-medium';
            itemIds.forEach(function(id) {
                var row = document.getElementById('noads-row-' + id);
                if (row) {
                    row.classList.add('opacity-30');
                    var cb = row.querySelector('.noads-check');
                    if (cb) { cb.checked = false; cb.disabled = true; }
                }
            });
            updateAssignBtn();
        })
        .catch(function(e) {
            var msg = e.message;
            if (msg.indexOf('permiso') > -1 || msg.indexOf('Unauthorized') > -1 || msg.indexOf('permission') > -1) {
                msg = 'Sin permiso de escritura en Product Ads. Revisa los permisos de tu app en developers.mercadolibre.com.mx';
            }
            status.textContent = msg;
            status.className = 'text-xs text-red-600 max-w-md';
            btn.disabled = false;
            updateAssignBtn();
        });
    }

    // === Performance table ===

    var perfPage = 1;
    var perfPerPage = 10;

    function loadPerformance(sortCol) {
        var el = document.getElementById('ads-performance-table');
        showSpinner(el);
        var p = getDateParams();
        var url = '/partials/ads-performance?' + p
            + '&sort=' + (sortCol || 'cost')
            + '&page=' + perfPage
            + '&per_page=' + perfPerPage;
        fetch(url)
            .then(function(r) { return r.text(); })
            .then(function(html) { el.innerHTML = html; });
    }

    // === Main load ===

    function loadAll() {
        var p = getDateParams();
        var btn = document.getElementById('btn-ads-filtrar');
        btn.disabled = true;
        btn.classList.add('opacity-50');

        // KPIs
        fetch('/api/ads/metrics?' + p)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('ads-metrics').innerHTML = '<div class="col-span-5 bg-white p-6 rounded-lg shadow text-center text-gray-500">' + data.error + '</div>';
                    document.getElementById('ads-metrics-2').innerHTML = '';
                    return;
                }
                // Fila 1: 5 KPIs primarios
                document.getElementById('ads-metrics').innerHTML =
                    kpiCard('Gasto Total', '$' + fmt(data.total_cost), 'text-red-600') +
                    kpiCard('Ingresos Ads', '$' + fmt(data.total_revenue), 'text-green-600') +
                    kpiCard('Ventas', fmtInt(data.sales) + ' uds', 'text-gray-800') +
                    kpiCard('ROAS', data.roas + 'x', parseFloat(data.roas) >= 3 ? 'text-green-600' : parseFloat(data.roas) >= 1 ? 'text-yellow-600' : 'text-red-600') +
                    kpiCard('ACOS', data.acos + '%', parseFloat(data.acos) <= 15 ? 'text-green-600' : parseFloat(data.acos) <= 30 ? 'text-yellow-600' : 'text-red-600');
                // Fila 2: 4 KPIs secundarios compactos
                document.getElementById('ads-metrics-2').innerHTML =
                    kpiCardSmall('Impresiones', fmtInt(data.impressions), 'text-gray-700') +
                    kpiCardSmall('Clics', fmtInt(data.clicks), 'text-blue-600') +
                    kpiCardSmall('CTR', data.ctr + '%', 'text-gray-700') +
                    kpiCardSmall('CPC Promedio', '$' + fmt(data.cpc), 'text-gray-700');
            })
            .catch(() => {
                document.getElementById('ads-metrics').innerHTML = '<div class="col-span-5 bg-white p-6 rounded-lg shadow text-center text-gray-500">Error cargando metricas de Ads</div>';
                document.getElementById('ads-metrics-2').innerHTML = '';
            });

        // Campanas
        showSpinner(document.getElementById('ads-campaigns-table'));
        fetch('/partials/ads-campaigns?' + p)
            .then(r => r.text())
            .then(html => { document.getElementById('ads-campaigns-table').innerHTML = html; });

        // Rendimiento por Producto (tabla unificada)
        perfPage = 1;
        perfPerPage = 10;
        loadPerformance('cost');

        // Productos quemando dinero
        showSpinner(document.getElementById('ads-burning-table'));
        fetch('/partials/ads-burning?' + p)
            .then(r => r.text())
            .then(html => { document.getElementById('ads-burning-table').innerHTML = html; });

        // Productos sin publicidad
        showSpinner(document.getElementById('ads-no-ads-table'));
        fetch('/partials/ads-no-ads?' + p)
            .then(r => r.text())
            .then(html => {
                document.getElementById('ads-no-ads-table').innerHTML = html;
                // Re-attach campaign select listener after partial loads
                var sel = document.getElementById('noads-campaign-select');
                if (sel) sel.addEventListener('change', updateAssignBtn);
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            })
            .catch(() => {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            });

        // Grafica
        loadSpendChart('day');
    }

    var spendChartInstance = null;
    var currentChartGroupBy = 'day';

    function loadSpendChart(groupBy) {
        currentChartGroupBy = groupBy;
        var p = getDateParams();
        var loading = document.getElementById('spend-chart-loading');
        var canvas = document.getElementById('spend-chart');
        loading.classList.remove('hidden');
        canvas.classList.add('hidden');

        var btnDay = 'px-2 py-1 text-xs rounded font-medium ';
        document.getElementById('btn-chart-day').className = btnDay + (groupBy === 'day'
            ? 'bg-yellow-400 text-gray-800'
            : 'bg-gray-200 text-gray-600 hover:bg-gray-300');
        document.getElementById('btn-chart-month').className = btnDay + (groupBy === 'month'
            ? 'bg-yellow-400 text-gray-800'
            : 'bg-gray-200 text-gray-600 hover:bg-gray-300');

        fetch('/api/ads/spend-timeline?' + p + '&group_by=' + groupBy)
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                canvas.classList.remove('hidden');
                renderSpendChart(data.timeline, groupBy);
            })
            .catch(() => {
                loading.innerHTML = '<span class="text-red-500">Error cargando grafica</span>';
            });
    }

    function renderSpendChart(timeline, groupBy) {
        if (spendChartInstance) {
            spendChartInstance.destroy();
            spendChartInstance = null;
        }
        var monthNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        var labels = timeline.map(function(d) {
            if (groupBy === 'month') {
                var parts = d.date.split('-');
                return monthNames[parseInt(parts[1]) - 1] + ' ' + parts[0];
            }
            var parts = d.date.split('-');
            return parseInt(parts[2]) + '/' + monthNames[parseInt(parts[1]) - 1];
        });

        var ctx = document.getElementById('spend-chart').getContext('2d');
        spendChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Gasto ($)',
                        data: timeline.map(function(d) { return d.cost; }),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: '#EF4444',
                        borderWidth: 1,
                        borderRadius: 4,
                        yAxisID: 'y',
                        order: 2
                    },
                    {
                        label: 'Ingresos ($)',
                        data: timeline.map(function(d) { return d.revenue || 0; }),
                        type: 'line',
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16,185,129,0.08)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: '#10B981',
                        borderWidth: 2,
                        yAxisID: 'y',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 11 } } },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': $' + ctx.parsed.y.toLocaleString('es-MX', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: { display: true, text: 'Monto ($)', font: { size: 11 } },
                        ticks: { callback: function(v) { return '$' + v.toLocaleString('es-MX'); }, font: { size: 10 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: { ticks: { maxRotation: 45, font: { size: 10 } }, grid: { display: false } }
                }
            }
        });
    }

    document.getElementById('btn-chart-day').addEventListener('click', function() { loadSpendChart('day'); });
    document.getElementById('btn-chart-month').addEventListener('click', function() { loadSpendChart('month'); });

    function kpiCard(label, value, colorClass) {
        return '<div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-500 text-sm">' + label + '</p><p class="text-3xl font-bold ' + colorClass + '">' + value + '</p></div>';
    }

    function kpiCardSmall(label, value, colorClass) {
        return '<div class="bg-white p-3 rounded-lg shadow"><p class="text-gray-400 text-xs">' + label + '</p><p class="text-lg font-bold ' + colorClass + '">' + value + '</p></div>';
    }

    function fmt(n) {
        return parseFloat(n).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function fmtInt(n) {
        return parseInt(n).toLocaleString('es-MX');
    }

    // === Campaign quick actions ===

    function _campAction(campaignId, payload, btn, successText) {
        var origText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Guardando...';
        fetch('/api/ads/campaigns/' + campaignId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                btn.textContent = 'Error';
                btn.classList.add('bg-red-200');
                setTimeout(function() { btn.textContent = origText; btn.disabled = false; btn.classList.remove('bg-red-200'); }, 2000);
            } else {
                btn.textContent = successText || 'Guardado';
                setTimeout(function() { btn.textContent = origText; btn.disabled = false; }, 2000);
            }
        })
        .catch(function() {
            btn.textContent = 'Error';
            setTimeout(function() { btn.textContent = origText; btn.disabled = false; }, 2000);
        });
    }

    function toggleCampaign(campaignId, newStatus, btn) {
        _campAction(campaignId, {status: newStatus}, btn, 'Hecho');
        var badge = document.getElementById('camp-status-badge-' + campaignId);
        if (badge) {
            if (newStatus === 'paused') {
                badge.innerHTML = '<span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800">Pausada</span>';
                btn.textContent = 'Reanudar';
                btn.className = 'px-3 py-1.5 text-sm font-medium rounded bg-green-100 text-green-700 hover:bg-green-200 transition';
                btn.setAttribute('onclick', "event.stopPropagation(); toggleCampaign('" + campaignId + "', 'active', this)");
            } else {
                badge.innerHTML = '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800">Activa</span>';
                btn.textContent = 'Pausar';
                btn.className = 'px-3 py-1.5 text-sm font-medium rounded bg-red-100 text-red-700 hover:bg-red-200 transition';
                btn.setAttribute('onclick', "event.stopPropagation(); toggleCampaign('" + campaignId + "', 'paused', this)");
            }
        }
    }

    function saveBudget(campaignId, btn) {
        var input = document.getElementById('budget-input-' + campaignId);
        var val = parseFloat(input.value);
        if (isNaN(val) || val < 1) { alert('Presupuesto debe ser mayor a 0'); return; }
        _campAction(campaignId, {budget: val}, btn, 'Guardado');
    }

    function saveAcos(campaignId, btn) {
        var input = document.getElementById('acos-input-' + campaignId);
        var val = parseFloat(input.value);
        if (isNaN(val) || val < 3 || val > 500) { alert('ACOS target debe estar entre 3 y 500'); return; }
        _campAction(campaignId, {acos_target: val}, btn, 'Guardado');
    }

    document.getElementById('btn-ads-filtrar').addEventListener('click', loadAll);
    document.getElementById('btn-ads-limpiar').addEventListener('click', function() {
        document.getElementById('ads_date_from').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('ads_date_to').value = today.toISOString().split('T')[0];
        loadAll();
    });

    // === Descarga Excel de productos sin ads ===

    function downloadNoAdsExcel() {
        var rows = document.querySelectorAll('#ads-no-ads-inner-table tbody tr[id^="noads-row-"]');
        if (rows.length === 0) { alert('No hay productos para descargar'); return; }

        var checked = document.querySelectorAll('.noads-check:checked');
        var useSelected = checked.length > 0;

        var csv = 'MLM,Titulo,Categoria,Precio,Precio Original,Descuento %,Stock,Vendidos\n';
        rows.forEach(function(row) {
            var cb = row.querySelector('.noads-check');
            if (useSelected && cb && !cb.checked) return;

            var id = row.id.replace('noads-row-', '');
            var cells = row.querySelectorAll('td');
            // Titulo: buscar el link o span con texto del producto
            var titleEl = row.querySelector('a.font-medium, span.font-medium');
            var title = titleEl ? titleEl.textContent.trim() : '';
            // Categoria: buscar el rounded-full badge
            var catEl = row.querySelector('.rounded-full');
            var cat = catEl ? catEl.textContent.trim() : '';
            // Precio: buscar en la celda correspondiente (4ta columna, index 3)
            var priceCell = cells[3];
            var originalPrice = '';
            var currentPrice = '';
            var discount = '';
            if (priceCell) {
                var strikeEl = priceCell.querySelector('.line-through');
                var greenEl = priceCell.querySelector('.text-green-600');
                if (strikeEl && greenEl) {
                    originalPrice = strikeEl.textContent.trim().replace('$','').replace(/,/g,'');
                    currentPrice = greenEl.textContent.trim().replace('$','').replace(/,/g,'');
                    var discountEls = priceCell.querySelectorAll('.text-green-600');
                    if (discountEls.length > 1) {
                        discount = discountEls[1].textContent.trim();
                    }
                } else {
                    currentPrice = priceCell.textContent.trim().replace('$','').replace(/,/g,'').replace(/\s+/g,'');
                }
            }
            // Stock y vendidos
            var stock = cells[4] ? cells[4].textContent.trim() : '';
            var sold = cells[5] ? cells[5].textContent.trim() : '';

            title = title.replace(/"/g, '""');
            cat = cat.replace(/"/g, '""');
            csv += id + ',"' + title + '","' + cat + '",' + currentPrice + ',' + originalPrice + ',"' + discount + '",' + stock + ',' + sold + '\n';
        });

        var blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        var label = useSelected ? 'seleccionados' : 'todos';
        link.download = 'productos_sin_ads_' + label + '_' + new Date().toISOString().slice(0,10) + '.csv';
        link.click();
        URL.revokeObjectURL(link.href);
    }

    // Carga inicial
    loadAll();
</script>
{% endblock %}

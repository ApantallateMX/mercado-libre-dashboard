{% if no_account or error %}
<div class="flex flex-col items-center justify-center py-12 text-center">
    <p class="text-orange-500 font-semibold">{{ error or 'Sin cuenta Amazon conectada' }}</p>
    {% if no_account %}
    <a href="/auth/amazon/connect" class="mt-3 bg-orange-500 text-white px-4 py-2 rounded-lg text-sm">Conectar Amazon</a>
    {% endif %}
</div>
{% else %}

<!-- ‚îÄ‚îÄ‚îÄ Estado actual para JS (data attributes, no script) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="amz-inv-state"
     data-filter="{{ filter }}"
     data-sort="{{ sort }}"
     data-q="{{ q | e }}"
     data-page="{{ page }}"
     data-per-page="{{ per_page }}">
</div>

<!-- ‚îÄ‚îÄ‚îÄ FILTER CHIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex flex-wrap gap-2 mb-3 items-center">

    {% set chips = [
        ("all",     "Todos",       total if filter == "all" else ""),
        ("top",     "Top Ventas",  ""),
        ("low",     "Baja Venta",  ""),
        ("fba",     "FBA",         ""),
        ("nostock", "Sin Stock",   ""),
    ] %}
    {% for val, label, count in chips %}
    <button onclick="window._filterInv('{{ val }}')"
            class="px-3 py-1.5 text-xs font-semibold rounded-full border transition
                   {% if filter == val %}bg-[#FF9900] text-white border-[#FF9900]
                   {% else %}border-gray-200 text-gray-500 hover:border-[#FF9900] hover:text-[#FF9900] bg-white{% endif %}">
        {{ label }}{% if count %} <span class="opacity-70">({{ count }})</span>{% endif %}
    </button>
    {% endfor %}

    <div class="flex-1"></div>

    <!-- Buscador -->
    <div class="flex items-center border border-gray-200 rounded-lg overflow-hidden bg-white">
        <input type="text" id="inv-search" value="{{ q | e }}"
               placeholder="Buscar SKU, ASIN o producto‚Ä¶"
               onkeydown="if(event.key==='Enter') window._submitInvSearch()"
               class="px-3 py-1.5 text-xs text-gray-700 outline-none w-40 md:w-52">
        <button onclick="window._submitInvSearch()"
                class="px-2 py-1.5 text-gray-400 hover:text-[#FF9900] bg-gray-50 border-l border-gray-200 transition" title="Buscar">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/>
            </svg>
        </button>
    </div>

    <!-- Sort -->
    <select id="inv-sort" onchange="window._sortInv(this.value)"
            class="px-2 py-1.5 text-xs border border-gray-200 rounded-lg text-gray-600 outline-none bg-white">
        <option value="units"   {% if sort == "units"   %}selected{% endif %}>Ventas 30d</option>
        <option value="stock"   {% if sort == "stock"   %}selected{% endif %}>Stock FBA</option>
        <option value="revenue" {% if sort == "revenue" %}selected{% endif %}>Revenue</option>
        <option value="price"   {% if sort == "price"   %}selected{% endif %}>Precio</option>
    </select>

    <!-- Refresh forzado (limpia cach√© del servidor) -->
    <button onclick="window._forceRefreshInv()"
            class="px-2 py-1.5 text-xs border border-gray-200 rounded-lg text-gray-400 hover:text-[#FF9900] hover:border-[#FF9900] transition bg-white"
            title="Recargar datos frescos de Amazon">
        ‚Üª
    </button>
</div>

<!-- ‚îÄ‚îÄ‚îÄ COLUMN TOGGLES + CONTADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex flex-wrap gap-x-4 gap-y-1 mb-3 items-center text-xs text-gray-400">
    <span class="font-medium text-gray-500">Columnas:</span>

    <label class="flex items-center gap-1 cursor-pointer select-none">
        <input type="checkbox" id="tog-bm" class="amz-col-toggle" data-col="amz-col-bm"
               onchange="window._toggleInvCol(this)" checked>
        <span>BM Disp+Res</span>
    </label>
    <label class="flex items-center gap-1 cursor-pointer select-none">
        <input type="checkbox" id="tog-wh" class="amz-col-toggle" data-col="amz-col-wh"
               onchange="window._toggleInvCol(this)" checked>
        <span>MTY / CDMX / TJ</span>
    </label>
    <label class="flex items-center gap-1 cursor-pointer select-none">
        <input type="checkbox" id="tog-rev" class="amz-col-toggle" data-col="amz-col-rev"
               onchange="window._toggleInvCol(this)" checked>
        <span>Revenue</span>
    </label>
    <label class="flex items-center gap-1 cursor-pointer select-none">
        <input type="checkbox" id="tog-supply" class="amz-col-toggle" data-col="amz-col-supply"
               onchange="window._toggleInvCol(this)" checked>
        <span>D√≠as Supply</span>
    </label>
    <label class="flex items-center gap-1 cursor-pointer select-none">
        <input type="checkbox" id="tog-status" class="amz-col-toggle" data-col="amz-col-status"
               onchange="window._toggleInvCol(this)" checked>
        <span>Estado</span>
    </label>
    <label class="flex items-center gap-1 cursor-pointer select-none">
        <input type="checkbox" id="tog-deal" class="amz-col-toggle" data-col="amz-col-deal"
               onchange="window._toggleInvCol(this)" checked>
        <span>Deal</span>
    </label>

    <div class="flex-1"></div>

    {% if total > 0 %}
    <span>
        Mostrando
        <strong class="text-gray-600">{{ (page - 1) * per_page + 1 }}‚Äì{{ [(page - 1) * per_page + (listings | length), total] | min }}</strong>
        de <strong class="text-gray-600">{{ total }}</strong>
        {% if total_pages > 1 %}(p√°g <strong class="text-gray-600">{{ page }}/{{ total_pages }}</strong>){% endif %}
    </span>
    {% endif %}
</div>

<!-- ‚îÄ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% if listings %}
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm" id="amz-inv-table">
            <thead style="background: #232F3E;">
                <tr class="text-left text-gray-300 text-xs uppercase tracking-wide">
                    <th class="py-2.5 px-3 font-medium text-center w-8">#</th>
                    <th class="py-2.5 px-4 font-medium">Producto</th>
                    <th class="py-2.5 px-3 font-medium text-right">Precio</th>
                    <th class="py-2.5 px-3 font-medium text-center amz-col-deal">Deal</th>
                    <th class="py-2.5 px-3 font-medium text-right">Disp. (FBA/FBM)</th>
                    <th class="py-2.5 px-3 font-medium text-right amz-col-bm">BM Disp.</th>
                    <th class="py-2.5 px-3 font-medium text-right amz-col-bm">BM Res.</th>
                    <th class="py-2.5 px-3 font-medium text-right amz-col-wh">MTY</th>
                    <th class="py-2.5 px-3 font-medium text-right amz-col-wh">CDMX</th>
                    <th class="py-2.5 px-3 font-medium text-right amz-col-wh">TJ</th>
                    <th class="py-2.5 px-3 font-medium text-right">Ventas 30d</th>
                    <th class="py-2.5 px-3 font-medium text-right amz-col-rev">Revenue 30d</th>
                    <th class="py-2.5 px-3 font-medium text-center amz-col-supply">D√≠as Supply</th>
                    <th class="py-2.5 px-3 font-medium text-center amz-col-status">Estado</th>
                    <th class="py-2.5 px-3 font-medium text-center">Acci√≥n</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                {% for item in listings %}
                {% set row_num = (page - 1) * per_page + loop.index %}
                <tr class="hover:bg-orange-50/30 transition">

                    <!-- # -->
                    <td class="py-2.5 px-3 text-center text-xs text-gray-400">{{ row_num }}</td>

                    <!-- Producto / SKU / ASIN -->
                    <td class="py-2.5 px-4">
                        <div class="min-w-0">
                            <p class="text-xs font-medium text-gray-800 truncate max-w-[200px] md:max-w-[280px]" title="{{ item.title }}">
                                {{ item.title }}
                            </p>
                            <div class="flex items-center gap-1.5 mt-0.5 flex-wrap">
                                <span class="text-xs font-mono text-gray-400">{{ item.sku }}</span>
                                {% if item.asin %}
                                <span class="text-xs text-[#FF9900] font-medium">{{ item.asin }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>

                    <!-- Precio -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap">
                        {% if item.price > 0 %}
                        <button onclick="window.updateAmzPrice('{{ item.sku }}', {{ item.price }})"
                                class="text-xs font-semibold text-gray-700 hover:text-[#FF9900] transition cursor-pointer">
                            ${{ "{:,.0f}".format(item.price) }}
                        </button>
                        {% else %}
                        <span class="text-gray-300 text-xs">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- Deal / Sale activo (junto a precio) -->
                    <td class="py-2.5 px-3 text-center whitespace-nowrap amz-col-deal">
                        {% if item.is_deal %}
                        <span class="inline-flex flex-col items-center cursor-default group relative"
                              title="-{{ item.deal_pct }}% desc. (reg. ${{ '{:,.0f}'.format(item.list_price) }})">
                            <span class="text-xs font-bold text-red-600 group-hover:text-red-700 transition">
                                üè∑Ô∏è ${{ "{:,.0f}".format(item.deal_price) }}
                            </span>
                            <span class="text-[10px] text-red-400 font-medium leading-none mt-0.5">-{{ item.deal_pct }}%</span>
                        </span>
                        {% else %}
                        <span class="text-gray-200 text-xs">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- Disponible FBA/FBM -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap">
                        <div class="flex flex-col items-end gap-0.5">
                            {% if '-FLX' in item.sku|upper %}
                            {# Seller Flex: stock gestionado en onsite.amazon.com ‚Äî no accesible via SP-API #}
                            <span class="text-xs text-gray-400 font-medium"
                                  title="Stock de Amazon Onsite no disponible via SP-API. Gestionar en onsite.amazon.com">
                                ‚Äî
                            </span>
                            <span class="text-[10px] font-medium px-1 rounded bg-gray-100 text-gray-500">
                                Onsite
                            </span>
                            {% else %}
                            <span class="text-sm font-bold
                                {% if item.fba_stock == 0 %}text-red-600
                                {% elif item.fba_stock < 10 %}text-yellow-600
                                {% else %}text-green-600{% endif %}">
                                {{ item.fba_stock }}
                            </span>
                            <span class="text-[10px] font-medium px-1 rounded
                                {% if item.fulfillment_type == 'FBA' %}bg-orange-100 text-orange-600
                                {% else %}bg-blue-100 text-blue-600{% endif %}">
                                {{ item.fulfillment_type }}
                            </span>
                            {% endif %}
                        </div>
                    </td>

                    <!-- BM Disponible -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap amz-col-bm">
                        <span class="text-xs font-medium
                            {% if item.bm_avail > 0 %}text-green-700{% else %}text-red-500{% endif %}">
                            {{ item.bm_avail }}
                        </span>
                    </td>

                    <!-- BM Reservado -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap amz-col-bm">
                        <span class="text-xs
                            {% if item.bm_reserved > 0 %}text-amber-600 font-medium{% else %}text-gray-300{% endif %}">
                            {{ item.bm_reserved }}
                        </span>
                    </td>

                    <!-- MTY -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap amz-col-wh">
                        <span class="text-xs font-medium
                            {% if item.bm_mty > 0 %}text-green-700{% else %}text-gray-300{% endif %}">
                            {{ item.bm_mty }}
                        </span>
                    </td>

                    <!-- CDMX -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap amz-col-wh">
                        <span class="text-xs font-medium
                            {% if item.bm_cdmx > 0 %}text-green-700{% else %}text-gray-300{% endif %}">
                            {{ item.bm_cdmx }}
                        </span>
                    </td>

                    <!-- TJ -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap amz-col-wh">
                        <span class="text-xs text-gray-400">{{ item.bm_tj }}</span>
                    </td>

                    <!-- Ventas 30d -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap">
                        <span class="text-sm font-bold
                            {% if item.units_30d >= 5 %}text-[#FF9900]
                            {% elif item.units_30d > 0 %}text-gray-600
                            {% else %}text-gray-300{% endif %}">
                            {{ item.units_30d }}
                        </span>
                    </td>

                    <!-- Revenue 30d -->
                    <td class="py-2.5 px-3 text-right whitespace-nowrap amz-col-rev">
                        {% if item.revenue_30d > 0 %}
                        <span class="text-xs font-medium text-gray-700">
                            ${{ "{:,.0f}".format(item.revenue_30d) }}
                        </span>
                        {% else %}
                        <span class="text-xs text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- D√≠as Supply -->
                    <td class="py-2.5 px-3 text-center whitespace-nowrap amz-col-supply">
                        {% if item.dias_supply is not none %}
                        <span class="px-1.5 py-0.5 rounded-full text-xs font-bold
                            {% if item.supply_color == 'red' %}bg-red-100 text-red-700
                            {% elif item.supply_color == 'yellow' %}bg-yellow-100 text-yellow-700
                            {% else %}bg-green-100 text-green-700{% endif %}">
                            {{ item.dias_supply }}d
                        </span>
                        {% else %}
                        <span class="text-xs text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>

                    <!-- Estado -->
                    <td class="py-2.5 px-3 text-center whitespace-nowrap amz-col-status">
                        {% if item.status == 'ACTIVE' %}
                        <span class="px-1.5 py-0.5 text-xs rounded-full bg-green-100 text-green-700 font-medium">Activo</span>
                        {% elif item.status == 'DISCOVERABLE' %}
                        <span class="px-1.5 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700 font-medium">Visible</span>
                        {% else %}
                        <span class="px-1.5 py-0.5 text-xs rounded-full bg-gray-100 text-gray-500">Inactivo</span>
                        {% endif %}
                    </td>

                    <!-- Acciones -->
                    <td class="py-2.5 px-3 text-center whitespace-nowrap">
                        <div class="flex items-center justify-center gap-2">
                            {% if item.amazon_url %}
                            <a href="{{ item.amazon_url }}" target="_blank"
                               class="text-xs text-[#FF9900] hover:text-orange-600 transition font-bold" title="Ver en Amazon">‚Üó</a>
                            {% endif %}
                            {% if item.price > 0 %}
                            <button onclick="window.updateAmzPrice('{{ item.sku }}', {{ item.price }})"
                                    class="text-xs text-[#146EB4] hover:text-blue-800 transition font-bold" title="Actualizar precio">$</button>
                            {% endif %}
                            <button onclick="window.openAmzEdit('{{ item.sku | e }}', '{{ item.asin }}', '{{ item.sc_url | e }}')"
                                    class="text-xs text-gray-400 hover:text-[#FF9900] transition" title="Editar listing">‚úèÔ∏è</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ PAGINACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    {% if total_pages > 1 %}
    <div class="px-4 py-3 border-t border-gray-100 bg-white flex flex-wrap items-center justify-between gap-3">
        <span class="text-xs text-gray-400">
            Mostrando
            <strong class="text-gray-600">{{ (page - 1) * per_page + 1 }}‚Äì{{ [(page - 1) * per_page + (listings | length), total] | min }}</strong>
            de <strong class="text-gray-600">{{ total }}</strong> productos
        </span>
        <div class="flex items-center gap-1 flex-wrap">

            <!-- Anterior -->
            <button onclick="window._loadInvTab('/api/amazon/products/inventario?filter={{ filter }}&sort={{ sort }}&q={{ q | e }}&page={{ page - 1 }}&per_page={{ per_page }}')"
                    {% if page <= 1 %}disabled{% endif %}
                    class="h-8 px-3 rounded-lg text-xs font-semibold border border-gray-200 text-gray-600 hover:border-[#FF9900] hover:text-[#FF9900] disabled:opacity-30 disabled:cursor-not-allowed transition">
                ‚Äπ Ant
            </button>

            <!-- N√∫meros de p√°gina con ellipsis -->
            {% set ns = namespace(last=0) %}
            {% for p in range(1, total_pages + 1) %}
                {% set near = p >= page - 2 and p <= page + 2 %}
                {% set edge = p == 1 or p == total_pages %}
                {% if near or edge %}
                    {% if ns.last > 0 and p - ns.last > 1 %}
                    <span class="px-1 text-gray-300 select-none text-xs">‚Ä¶</span>
                    {% endif %}
                    {% if p == page %}
                    <button class="min-w-[32px] h-8 px-2 rounded-lg text-xs font-semibold border bg-[#FF9900] text-white border-[#FF9900] cursor-default">{{ p }}</button>
                    {% else %}
                    <button onclick="window._loadInvTab('/api/amazon/products/inventario?filter={{ filter }}&sort={{ sort }}&q={{ q | e }}&page={{ p }}&per_page={{ per_page }}')"
                            class="min-w-[32px] h-8 px-2 rounded-lg text-xs font-semibold border border-gray-200 text-gray-600 hover:border-[#FF9900] hover:text-[#FF9900] transition">{{ p }}</button>
                    {% endif %}
                    {% set ns.last = p %}
                {% endif %}
            {% endfor %}

            <!-- Siguiente -->
            <button onclick="window._loadInvTab('/api/amazon/products/inventario?filter={{ filter }}&sort={{ sort }}&q={{ q | e }}&page={{ page + 1 }}&per_page={{ per_page }}')"
                    {% if page >= total_pages %}disabled{% endif %}
                    class="h-8 px-3 rounded-lg text-xs font-semibold border border-gray-200 text-gray-600 hover:border-[#FF9900] hover:text-[#FF9900] disabled:opacity-30 disabled:cursor-not-allowed transition">
                Sig ‚Ä∫
            </button>

            <!-- Items por p√°gina -->
            <select onchange="window._loadInvTab('/api/amazon/products/inventario?filter={{ filter }}&sort={{ sort }}&q={{ q | e }}&page=1&per_page=' + this.value)"
                    class="h-8 px-2 rounded-lg text-xs border border-gray-200 text-gray-500 outline-none bg-white ml-1">
                {% for n in [10, 20, 50] %}
                <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}/p√°g</option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% else %}
    <div class="px-4 py-3 border-t border-gray-50 flex items-center justify-between">
        <p class="text-xs text-gray-400">{{ total }} producto{{ "s" if total != 1 else "" }}</p>
        <p class="text-xs text-gray-400">Orden: {{ sort }}</p>
    </div>
    {% endif %}
</div>

{% else %}
<div class="bg-white rounded-xl shadow p-10 text-center">
    <p class="text-3xl mb-3">üì¶</p>
    <p class="text-gray-500 font-semibold">Sin productos en este filtro</p>
    {% if q %}
    <p class="text-gray-400 text-sm mt-1">Sin resultados para "<em>{{ q }}</em>"</p>
    <button onclick="window._loadInvTab('/api/amazon/products/inventario')"
            class="mt-3 px-4 py-2 text-xs bg-[#FF9900] text-white rounded-lg hover:bg-orange-600 transition">
        Limpiar b√∫squeda
    </button>
    {% else %}
    <p class="text-gray-400 text-sm mt-1">Prueba con "Todos"</p>
    {% endif %}
</div>
{% endif %}

{% endif %}

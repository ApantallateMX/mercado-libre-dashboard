{% if no_account or error %}
<div class="flex flex-col items-center justify-center py-12 text-center">
    <p class="text-orange-500 font-semibold">{{ error or 'Sin cuenta Amazon conectada' }}</p>
    {% if no_account %}
    <a href="/auth/amazon/connect" class="mt-3 bg-orange-500 text-white px-4 py-2 rounded-lg text-sm">Conectar Amazon</a>
    {% endif %}
</div>
{% else %}

<!-- â”€â”€â”€ FILTROS + ORDENAMIENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bg-white rounded-xl shadow mb-4 p-4">
    <div class="flex flex-col md:flex-row md:items-center gap-3">
        <!-- Filtro por estado -->
        <div class="flex items-center gap-2 flex-wrap">
            <span class="text-xs text-gray-500 font-medium">Estado:</span>
            {% set filters = [
                ('all',       'Todos',       total),
                ('active',    'Activos',     none),
                ('inactive',  'Inactivos',   none),
                ('suppressed','Suprimidos',  none),
            ] %}
            {% for val, label, _ in filters %}
            <a href="/api/amazon/products/catalog?status_filter={{ val }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
               hx-get="/api/amazon/products/catalog?status_filter={{ val }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
               hx-target="#amz-tab-content"
               hx-swap="innerHTML"
               class="px-2.5 py-1 rounded-full text-xs font-medium transition
               {{ 'bg-orange-500 text-white' if status_filter == val else 'bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-700' }}">
                {{ label }}
            </a>
            {% endfor %}
        </div>
        <!-- Separador -->
        <div class="hidden md:block h-5 w-px bg-gray-200"></div>
        <!-- Ordenamiento -->
        <div class="flex items-center gap-2">
            <span class="text-xs text-gray-500 font-medium">Ordenar:</span>
            {% set sorts = [('fba_stock','FBA Stock'),('price','Precio'),('title','TÃ­tulo')] %}
            {% for val, label in sorts %}
            {% set new_dir = 'asc' if (sort_by == val and sort_dir == 'desc') else 'desc' %}
            <a href="/api/amazon/products/catalog?status_filter={{ status_filter }}&sort_by={{ val }}&sort_dir={{ new_dir }}"
               hx-get="/api/amazon/products/catalog?status_filter={{ status_filter }}&sort_by={{ val }}&sort_dir={{ new_dir }}"
               hx-target="#amz-tab-content"
               hx-swap="innerHTML"
               class="px-2.5 py-1 rounded-full text-xs font-medium transition
               {{ 'bg-orange-500 text-white' if sort_by == val else 'bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-700' }}">
                {% if sort_by == val %}
                    {{ label }} {{ 'â†‘' if sort_dir == 'asc' else 'â†“' }}
                {% else %}
                    {{ label }}
                {% endif %}
            </a>
            {% endfor %}
        </div>
        <div class="md:ml-auto text-xs text-gray-400">
            {{ total }} listings
        </div>
    </div>
</div>

<!-- â”€â”€â”€ TABLA DE LISTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    {% if not listings %}
    <div class="py-16 text-center text-gray-400">
        <div class="text-4xl mb-3">ðŸ“¦</div>
        <p class="font-semibold">Sin resultados</p>
        <p class="text-sm mt-1">Prueba otro filtro de estado</p>
    </div>
    {% else %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-gray-50 border-b border-gray-200 text-left text-xs text-gray-500 uppercase tracking-wide">
                    <th class="py-3 px-4 font-semibold">#</th>
                    <th class="py-3 px-4 font-semibold">Producto</th>
                    <th class="py-3 px-3 font-semibold text-right">Precio</th>
                    <th class="py-3 px-3 font-semibold text-right">FBA</th>
                    <th class="py-3 px-3 font-semibold text-right hidden md:table-cell">Res.</th>
                    <th class="py-3 px-3 font-semibold text-right hidden md:table-cell">Entrante</th>
                    <th class="py-3 px-3 font-semibold text-right hidden lg:table-cell">DaÃ±ado</th>
                    <th class="py-3 px-3 font-semibold text-center">Estado</th>
                    <th class="py-3 px-3 font-semibold text-left hidden lg:table-cell">Sugerencia</th>
                    <th class="py-3 px-3 font-semibold text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in listings %}
                {% set fba_color = 'text-green-600 font-bold' if item.fba_stock >= 10 else ('text-yellow-600 font-bold' if item.fba_stock > 0 else 'text-red-600 font-bold') %}
                <tr class="border-b border-gray-50 hover:bg-orange-50/30 transition">
                    <td class="py-2.5 px-4 text-gray-400 text-xs">{{ loop.index }}</td>
                    <td class="py-2.5 px-4">
                        <div class="flex items-center gap-2.5">
                            {% if item.image_url %}
                            <img src="{{ item.image_url }}" alt="" class="w-10 h-10 rounded object-contain bg-gray-50 shrink-0 border border-gray-100" loading="lazy">
                            {% else %}
                            <div class="w-10 h-10 rounded bg-orange-100 flex items-center justify-center shrink-0 text-orange-400 text-xs font-bold">AMZ</div>
                            {% endif %}
                            <div class="min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate max-w-[260px] md:max-w-[320px]">{{ item.title }}</p>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <p class="text-xs text-gray-400">{{ item.sku }}</p>
                                    {% if item.asin %}
                                    <span class="text-xs text-orange-400">{{ item.asin }}</span>
                                    {% endif %}
                                </div>
                                {% if item.issues %}
                                <div class="mt-1 space-y-0.5">
                                    {% for issue in item.issues[:2] %}
                                    <p class="text-xs {{ 'text-red-500' if issue.severity == 'ERROR' else 'text-yellow-500' }} truncate max-w-[260px]">
                                        âš  {{ issue.message }}
                                    </p>
                                    {% endfor %}
                                    {% if item.issues|length > 2 %}
                                    <p class="text-xs text-gray-400">+{{ item.issues|length - 2 }} issues mÃ¡s</p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="py-2.5 px-3 text-right font-semibold text-gray-800 whitespace-nowrap">
                        {% if item.price > 0 %}
                        <span class="cursor-pointer hover:text-orange-600 transition"
                              onclick="window.updateAmzPrice('{{ item.sku }}', {{ item.price }})">
                            ${{ "{:,.0f}".format(item.price) }}
                            <span class="text-xs text-orange-400 hidden md:inline">âœŽ</span>
                        </span>
                        {% else %}
                        <span class="text-gray-400">â€”</span>
                        {% endif %}
                    </td>
                    <td class="py-2.5 px-3 text-right {{ fba_color }}">
                        {{ item.fba_stock }}
                    </td>
                    <td class="py-2.5 px-3 text-right text-gray-500 hidden md:table-cell">
                        {% if item.reserved > 0 %}
                        <span class="text-blue-600 font-medium">{{ item.reserved }}</span>
                        {% else %}â€”{% endif %}
                    </td>
                    <td class="py-2.5 px-3 text-right text-gray-500 hidden md:table-cell">
                        {% if item.inbound > 0 %}
                        <span class="text-indigo-600 font-medium">{{ item.inbound }}</span>
                        {% else %}â€”{% endif %}
                    </td>
                    <td class="py-2.5 px-3 text-right hidden lg:table-cell">
                        {% if item.unfulfillable > 0 %}
                        <span class="text-red-500 font-medium">{{ item.unfulfillable }}</span>
                        {% else %}<span class="text-gray-300">â€”</span>{% endif %}
                    </td>
                    <td class="py-2.5 px-3 text-center whitespace-nowrap">
                        {% if item.status == 'ACTIVE' %}
                        <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 font-medium">Activo</span>
                        {% elif item.status == 'DISCOVERABLE' %}
                        <span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 font-medium">Visible</span>
                        {% else %}
                        <span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700 font-medium">Inactivo</span>
                        {% endif %}
                    </td>
                    <td class="py-2.5 px-3 text-left hidden lg:table-cell">
                        {% if item.suggestion %}
                        <p class="text-xs {{ 'text-red-500' if 'Sin stock' in item.suggestion or 'Corregir' in item.suggestion else ('text-yellow-600' if 'crÃ­tico' in item.suggestion or 'daÃ±ad' in item.suggestion else 'text-green-600') }} max-w-[220px]">
                            {{ item.suggestion }}
                        </p>
                        {% else %}
                        <span class="text-xs text-green-400">âœ“ OK</span>
                        {% endif %}
                    </td>
                    <td class="py-2.5 px-3 text-center">
                        <div class="flex items-center justify-center gap-1.5">
                            {% if item.amazon_url %}
                            <a href="{{ item.amazon_url }}" target="_blank"
                               class="text-xs text-orange-500 hover:text-orange-700 font-medium transition whitespace-nowrap">
                                Ver â†’
                            </a>
                            {% endif %}
                            {% if item.price > 0 %}
                            <button onclick="window.updateAmzPrice('{{ item.sku }}', {{ item.price }})"
                                    class="text-xs text-gray-400 hover:text-orange-600 transition hidden md:inline"
                                    title="Actualizar precio">
                                ðŸ’²
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Footer de tabla -->
    <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400">
        <span>{{ total }} listings Â· {{ marketplace }}</span>
        <span>Actualizado hace &lt;5 min (cachÃ©)</span>
    </div>
    {% endif %}
</div>

<!-- â”€â”€â”€ NOTA SOBRE PRECIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mt-4 bg-orange-50 border border-orange-200 rounded-xl p-3">
    <div class="flex items-start gap-2">
        <span class="text-lg">ðŸ’¡</span>
        <div>
            <p class="text-sm font-medium text-orange-800">ActualizaciÃ³n de precios inline</p>
            <p class="text-xs text-orange-600 mt-0.5">
                Haz clic en cualquier precio (columna Precio) o en el Ã­cono ðŸ’² para actualizarlo directamente
                via Amazon Listings API. El cambio se refleja en Seller Central en pocos minutos.
            </p>
        </div>
    </div>
</div>

{% endif %}

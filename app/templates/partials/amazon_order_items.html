{# ─── amazon_order_items.html ────────────────────────────────────────────────
   Expand de 3 columnas estilo MeLi:
     Columna 1: PRODUCTOS (título, SKU, ASIN, qty, precio)
     Columna 2: DESGLOSE DE COBROS (precios, tax, envío, descuento, total)
     Columna 3: INFORMACIÓN DE ORDEN (ID, canal, estado, fecha, unidades)
──────────────────────────────────────────────────────────────────────────── #}

{% if not items %}
<div class="px-6 py-4 text-center text-gray-400 text-sm italic bg-orange-50/40">
    Sin items disponibles para esta orden.
</div>

{% else %}

{# ── Calcular totales para el desglose ─────────────────────────────────── #}
{% set total_subtotal = items | sum(attribute='total') %}
{% set total_tax      = items | sum(attribute='tax') %}
{% set total_ship     = items | sum(attribute='shipping') %}
{% set total_discount = items | sum(attribute='discount') %}

<div class="border-t border-orange-200 bg-orange-50/30">
    <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-orange-100">

        {# ═══════════════════════════════════════════════════════════════════
           COLUMNA 1 — PRODUCTOS
           ═══════════════════════════════════════════════════════════════ #}
        <div class="p-4">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Productos</p>

            {% for item in items %}
            <div class="{% if not loop.first %}mt-4 pt-4 border-t border-orange-100{% endif %}">

                {# Título #}
                <p class="text-sm font-semibold text-gray-800 leading-snug mb-2">
                    {{ item.title or '—' }}
                </p>

                {# Grid de datos del item #}
                <div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-xs">
                    <span class="text-gray-400">SKU:</span>
                    <span class="font-mono font-bold text-[#146EB4]">{{ item.sku }}</span>

                    <span class="text-gray-400">ASIN:</span>
                    <span>
                        {% if item.asin != '—' %}
                        <a href="https://www.amazon.com.mx/dp/{{ item.asin }}"
                           target="_blank"
                           class="font-mono text-[#FF9900] hover:underline font-semibold">{{ item.asin }}</a>
                        {% else %}—{% endif %}
                    </span>

                    <span class="text-gray-400">Cantidad:</span>
                    <span class="font-semibold text-gray-700">{{ item.qty }}</span>

                    <span class="text-gray-400">Precio unit:</span>
                    <span class="font-medium text-gray-700">${{ "%.2f"|format(item.unit_price) }}</span>

                    <span class="text-gray-400">Subtotal:</span>
                    <span class="font-bold text-gray-800">${{ "%.2f"|format(item.total) }}</span>
                </div>
            </div>
            {% endfor %}

        </div>

        {# ═══════════════════════════════════════════════════════════════════
           COLUMNA 2 — DESGLOSE DE COBROS
           ═══════════════════════════════════════════════════════════════ #}
        <div class="p-4">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Desglose de cobros</p>

            <div class="space-y-2">

                <div class="flex justify-between items-center py-1.5 border-b border-orange-100">
                    <span class="text-sm text-gray-600">Precio del producto</span>
                    <span class="font-semibold text-gray-800">${{ "%.2f"|format(total_subtotal) }}</span>
                </div>

                {% if total_tax > 0 %}
                <div class="flex justify-between items-center py-1.5 border-b border-orange-100">
                    <span class="text-sm text-gray-600">Impuestos</span>
                    <span class="font-medium text-purple-600">-${{ "%.2f"|format(total_tax) }}</span>
                </div>
                {% endif %}

                {% if total_ship > 0 %}
                <div class="flex justify-between items-center py-1.5 border-b border-orange-100">
                    <span class="text-sm text-gray-600">Envío (comprador)</span>
                    <span class="font-medium text-blue-600">+${{ "%.2f"|format(total_ship) }}</span>
                </div>
                {% endif %}

                {% if total_discount > 0 %}
                <div class="flex justify-between items-center py-1.5 border-b border-orange-100">
                    <span class="text-sm text-gray-600">Descuentos</span>
                    <span class="font-medium text-red-500">-${{ "%.2f"|format(total_discount) }}</span>
                </div>
                {% endif %}

                {# Total de la orden (desde el header de la orden, más preciso) #}
                <div class="flex justify-between items-center py-2 mt-1 bg-green-50 rounded-lg px-2 border border-green-200">
                    <span class="text-sm font-bold text-gray-700">Total</span>
                    <span class="text-lg font-bold text-green-700">
                        ${{ "%.2f"|format(desglose.order_total if desglose.order_total > 0 else total_subtotal) }}
                    </span>
                </div>

                <p class="text-xs text-gray-400 mt-1">
                    {{ desglose.currency }} · Amazon SP-API
                </p>
            </div>
        </div>

        {# ═══════════════════════════════════════════════════════════════════
           COLUMNA 3 — INFORMACIÓN DE ORDEN
           ═══════════════════════════════════════════════════════════════ #}
        <div class="p-4">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Información de Orden</p>

            <div class="grid grid-cols-2 gap-x-3 gap-y-1.5 text-xs">

                <span class="text-gray-400">No. Orden:</span>
                <span class="font-mono font-semibold text-gray-700 break-all">{{ order_ctx.order_id }}</span>

                <span class="text-gray-400">Canal:</span>
                <span>
                    {% if order_ctx.canal == 'FBA' %}
                    <span class="bg-orange-100 text-orange-700 font-bold px-1.5 py-0.5 rounded text-xs">FBA</span>
                    {% else %}
                    <span class="bg-blue-100 text-blue-700 font-bold px-1.5 py-0.5 rounded text-xs">FBM</span>
                    {% endif %}
                </span>

                <span class="text-gray-400">Estado:</span>
                <span class="font-semibold text-gray-700">{{ order_ctx.status }}</span>

                <span class="text-gray-400">Fecha:</span>
                <span class="text-gray-600">{{ order_ctx.date }}</span>

                <span class="text-gray-400">Unidades:</span>
                <span class="font-semibold text-gray-700">{{ order_ctx.units }}</span>

                <span class="text-gray-400">Productos:</span>
                <span class="font-semibold text-gray-700">{{ items | length }}</span>

            </div>

            {# Link a Seller Central #}
            <div class="mt-4 pt-3 border-t border-orange-100">
                <a href="https://sellercentral.amazon.com.mx/orders-v3/order/{{ order_ctx.order_id }}"
                   target="_blank"
                   class="inline-flex items-center gap-1 text-xs text-[#FF9900] hover:underline font-medium">
                    Ver en Seller Central →
                </a>
            </div>
        </div>

    </div>
</div>
{% endif %}

<!-- Banner: Alertas de Stock Perdido -->
{% if stock_alerts %}
{% set alert_per_page = 10 %}
{% set alert_total_pages = ((stock_alerts|length - 1) // alert_per_page) + 1 if stock_alerts|length > 0 else 1 %}
<div class="mb-4 bg-red-50 border border-red-200 rounded-lg p-3 md:p-4" id="alert-section">
    <div class="flex flex-col md:flex-row md:items-start gap-2 md:gap-3 mb-3">
        <div class="flex items-start gap-2 flex-1">
            <svg class="w-5 h-5 md:w-6 md:h-6 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <div>
                <h3 class="text-red-800 font-bold text-xs md:text-sm">
                    Ventas Perdidas: {{ stock_alerts|length }} producto{{ 's' if stock_alerts|length > 1 else '' }} sin stock
                </h3>
                <p class="text-red-600 text-[10px] md:text-xs mt-0.5 hidden md:block">
                    Productos con ventas en {{ alert_days }}d, 0 stock MeLi, pero inventario en BinManager.
                </p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1 text-xs">
                <span class="text-red-600 hidden md:inline">Periodo:</span>
                {% for d in [7, 15, 30] %}
                <button onclick="setAlertDays({{ d }})"
                        class="px-2 py-1 rounded text-[10px] font-medium transition {{ 'bg-red-600 text-white' if alert_days == d else 'bg-red-100 text-red-700 hover:bg-red-200' }}">
                    {{ d }}d
                </button>
                {% endfor %}
            </div>
            <button onclick="bulkSyncAlerts()" id="bulk-sync-btn"
                    class="w-full md:w-auto px-3 py-2 md:py-1.5 bg-red-600 text-white text-xs font-bold rounded-lg hover:bg-red-700 active:bg-red-800 transition">
                Sincronizar todos ({{ stock_alerts|length }})
            </button>
        </div>
    </div>
    <!-- Mobile alert cards (paginated) -->
    <div class="md:hidden space-y-2" id="alert-mobile-list">
        {% for a in stock_alerts %}
        <div class="bg-white rounded-lg p-2.5 border border-red-100 alert-card" data-alert-page="{{ ((loop.index0 // alert_per_page) + 1) }}" id="alert-row-{{ a.id }}"
             style="{{ 'display:none' if loop.index0 >= alert_per_page else '' }}">
            <div class="flex items-center gap-2 mb-2">
                {% if a.thumbnail %}
                <img src="{{ a.thumbnail }}" class="w-10 h-10 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-1">{{ a.title[:50] }}</p>
                    <p class="text-[10px] text-gray-400 font-mono">{{ a.sku or '-' }}</p>
                    <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-[10px] mt-0.5">
                        <span class="text-gray-500">Ventas: <strong>{{ a.get('units', 0) }}</strong></span>
                        <span class="text-red-600">MeLi: <strong>0</strong></span>
                        <span class="text-green-600">BM: <strong>{{ a.get('_bm_total', 0) }}</strong></span>
                        <span class="text-gray-400">MTY:{{ a.get('_bm_mty', 0) }} CDMX:{{ a.get('_bm_cdmx', 0) }} TJ:{{ a.get('_bm_tj', 0) }}</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-1.5 flex-wrap">
                {% if a.get('is_full') %}
                <div class="flex-1 flex flex-col gap-1">
                    <span class="flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-[10px] font-semibold">
                        ⚠️ FULL — no se puede actualizar stock directo
                    </span>
                    <button onclick="changeToMerchantAndSync('{{ a.id }}', {{ a.get('_bm_total', 0) }}, this)"
                            class="flex-1 py-1.5 text-xs bg-orange-500 text-white rounded-lg font-medium active:bg-orange-600"
                            title="Cambia de FULL a envío propio y luego sincroniza el stock">
                        Quitar FULL → Sync Stock
                    </button>
                </div>
                {% else %}
                <button onclick="syncAlertItem('{{ a.id }}', {{ a.get('_bm_total', 0) }}, this)"
                        class="flex-1 py-1.5 text-xs bg-purple-600 text-white rounded-lg font-medium active:bg-purple-700">
                    Sincronizar
                </button>
                {% endif %}
                <button onclick="openEditModal('{{ a.id }}')"
                        class="flex-1 py-1.5 text-xs bg-gray-200 text-gray-700 rounded-lg font-medium active:bg-gray-300">
                    Editar
                </button>
                <span id="alert-msg-{{ a.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- Desktop alert table (paginated) -->
    <div class="hidden md:block overflow-x-auto">
        <table class="w-full text-xs">
            <thead>
                <tr class="text-red-700 border-b border-red-200">
                    <th class="text-left py-1.5 px-2 font-medium">Producto</th>
                    <th class="text-left py-1.5 px-2 font-medium">ID / SKU</th>
                    <th class="text-right py-1.5 px-2 font-medium">Ventas {{ alert_days }}d</th>
                    <th class="text-right py-1.5 px-2 font-medium">Stock MeLi</th>
                    <th class="text-right py-1.5 px-2 font-medium">BM Total</th>
                    <th class="text-right py-1.5 px-2 font-medium">MTY</th>
                    <th class="text-right py-1.5 px-2 font-medium">CDMX</th>
                    <th class="text-right py-1.5 px-2 font-medium">TJ</th>
                    <th class="text-right py-1.5 px-2 font-medium">Rev. Perdido Est.</th>
                    <th class="text-center py-1.5 px-2 font-medium">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-red-100" id="alert-desktop-tbody">
                {% for a in stock_alerts %}
                <tr class="hover:bg-red-100/50 alert-row" data-alert-page="{{ ((loop.index0 // alert_per_page) + 1) }}" id="alert-row-d-{{ a.id }}"
                    style="{{ 'display:none' if loop.index0 >= alert_per_page else '' }}">
                    <td class="py-1.5 px-2">
                        <div class="flex items-center gap-2">
                            {% if a.thumbnail %}
                            <img src="{{ a.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <span class="text-gray-800 truncate max-w-[180px]" title="{{ a.title }}">{{ a.title[:50] }}</span>
                        </div>
                    </td>
                    <td class="py-1.5 px-2">
                        <span class="font-mono text-red-700 text-xs">{{ a.id }}</span>
                        <br><span class="font-mono text-[10px] text-gray-400">{{ a.sku or '-' }}</span>
                    </td>
                    <td class="py-1.5 px-2 text-right font-bold text-gray-800">{{ a.get('units', 0) }}</td>
                    <td class="py-1.5 px-2 text-right font-bold text-red-600">0</td>
                    <td class="py-1.5 px-2 text-right font-bold text-green-600">{{ a.get('_bm_total', 0) }}</td>
                    <td class="py-1.5 px-2 text-right {{ 'text-green-600' if (a.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ a.get('_bm_mty', 0) }}</td>
                    <td class="py-1.5 px-2 text-right {{ 'text-green-600' if (a.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ a.get('_bm_cdmx', 0) }}</td>
                    <td class="py-1.5 px-2 text-right {{ 'text-blue-400' if (a.get('_bm_tj') or 0) > 0 else 'text-gray-300' }}">{{ a.get('_bm_tj', 0) }}</td>
                    <td class="py-1.5 px-2 text-right font-bold text-red-700">
                        {% if a.get('_est_lost_revenue', 0) > 0 %}
                        ${{ "{:,.0f}".format(a._est_lost_revenue) }}
                        {% else %}-{% endif %}
                    </td>
                    <td class="py-1.5 px-2 text-center">
                        {% if a.get('is_full') %}
                        <div class="flex flex-col items-center gap-1">
                            <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px] font-semibold whitespace-nowrap">
                                ⚠️ Es FULL
                            </span>
                            <button onclick="changeToMerchantAndSync('{{ a.id }}', {{ a.get('_bm_total', 0) }}, this)"
                                    class="px-2 py-1 bg-orange-500 text-white rounded hover:bg-orange-600 text-xs font-medium transition whitespace-nowrap"
                                    title="Cambia de FULL a envío propio y luego sincroniza el stock BM">
                                Quitar FULL → Sync
                            </button>
                            <button onclick="openEditModal('{{ a.id }}')"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs font-medium transition">
                                Editar
                            </button>
                            <span id="alert-msg-{{ a.id }}" class="text-[10px]"></span>
                        </div>
                        {% else %}
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="syncAlertItem('{{ a.id }}', {{ a.get('_bm_total', 0) }}, this)"
                                    class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 font-medium transition">
                                Sincronizar
                            </button>
                            <button onclick="openEditModal('{{ a.id }}')"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-medium transition">
                                Editar
                            </button>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Alert pagination controls -->
    {% if alert_total_pages > 1 %}
    <div class="flex items-center justify-between mt-3 pt-2 border-t border-red-200">
        <span class="text-[10px] text-red-600" id="alert-page-info">Pag 1 de {{ alert_total_pages }} ({{ stock_alerts|length }} alertas)</span>
        <div class="flex items-center gap-1" id="alert-pagination">
            <button onclick="alertGoToPage(_alertPage - 1)" id="alert-prev-btn" class="px-2 py-1 text-[10px] rounded border border-red-200 text-red-700 hover:bg-red-100 disabled:opacity-30" disabled>Anterior</button>
            {% for pg in range(1, alert_total_pages + 1) %}
            <button onclick="alertGoToPage({{ pg }})" data-alert-pg="{{ pg }}"
                    class="alert-pg-btn px-2 py-1 text-[10px] rounded border font-medium {{ 'bg-red-600 text-white border-red-600' if pg == 1 else 'border-red-200 text-red-700 hover:bg-red-100' }}">
                {{ pg }}
            </button>
            {% endfor %}
            <button onclick="alertGoToPage(_alertPage + 1)" id="alert-next-btn" class="px-2 py-1 text-[10px] rounded border border-red-200 text-red-700 hover:bg-red-100 {{ 'disabled:opacity-30' if alert_total_pages <= 1 else '' }}">Siguiente</button>
        </div>
    </div>
    {% endif %}
    <span id="bulk-sync-msg" class="text-xs mt-2 block text-center"></span>
</div>
{% endif %}

<!-- Toolbar: presets + busqueda + columnas + sort -->
<div class="mb-4 space-y-3">
    <!-- Preset pills -->
    <div class="flex flex-wrap gap-2 items-center">
        <span class="text-xs text-gray-500 font-medium mr-1">Vista:</span>
        {% set presets = [
            ("all", "Todos"),
            ("top", "Top Ventas"),
            ("stock", "Mayor Stock"),
            ("low", "Baja Venta"),
            ("full", "FULL"),
            ("no_stock", "Sin Stock"),
        ] %}
        {% for key, label in presets %}
        <button onclick="switchPreset('{{ key }}')"
                data-preset="{{ key }}"
                class="preset-pill px-3 py-1.5 rounded-full text-xs font-medium transition
                    {{ 'bg-yellow-400 text-white shadow' if preset == key else 'bg-gray-100 text-gray-600 hover:bg-gray-200' }}">
            {{ label }}
        </button>
        {% endfor %}
    </div>

    <!-- Search + FULL filter + Sort + Per Page + Count -->
    <div class="flex flex-wrap gap-2 md:gap-3 items-center">
        <div class="relative flex-1 min-w-[150px] md:min-w-[200px] max-w-xs">
            <input type="text" id="inv-search" value="{{ search }}" placeholder="Buscar SKU / Titulo..."
                   class="w-full pl-8 pr-3 py-2 text-sm border rounded-lg focus:ring-1 focus:ring-yellow-400 focus:outline-none"
                   oninput="searchTable(this.value)">
            <svg class="w-4 h-4 text-gray-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </div>
        <div class="hidden md:flex items-center gap-1 text-xs">
            <span class="text-gray-500">FULL:</span>
            <select id="inv-full-filter" onchange="applyFullFilter(this.value)"
                    class="text-xs border rounded px-2 py-1 focus:ring-1 focus:ring-yellow-400 focus:outline-none">
                <option value="all" {{ 'selected' if full_filter == 'all' }}>Todos</option>
                <option value="full" {{ 'selected' if full_filter == 'full' }}>Solo FULL</option>
                <option value="not_full" {{ 'selected' if full_filter == 'not_full' }}>Sin FULL</option>
            </select>
        </div>
        <div class="flex items-center gap-1 text-xs">
            <span class="text-gray-500 hidden md:inline">Ordenar:</span>
            <select id="inv-sort" onchange="applySort(this.value)"
                    class="text-xs border rounded px-2 py-1.5 focus:ring-1 focus:ring-yellow-400 focus:outline-none">
                <option value="stock_desc" {{ 'selected' if sort_by == 'stock_desc' }}>Stock MeLi (desc)</option>
                <option value="stock_asc" {{ 'selected' if sort_by == 'stock_asc' }}>Stock MeLi (asc)</option>
                <option value="units_desc" {{ 'selected' if sort_by == 'units_desc' }}>Ventas (desc)</option>
                <option value="units_asc" {{ 'selected' if sort_by == 'units_asc' }}>Ventas (asc)</option>
                <option value="bm_desc" {{ 'selected' if sort_by == 'bm_desc' }}>Stock BM (desc)</option>
                <option value="price_desc" {{ 'selected' if sort_by == 'price_desc' }}>Precio (desc)</option>
                <option value="price_asc" {{ 'selected' if sort_by == 'price_asc' }}>Precio (asc)</option>
                <option value="revenue_desc" {{ 'selected' if sort_by == 'revenue_desc' }}>Revenue (desc)</option>
                <option value="margin_desc" {{ 'selected' if sort_by == 'margin_desc' }}>Margen (desc)</option>
                <option value="photos_asc" {{ 'selected' if sort_by == 'photos_asc' }}>Fotos (asc)</option>
            </select>
        </div>
        <div class="flex items-center gap-1 text-xs">
            <span class="text-gray-500 hidden md:inline">Por pag:</span>
            <select id="inv-per-page" onchange="changePerPage(parseInt(this.value))"
                    class="text-xs border rounded px-2 py-1.5 focus:ring-1 focus:ring-yellow-400 focus:outline-none">
                {% for pp in [10, 20, 50, 9999] %}
                <option value="{{ pp }}" {{ 'selected' if per_page == pp }}>{{ 'Todos' if pp >= 9999 else pp }}</option>
                {% endfor %}
            </select>
        </div>
        <button onclick="refreshCache(this)" id="inv-refresh-btn"
                class="p-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 active:bg-gray-100 transition" title="Refrescar productos desde MeLi">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
        </button>
        <span class="text-xs text-gray-400 ml-auto">
            Mostrando: <strong id="inv-visible-count">{{ products|length }}</strong> de {{ total_count }} productos
            {% if total_pages > 1 %} (pag {{ page }}/{{ total_pages }}){% endif %}
        </span>
    </div>

    <!-- Column toggles (desktop only) -->
    <div class="hidden md:flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500">
        <span class="font-medium">Columnas:</span>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="bm" checked onchange="toggleColumn('bm', this.checked)">
            <span>Stock BM</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="warehouse" {{ 'checked' if preset in ('stock',) }} onchange="toggleColumn('warehouse', this.checked)">
            <span>MTY/CDMX/TJ</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="revenue" {{ 'checked' if preset in ('top', 'stock', 'full') }} onchange="toggleColumn('revenue', this.checked)">
            <span>Revenue</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="cost" {{ 'checked' if preset in ('top', 'stock', 'full') }} onchange="toggleColumn('cost', this.checked)">
            <span>Costo</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="margin" {{ 'checked' if preset in ('top', 'stock', 'full') }} onchange="toggleColumn('margin', this.checked)">
            <span>Margen</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="photos" {{ 'checked' if preset == 'low' }} onchange="toggleColumn('photos', this.checked)">
            <span>Fotos</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="video" {{ 'checked' if preset == 'low' }} onchange="toggleColumn('video', this.checked)">
            <span>Video</span>
        </label>
        <label class="inline-flex items-center gap-1 cursor-pointer">
            <input type="checkbox" class="col-toggle rounded" data-col="recs" {{ 'checked' if preset == 'low' }} onchange="toggleColumn('recs', this.checked)">
            <span>Recomendaciones</span>
        </label>
    </div>
</div>

{% if products %}
<!-- ===== Mobile Card View ===== -->
<div class="md:hidden space-y-2" id="inv-mobile-cards">
    {% set row_offset = (page - 1) * per_page %}
    {% for p in products %}
    {% set has_deal = (p.get('_has_deal')) or (p.original_price and p.original_price > p.price) %}
    <div class="bg-white rounded-lg shadow p-3 inv-card {{ 'border-l-4 border-red-400' if p.available_quantity == 0 else '' }}"
         data-id="{{ p.id }}"
         data-search="{{ p.id|lower }} {{ (p.sku or '')|lower }} {{ p.title|lower }}">
        <div class="flex gap-3">
            {% if p.thumbnail %}
            <img src="{{ p.thumbnail }}" class="w-14 h-14 rounded object-cover flex-shrink-0" alt="">
            {% endif %}
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-800 leading-tight line-clamp-2">{{ p.title }}</p>
                <p class="text-xs text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-xs">
            <!-- Precio -->
            <div>
                {% if has_deal %}
                <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                {% else %}
                <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                {% endif %}
            </div>
            <!-- Stock MeLi -->
            <div data-stock-cell>
                <span class="text-gray-500">MeLi:</span>
                {% if p.get('is_full') %}
                <span class="font-bold text-cyan-600">{{ p.available_quantity }}</span>
                <span class="px-1 py-0.5 text-[10px] font-bold bg-cyan-100 text-cyan-700 rounded">FULL</span>
                {% else %}
                {% set bm = p.get('_bm_total', 0) or 0 %}
                <span data-stock-val class="font-bold {{ 'text-green-600' if p.available_quantity > 5 else 'text-red-600' if p.available_quantity == 0 else 'text-yellow-600' }}"
                      onclick="showStockEditor(this, '{{ p.id }}', {{ p.available_quantity }}, {{ bm }})">{{ p.available_quantity }}</span>
                {% if bm > 0 and bm != p.available_quantity %}
                <button data-bm-btn onclick="event.stopPropagation(); quickSyncBM(this, '{{ p.id }}', {{ bm }})"
                        class="px-1.5 py-0.5 text-[10px] font-bold bg-purple-100 text-purple-700 rounded hover:bg-purple-200">BM:{{ bm }}</button>
                {% endif %}
                {% endif %}
                <span data-stock-msg></span>
            </div>
            <!-- Stock BM -->
            {% if p.get('_bm_total') is not none %}
            <div>
                <span class="text-gray-500">BM:</span>
                <span class="font-bold {{ 'text-green-600' if p._bm_total > 20 else 'text-yellow-600' if p._bm_total > 4 else 'text-red-600' }}">{{ p._bm_total }}</span>
            </div>
            {% endif %}
            <!-- Ventas -->
            <div>
                <span class="text-gray-500">Ventas:</span>
                <span class="font-bold {{ 'text-gray-800' if p.get('units', 0) > 0 else 'text-red-500' }}">{{ p.get('units', 0) }}</span>
            </div>
            {% if p.get('_margen_pct') is not none %}
            <div>
                <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold
                    {% if p._margen_pct >= 20 %}bg-green-100 text-green-700
                    {% elif p._margen_pct >= 10 %}bg-yellow-100 text-yellow-700
                    {% elif p._margen_pct >= 0 %}bg-orange-100 text-orange-700
                    {% else %}bg-red-100 text-red-700{% endif %}">
                    {{ "%.0f"|format(p._margen_pct) }}%
                </span>
            </div>
            {% endif %}
            {% if has_deal %}
            <div data-deal-cell>
                <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 text-green-700">
                    Deal -{{ "%.0f"|format((1 - p.price / p.original_price) * 100) }}%
                </span>
            </div>
            {% endif %}
        </div>
        <!-- Acciones mobile -->
        <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
            {% if p.permalink %}
            <a href="{{ p.permalink }}" target="_blank" class="flex-1 text-center py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg active:bg-blue-100 min-h-[40px]">Ver</a>
            {% endif %}
            <button onclick="openEditModal('{{ p.id }}')" class="flex-1 text-center py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg active:bg-gray-200 min-h-[40px]">Editar</button>
            {% if has_deal %}
            <button onclick="openDealAction('{{ p.id }}', {{ p.price }}, '{{ p.sku or '' }}', '{{ p.title|replace("'", "\\'") }}', {{ p.original_price }}, '{{ p.thumbnail or '' }}')"
                    class="flex-1 text-center py-2 text-sm font-medium text-green-700 bg-green-50 rounded-lg active:bg-green-100 min-h-[40px]">Ver Deal</button>
            {% else %}
            <button onclick="openDealAction('{{ p.id }}', {{ p.price }}, '{{ p.sku or '' }}', '{{ p.title|replace("'", "\\'") }}', 0, '{{ p.thumbnail or '' }}')"
                    class="flex-1 text-center py-2 text-sm font-medium text-purple-700 bg-purple-50 rounded-lg active:bg-purple-100 min-h-[40px]">Deal</button>
            {% endif %}
            {% if not p.get('is_full') %}
            {% set bm = p.get('_bm_total', 0) or 0 %}
            {% if bm > 0 and bm != p.available_quantity %}
            <button onclick="quickSyncBM(this, '{{ p.id }}', {{ bm }})" class="flex-1 text-center py-2 text-sm font-medium text-purple-700 bg-purple-50 rounded-lg active:bg-purple-100 min-h-[40px]">Sync BM</button>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- ===== Desktop Table View ===== -->
<div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
    <table class="w-full text-sm" id="inv-table">
        <thead class="bg-gray-50 border-b">
            <tr>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs">#</th>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs">Producto</th>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs">ID / SKU</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Precio</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs">Deal</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Stock MeLi</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs" data-col="bm">Stock BM</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset not in ('stock',) }}" data-col="warehouse">MTY</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset not in ('stock',) }}" data-col="warehouse">CDMX</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset not in ('stock',) }}" data-col="warehouse">TJ</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Ventas {{ alert_days }}d</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset not in ('top', 'stock', 'full') }}" data-col="revenue">Revenue</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset not in ('top', 'stock', 'full') }}" data-col="cost">Costo BM</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset not in ('top', 'stock', 'full') }}" data-col="margin">Margen</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset != 'low' }}" data-col="photos">Fotos</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset != 'low' }}" data-col="video">Video</th>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs {{ 'hidden' if preset != 'low' }}" data-col="recs">Recomendaciones</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs">Acciones</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="inv-tbody">
            {% set row_offset = (page - 1) * per_page %}
            {% for p in products %}
            {% set has_deal = (p.get('_has_deal')) or (p.original_price and p.original_price > p.price) %}
            <tr class="hover:bg-gray-50 inv-row {{ 'bg-red-50/40' if p.available_quantity == 0 else '' }}"
                data-id="{{ p.id }}"
                data-units="{{ p.get('units', 0) }}"
                data-stock="{{ p.available_quantity }}"
                data-bm="{{ p.get('_bm_total', 0) or 0 }}"
                data-price="{{ p.price }}"
                data-margin="{{ p.get('_margen_pct', -999) or -999 }}"
                data-is-full="{{ '1' if p.is_full else '0' }}"
                data-photos="{{ p.pictures_count }}"
                data-revenue="{{ p.get('revenue', 0) }}"
                data-search="{{ p.id|lower }} {{ (p.sku or '')|lower }} {{ p.title|lower }}">
                <!-- # -->
                <td class="px-3 py-2 text-gray-400 font-bold text-xs">{{ row_offset + loop.index }}</td>
                <!-- Producto -->
                <td class="px-3 py-2">
                    <div class="flex items-center gap-2">
                        {% if p.thumbnail %}
                        <img src="{{ p.thumbnail }}" class="w-10 h-10 rounded object-cover flex-shrink-0" alt="">
                        {% endif %}
                        <div class="min-w-0">
                            <span class="text-gray-800 truncate block max-w-[200px] text-xs" title="{{ p.title }}">{{ p.title }}</span>
                            {% if p.get('variations') %}
                            <button onclick="toggleVariationsInv('inv-v-{{ loop.index }}')"
                                    class="text-[10px] text-purple-600 hover:underline mt-0.5">
                                {{ p.variations|length }} variaciones
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <!-- ID / SKU -->
                <td class="px-3 py-2">
                    <div class="flex flex-col">
                        <a href="{{ p.permalink }}" target="_blank"
                           class="text-xs text-blue-600 font-mono font-semibold hover:underline">{{ p.id }}</a>
                        <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                    </div>
                </td>
                <!-- Precio (editable) -->
                <td class="px-3 py-2 text-right" data-price-cell>
                    {% if has_deal %}
                    <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span data-price-val class="text-green-600 font-semibold text-xs cursor-pointer hover:underline"
                          onclick="showPriceEditor(this, '{{ p.id }}', {{ p.price }})">${{ "{:,.0f}".format(p.price) }}</span>
                    <span class="block text-[10px] text-green-600">-{{ "%.0f"|format((1 - p.price / p.original_price) * 100) }}%</span>
                    {% else %}
                    <span data-price-val class="text-gray-700 text-xs cursor-pointer hover:underline"
                          onclick="showPriceEditor(this, '{{ p.id }}', {{ p.price }})">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                    <span data-price-msg></span>
                </td>
                <!-- Deal -->
                <td class="px-3 py-2 text-center" data-deal-cell>
                    {% if has_deal %}
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        <span class="px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 text-green-700 mt-0.5">
                            -{{ "%.0f"|format((1 - p.price / p.original_price) * 100) }}%
                        </span>
                    </div>
                    {% else %}
                    <span class="text-xs text-gray-400">Sin deal</span>
                    {% endif %}
                </td>
                <!-- Stock MeLi -->
                <td class="px-3 py-2 text-right" data-stock-cell>
                    {% if p.get('is_full') %}
                    <span class="font-semibold text-cyan-600">{{ p.available_quantity }}</span>
                    <span class="ml-1 px-1.5 py-0.5 text-[10px] font-bold bg-cyan-100 text-cyan-700 rounded">FULL</span>
                    {% else %}
                    {% set bm = p.get('_bm_total', 0) or 0 %}
                    <span data-stock-val
                          class="cursor-pointer font-semibold hover:text-purple-600 hover:underline {{ 'text-green-600' if p.available_quantity > 5 else 'text-red-600' if p.available_quantity == 0 else 'text-yellow-600' }}"
                          onclick="showStockEditor(this, '{{ p.id }}', {{ p.available_quantity }}, {{ bm }})">{{ p.available_quantity }}</span>
                    {% if bm > 0 and bm != p.available_quantity %}
                    <button data-bm-btn
                            onclick="event.stopPropagation(); quickSyncBM(this, '{{ p.id }}', {{ bm }})"
                            class="ml-1 px-1.5 py-0.5 text-[10px] font-bold bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition"
                            title="Sync stock MeLi = BM ({{ bm }})">BM</button>
                    {% endif %}
                    {% endif %}
                    <span data-stock-msg></span>
                </td>
                <!-- Stock BM -->
                <td class="px-3 py-2 text-right" data-col="bm">
                    {% if p.get('_bm_total') is not none %}
                    <span class="font-semibold text-xs {{ 'text-green-600' if p._bm_total > 20 else 'text-yellow-600' if p._bm_total > 4 else 'text-red-600' }}">
                        {{ p._bm_total }}
                    </span>
                    {% else %}
                    <span class="text-gray-300">-</span>
                    {% endif %}
                </td>
                <!-- MTY / CDMX / TJ -->
                <td class="px-3 py-2 text-right {{ 'hidden' if preset not in ('stock',) }}" data-col="warehouse">
                    <span class="{{ 'text-green-600' if (p.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_mty', 0) or 0 }}</span>
                </td>
                <td class="px-3 py-2 text-right {{ 'hidden' if preset not in ('stock',) }}" data-col="warehouse">
                    <span class="{{ 'text-green-600' if (p.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_cdmx', 0) or 0 }}</span>
                </td>
                <td class="px-3 py-2 text-right {{ 'hidden' if preset not in ('stock',) }}" data-col="warehouse">
                    <span class="{{ 'text-green-600' if (p.get('_bm_tj') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_tj', 0) or 0 }}</span>
                </td>
                <!-- Ventas -->
                <td class="px-3 py-2 text-right">
                    <span class="font-bold {{ 'text-gray-800' if p.get('units', 0) > 0 else 'text-red-500' }}">
                        {{ p.get('units', 0) }}
                    </span>
                </td>
                <!-- Revenue -->
                <td class="px-3 py-2 text-right {{ 'hidden' if preset not in ('top', 'stock', 'full') }}" data-col="revenue">
                    {% if p.get('revenue', 0) > 0 %}
                    <span class="text-gray-700 text-xs">${{ "{:,.0f}".format(p.revenue) }}</span>
                    {% else %}
                    <span class="text-gray-300">-</span>
                    {% endif %}
                </td>
                <!-- Costo BM -->
                <td class="px-3 py-2 text-right {{ 'hidden' if preset not in ('top', 'stock', 'full') }}" data-col="cost">
                    {% if p.get('_costo_mxn') and p._costo_mxn > 0 %}
                    <div class="flex flex-col items-end">
                        <span class="text-gray-700 text-xs font-semibold">${{ "{:,.0f}".format(p._costo_mxn) }}</span>
                        <span class="text-[10px] text-gray-400">${{ '%.2f'|format(p.get('_bm_avg_cost', 0)) }} USD</span>
                    </div>
                    {% elif p.get('_bm_has_data') %}
                    <span class="text-orange-500 text-[10px]">Sin costo</span>
                    {% else %}
                    <span class="text-gray-300 text-xs">-</span>
                    {% endif %}
                </td>
                <!-- Margen -->
                <td class="px-3 py-2 text-center {{ 'hidden' if preset not in ('top', 'stock', 'full') }}" data-col="margin">
                    {% if p.get('_margen_pct') is not none %}
                    <div class="flex flex-col items-center">
                        <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold
                            {% if p._margen_pct >= 20 %}bg-green-100 text-green-700
                            {% elif p._margen_pct >= 10 %}bg-yellow-100 text-yellow-700
                            {% elif p._margen_pct >= 0 %}bg-orange-100 text-orange-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ "%.1f"|format(p._margen_pct) }}%
                        </span>
                        <span class="text-[10px] text-gray-400 mt-0.5">${{ "{:,.0f}".format(p._ganancia_est) }}</span>
                    </div>
                    {% else %}
                    <span class="text-gray-300 text-xs">-</span>
                    {% endif %}
                </td>
                <!-- Fotos -->
                <td class="px-3 py-2 text-center {{ 'hidden' if preset != 'low' }}" data-col="photos">
                    <span class="{{ 'text-green-600' if p.pictures_count >= 8 else 'text-yellow-600' if p.pictures_count >= 4 else 'text-red-600' }}">
                        {{ p.pictures_count }}
                    </span>
                </td>
                <!-- Video -->
                <td class="px-3 py-2 text-center {{ 'hidden' if preset != 'low' }}" data-col="video">
                    {% if p.has_video %}
                    <span class="text-green-600 text-xs">Si</span>
                    {% else %}
                    <span class="text-red-500 text-xs">No</span>
                    {% endif %}
                </td>
                <!-- Recomendaciones -->
                <td class="px-3 py-2 {{ 'hidden' if preset != 'low' }}" data-col="recs">
                    {% if p.recommendations %}
                    <div class="flex flex-wrap gap-1">
                        {% for rec in p.recommendations[:3] %}
                        <span class="inline-block px-2 py-0.5 rounded text-[10px]
                            {{ 'bg-red-100 text-red-700' if 'stock' in rec.lower()
                               else 'bg-yellow-100 text-yellow-700' if 'foto' in rec.lower() or 'video' in rec.lower()
                               else 'bg-blue-100 text-blue-700' }}">
                            {{ rec }}
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="text-gray-300 text-xs">-</span>
                    {% endif %}
                </td>
                <!-- Acciones -->
                <td class="px-3 py-2 text-center">
                    <div class="flex flex-col items-center gap-0.5">
                        {% if p.permalink %}
                        <a href="{{ p.permalink }}" target="_blank" class="text-blue-500 hover:text-blue-700 text-xs">Ver</a>
                        {% endif %}
                        <button onclick="openEditModal('{{ p.id }}')"
                                class="text-[10px] text-gray-400 hover:text-gray-600">Editar</button>
                        {% if has_deal %}
                        <button onclick="openDealAction('{{ p.id }}', {{ p.price }}, '{{ p.sku or '' }}', '{{ p.title|replace("'", "\\'") }}', {{ p.original_price }}, '{{ p.thumbnail or '' }}')"
                                class="text-[10px] text-green-600 hover:text-green-800 hover:underline">Ver Deal</button>
                        {% else %}
                        <button onclick="openDealAction('{{ p.id }}', {{ p.price }}, '{{ p.sku or '' }}', '{{ p.title|replace("'", "\\'") }}', 0, '{{ p.thumbnail or '' }}')"
                                class="text-[10px] text-purple-600 hover:text-purple-800 hover:underline">Deal</button>
                        {% endif %}
                        {% if p.is_full %}
                        <button onclick="changeToMerchant('{{ p.id }}')"
                                class="text-[10px] text-cyan-600 hover:text-cyan-800 hover:underline">
                            Quitar FULL
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% if p.get('variations') %}
            <tr id="inv-v-{{ loop.index }}" class="hidden bg-purple-50/30 inv-var-row">
                <td colspan="18" class="px-6 py-2">
                    <div class="text-xs">
                        <table class="w-full">
                            <thead>
                                <tr class="text-gray-500">
                                    <th class="text-left py-1 font-medium">Variacion</th>
                                    <th class="text-left py-1 font-medium">ID Variacion</th>
                                    <th class="text-left py-1 font-medium">SKU</th>
                                    <th class="text-right py-1 font-medium">Stock</th>
                                    <th class="text-right py-1 font-medium">Precio</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-purple-100">
                                {% for v in p.variations %}
                                <tr>
                                    <td class="py-1 text-gray-700">{{ v.combo }}</td>
                                    <td class="py-1 text-blue-600 font-mono text-[10px]">{{ v.id }}</td>
                                    <td class="py-1 text-gray-500 font-mono">{{ v.sku or '-' }}</td>
                                    <td class="py-1 text-right {{ 'text-green-600' if v.stock > 0 else 'text-red-500' }}">{{ v.stock }}</td>
                                    <td class="py-1 text-right text-gray-600">${{ "{:,.0f}".format(v.price) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div><!-- end desktop table -->

<!-- Pagination controls -->
{% if total_pages > 1 %}
<div class="mt-4 flex flex-col md:flex-row items-center justify-between gap-3">
    <div class="text-xs text-gray-500">
        Pagina {{ page }} de {{ total_pages }} ({{ total_count }} productos)
    </div>
    <div class="flex items-center gap-1">
        {% if page > 1 %}
        <button onclick="goToPage(1)" class="px-2 py-1.5 text-xs rounded border hover:bg-gray-50" title="Primera">&laquo;</button>
        <button onclick="goToPage({{ page - 1 }})" class="px-3 py-1.5 text-xs rounded border hover:bg-gray-50">Anterior</button>
        {% endif %}
        {% set start_pg = [1, page - 2]|max %}
        {% set end_pg = [total_pages, page + 2]|min %}
        {% for pg in range(start_pg, end_pg + 1) %}
        <button onclick="goToPage({{ pg }})"
                class="px-3 py-1.5 text-xs rounded border font-medium {{ 'bg-yellow-400 text-white border-yellow-400' if pg == page else 'hover:bg-gray-50' }}">
            {{ pg }}
        </button>
        {% endfor %}
        {% if page < total_pages %}
        <button onclick="goToPage({{ page + 1 }})" class="px-3 py-1.5 text-xs rounded border hover:bg-gray-50">Siguiente</button>
        <button onclick="goToPage({{ total_pages }})" class="px-2 py-1.5 text-xs rounded border hover:bg-gray-50" title="Ultima">&raquo;</button>
        {% endif %}
    </div>
</div>
{% else %}
<div class="mt-3 text-sm text-gray-500">
    Mostrando {{ products|length }} productos
    {% if preset == 'top' %}con ventas{% elif preset == 'stock' %}con stock BM{% elif preset == 'low' %}con 0-2 ventas{% elif preset == 'full' %}en Fulfillment{% elif preset == 'no_stock' %}sin stock{% endif %}
</div>
{% endif %}
{% else %}
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
    <p>No se encontraron productos{% if search %} para "{{ search }}"{% endif %}</p>
</div>
{% endif %}

<script>
var _invPreset = '{{ preset }}';
var _invEnrich = '{{ enrich }}';
var _invPage = {{ page }};
var _invPerPage = {{ per_page }};
var _invTotalPages = {{ total_pages }};
var _invAlertDays = {{ alert_days }};
var _alertPage = 1;
var _alertTotalPages = {{ alert_total_pages if stock_alerts else 1 }};

/* --- Alert pagination (client-side) --- */
function alertGoToPage(pg) {
    if (pg < 1 || pg > _alertTotalPages) return;
    _alertPage = pg;
    // Show/hide rows by data-alert-page
    document.querySelectorAll('.alert-row, .alert-card').forEach(function(el) {
        el.style.display = (el.dataset.alertPage == String(pg)) ? '' : 'none';
    });
    // Update page buttons
    document.querySelectorAll('.alert-pg-btn').forEach(function(btn) {
        var bpg = parseInt(btn.dataset.alertPg);
        if (bpg === pg) {
            btn.className = 'alert-pg-btn px-2 py-1 text-[10px] rounded border font-medium bg-red-600 text-white border-red-600';
        } else {
            btn.className = 'alert-pg-btn px-2 py-1 text-[10px] rounded border font-medium border-red-200 text-red-700 hover:bg-red-100';
        }
    });
    // Update prev/next
    var prevBtn = document.getElementById('alert-prev-btn');
    var nextBtn = document.getElementById('alert-next-btn');
    if (prevBtn) prevBtn.disabled = (pg <= 1);
    if (nextBtn) nextBtn.disabled = (pg >= _alertTotalPages);
    // Update info
    var info = document.getElementById('alert-page-info');
    if (info) info.textContent = 'Pag ' + pg + ' de ' + _alertTotalPages + ' ({{ stock_alerts|length }} alertas)';
}

/* --- Centralized URL builder --- */
function buildInvUrl(overrides) {
    overrides = overrides || {};
    var preset = overrides.preset || _invPreset;
    var enrich = overrides.enrich || ((['top','stock','full'].indexOf(preset) >= 0) ? 'full' : _invEnrich);
    var params = {
        preset: preset,
        enrich: enrich,
        page: overrides.page || 1,
        per_page: overrides.per_page || _invPerPage,
        alert_days: overrides.alert_days || _invAlertDays
    };
    var search = overrides.search !== undefined ? overrides.search : (document.getElementById('inv-search') ? document.getElementById('inv-search').value : '');
    if (search) params.search = search;
    var sort = overrides.sort_by || (document.getElementById('inv-sort') ? document.getElementById('inv-sort').value : '');
    if (sort) params.sort_by = sort;
    var ff = overrides.full_filter || (document.getElementById('inv-full-filter') ? document.getElementById('inv-full-filter').value : 'all');
    if (ff && ff !== 'all') params.full_filter = ff;
    var url = '/partials/products-inventory?';
    var parts = [];
    for (var k in params) { parts.push(k + '=' + encodeURIComponent(params[k])); }
    return url + parts.join('&');
}

function _navTo(url) {
    window._lastInventoryUrl = url;
    window.switchProductTab('inventory', url);
}

function toggleVariationsInv(id) {
    var row = document.getElementById(id);
    if (row) row.classList.toggle('hidden');
}

/* --- Pagination --- */
function goToPage(n) {
    _navTo(buildInvUrl({page: n}));
}
function changePerPage(n) {
    _navTo(buildInvUrl({per_page: n, page: 1}));
}
function setAlertDays(d) {
    _navTo(buildInvUrl({alert_days: d}));
}

/* --- Preset switching --- */
function switchPreset(preset) {
    _navTo(buildInvUrl({preset: preset, page: 1}));
}

/* --- Server-side search (debounce 400ms) --- */
var _searchTimer = null;
function searchTable(query) {
    clearTimeout(_searchTimer);
    _searchTimer = setTimeout(function() {
        _navTo(buildInvUrl({search: (query || '').trim(), page: 1}));
    }, 400);
}

/* --- Column toggle --- */
function toggleColumn(colName, show) {
    document.querySelectorAll('[data-col="' + colName + '"]').forEach(function(el) {
        if (show) el.classList.remove('hidden');
        else el.classList.add('hidden');
    });
    try {
        var prefs = JSON.parse(localStorage.getItem('inv_cols') || '{}');
        prefs[colName] = show;
        localStorage.setItem('inv_cols', JSON.stringify(prefs));
    } catch(e) {}
}

/* --- Restore saved column preferences --- */
(function restoreColPrefs() {
    try {
        var prefs = JSON.parse(localStorage.getItem('inv_cols') || '{}');
        var toggles = document.querySelectorAll('.col-toggle');
        toggles.forEach(function(cb) {
            var col = cb.dataset.col;
            if (col in prefs) {
                cb.checked = prefs[col];
                toggleColumn(col, prefs[col]);
            }
        });
    } catch(e) {}
})();

/* --- Sort (server-side) --- */
function applySort(sortBy) {
    _navTo(buildInvUrl({sort_by: sortBy, page: 1}));
}

/* --- FULL filter (server-side) --- */
function applyFullFilter(val) {
    _navTo(buildInvUrl({full_filter: val, page: 1}));
}

/* --- Inline price editor --- */
window.showPriceEditor = function(el, itemId, currentPrice) {
    var cell = el.closest('[data-price-cell]');
    var msgEl = cell.querySelector('[data-price-msg]');
    var displayEl = cell.querySelector('[data-price-val]');
    displayEl.style.display = 'none';

    var wrap = document.createElement('span');
    wrap.className = 'inline-flex items-center gap-1';
    wrap.setAttribute('data-price-editor', '');
    wrap.innerHTML = '<span class="text-xs text-gray-400">$</span>' +
        '<input type="number" min="1" step="1" value="' + Math.round(currentPrice) + '" ' +
        'class="w-20 px-1 py-0.5 border rounded text-xs text-right focus:ring-1 focus:ring-yellow-400 focus:outline-none">' +
        '<button class="text-green-600 hover:text-green-800 text-sm font-bold leading-none" title="Guardar">&#10003;</button>' +
        '<button class="text-gray-400 hover:text-red-500 text-sm font-bold leading-none" title="Cancelar">&#10007;</button>';
    cell.insertBefore(wrap, msgEl);

    var inp = wrap.querySelector('input');
    var okBtn = wrap.querySelectorAll('button')[0];
    var cancelBtn = wrap.querySelectorAll('button')[1];
    inp.focus();
    inp.select();

    function closeEditor() {
        wrap.remove();
        displayEl.style.display = '';
    }

    cancelBtn.onclick = closeEditor;
    okBtn.onclick = function() {
        var val = parseFloat(inp.value);
        if (isNaN(val) || val <= 0) { inp.classList.add('border-red-400'); return; }
        closeEditor();
        msgEl.textContent = '...';
        msgEl.className = 'text-[10px] text-gray-400 ml-1 inline';
        fetch('/api/items/' + itemId + '/price', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({price: val})
        })
        .then(function(r) {
            if (r.ok) {
                msgEl.textContent = 'OK';
                msgEl.className = 'text-[10px] text-green-600 ml-1 inline font-semibold';
                displayEl.textContent = '$' + val.toLocaleString('es-MX', {maximumFractionDigits: 0});
                setTimeout(function() { msgEl.textContent = ''; }, 2000);
            } else {
                return r.text().then(function(t) {
                    try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                    catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
                });
            }
        })
        .catch(function(e) {
            msgEl.textContent = e.message;
            msgEl.className = 'text-[10px] text-red-600 ml-1 inline';
        });
    };
    inp.onkeydown = function(e) {
        if (e.key === 'Enter') okBtn.onclick();
        if (e.key === 'Escape') closeEditor();
    };
};

/* --- Alert stock sync --- */
function _removeAlertRows(itemId) {
    var rowMobile = document.getElementById('alert-row-' + itemId);
    var rowDesktop = document.getElementById('alert-row-d-' + itemId);
    if (rowMobile) rowMobile.remove();
    if (rowDesktop) rowDesktop.remove();
    // Actualizar contador en encabezado
    var section = document.getElementById('alert-section');
    if (!section) return;
    var remaining = section.querySelectorAll('.alert-row, .alert-card').length;
    if (remaining === 0) { section.remove(); return; }
    var h3 = section.querySelector('h3');
    if (h3) h3.textContent = 'Ventas Perdidas: ' + remaining + ' producto' + (remaining !== 1 ? 's' : '') + ' sin stock';
    var bulkBtn = document.getElementById('bulk-sync-btn');
    if (bulkBtn && !bulkBtn.disabled) bulkBtn.textContent = 'Sincronizar todos (' + remaining + ')';
}

window.syncAlertItem = function(itemId, bmQty, btn) {
    var msgEl = document.getElementById('alert-msg-' + itemId);
    var safeQty = Math.floor(bmQty * 0.6);
    btn.disabled = true;
    btn.textContent = '...';
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: safeQty})
    })
    .then(function(r) {
        return r.text().then(function(t) {
            if (r.ok) {
                fetch('/partials/mark-synced/' + itemId, {method: 'POST', headers: {'ngrok-skip-browser-warning': 'true'}});
                _removeAlertRows(itemId);
            } else {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
            }
        });
    })
    .catch(function(e) {
        btn.disabled = false;
        var errMsg = e.message || 'Error';
        // Detectar si es error de FULL (fulfillment)
        var isFull = errMsg.toLowerCase().indexOf('fulfillment') >= 0
                  || errMsg.toLowerCase().indexOf('full') >= 0
                  || errMsg.toLowerCase().indexOf('logistic') >= 0
                  || errMsg.toLowerCase().indexOf('not modifiable') >= 0;
        if (isFull) {
            btn.textContent = 'Es FULL';
            btn.className = 'px-2 py-1 bg-orange-500 text-white rounded text-xs font-medium';
            if (msgEl) {
                msgEl.innerHTML = '⚠️ <b>Es FULL</b>: cambia a envío propio antes de actualizar stock';
                msgEl.className = 'text-[10px] text-orange-600 block mt-1';
            }
        } else {
            btn.textContent = 'Error';
            btn.className = 'px-2 py-1 bg-red-600 text-white rounded font-medium';
            if (msgEl) { msgEl.textContent = errMsg; msgEl.className = 'text-[10px] ml-1 text-red-600'; }
        }
    });
};

// Cambiar de FULL a envio propio y luego sincronizar stock BM
window.changeToMerchantAndSync = function(itemId, bmQty, btn) {
    var msgEl = document.getElementById('alert-msg-' + itemId);
    if (!confirm('¿Cambiar "' + itemId + '" de FULL a envío propio?\n\n' +
                 '• El producto dejará de estar en el centro de distribución de MeLi\n' +
                 '• El envío pasa a ser responsabilidad tuya\n' +
                 '• Después se sincronizará el stock BM automáticamente')) return;
    btn.disabled = true;
    btn.textContent = 'Quitando FULL...';
    if (msgEl) { msgEl.textContent = 'Cambiando a envío propio...'; msgEl.className = 'text-[10px] text-orange-600'; }

    // Paso 1: cambiar logística a xd_drop_off (self service)
    fetch('/api/items/' + itemId + '/shipping', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({logistic_type: 'xd_drop_off'})
    })
    .then(function(r) {
        return r.text().then(function(t) {
            if (!r.ok) {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error al cambiar logistica: ' + r.status); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
            }
        });
    })
    .then(function() {
        // Paso 2: sincronizar stock BM
        if (msgEl) { msgEl.textContent = 'Logística cambiada. Sincronizando stock...'; }
        btn.textContent = 'Sync Stock...';
        var safeQty = Math.floor(bmQty * 0.6);
        return fetch('/api/items/' + itemId + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: safeQty})
        }).then(function(r2) {
            return r2.text().then(function(t2) {
                if (!r2.ok) {
                    // Si falla el stock, al menos informar que la logística cambió
                    try { var d2 = JSON.parse(t2); throw new Error('Logística OK, stock falló: ' + (d2.detail || r2.status)); }
                    catch(pe) { if (pe.message && pe.message !== t2) throw pe; throw new Error('Logística OK, stock falló: ' + t2); }
                }
            });
        });
    })
    .then(function() {
        fetch('/partials/mark-synced/' + itemId, {method: 'POST', headers: {'ngrok-skip-browser-warning': 'true'}});
        _removeAlertRows(itemId);
    })
    .catch(function(e) {
        btn.disabled = false;
        btn.textContent = 'Error';
        btn.className = 'px-2 py-1 bg-red-600 text-white rounded text-xs font-medium';
        if (msgEl) { msgEl.textContent = e.message; msgEl.className = 'text-[10px] text-red-600 block mt-1'; }
    });
};

window.bulkSyncAlerts = function() {
    var alertData = [
        {% for a in stock_alerts %}
        {id: '{{ a.id }}', qty: {{ a.get('_bm_total', 0) }}, is_full: {{ 'true' if a.get('is_full') else 'false' }} }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ];
    // Filtrar FULL — no se pueden sincronizar en bulk
    var fullItems = alertData.filter(function(x) { return x.is_full; });
    var syncableItems = alertData.filter(function(x) { return !x.is_full; });
    if (fullItems.length > 0 && syncableItems.length === 0) {
        alert('Todos los productos en alerta son FULL.\nDebe cambiarlos a envío propio individualmente antes de sincronizar el stock.');
        return;
    }
    if (fullItems.length > 0) {
        var msg = document.getElementById('bulk-sync-msg');
        if (msg) { msg.textContent = fullItems.length + ' producto(s) FULL se omitirán (requieren cambio manual a envío propio)'; msg.className = 'text-xs mt-1 block text-center text-orange-600'; }
    }
    alertData = syncableItems;
    var btn = document.getElementById('bulk-sync-btn');
    var msg = document.getElementById('bulk-sync-msg');
    btn.disabled = true;
    btn.textContent = 'Sincronizando...';
    var done = 0, errors = 0, total = alertData.length;

    function updateProgress() {
        msg.textContent = 'Progreso: ' + done + '/' + total + (errors > 0 ? ' (' + errors + ' errores)' : '');
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }

    alertData.forEach(function(item) {
        fetch('/api/items/' + item.id + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: item.qty})
        })
        .then(function(r) {
            done++;
            if (!r.ok) errors++;
            else {
                // Marcar en servidor y quitar del DOM
                fetch('/partials/mark-synced/' + item.id, {method: 'POST', headers: {'ngrok-skip-browser-warning': 'true'}});
                _removeAlertRows(item.id);
            }
            updateProgress();
            if (done === total) {
                btn.textContent = 'Completado';
                btn.className = 'flex-shrink-0 px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg';
                setTimeout(function() {
                    var activeBtn = document.querySelector('.tab-btn.bg-yellow-50');
                    if (activeBtn) activeBtn.click();
                }, 2000);
            }
        })
        .catch(function() {
            done++;
            errors++;
            updateProgress();
        });
    });
};

/* --- Refresh cache --- */
window.refreshCache = function(btn) {
    btn.disabled = true;
    btn.querySelector('svg').classList.add('animate-spin');
    fetch('/api/cache/invalidate-products', {
        method: 'POST',
        headers: {'ngrok-skip-browser-warning': 'true'}
    })
    .then(function() {
        _navTo(buildInvUrl({page: 1}));
    })
    .catch(function() {
        btn.disabled = false;
        btn.querySelector('svg').classList.remove('animate-spin');
    });
};

/* --- Deal cell update (called from modal) --- */
window.updateDealCell = function(itemId, hasDeal, newPrice, originalPrice) {
    var row = document.querySelector('tr[data-id="' + itemId + '"]');
    if (!row) return;
    var cell = row.querySelector('[data-deal-cell]');
    if (!cell) return;
    if (hasDeal && originalPrice > 0) {
        var disc = Math.round((1 - newPrice / originalPrice) * 100);
        cell.innerHTML = '<div class="flex flex-col items-center">' +
            '<span class="text-[10px] text-gray-400 line-through">$' + Math.round(originalPrice).toLocaleString('es-MX') + '</span>' +
            '<span class="text-xs font-bold text-green-600">$' + Math.round(newPrice).toLocaleString('es-MX') + '</span>' +
            '<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 text-green-700 mt-0.5">-' + disc + '%</span>' +
            '</div>';
    } else {
        cell.innerHTML = '<span class="text-xs text-gray-400">Sin deal</span>';
    }
};

/* --- Open Deal action (loads deal partial in edit modal) --- */
window.openDealAction = function(itemId, price, sku, title, originalPrice, thumb) {
    var modal = document.getElementById('edit-modal');
    var content = document.getElementById('edit-modal-content');
    modal.classList.remove('hidden');
    content.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 mx-auto mb-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Cargando deals...</div>';

    // Set up callback for deal changes (called from modal)
    window._onDealChange = function(hasDeal, dealPrice, origPrice) {
        window.updateDealCell(itemId, hasDeal, dealPrice, origPrice);
    };

    fetch('/partials/item-deal/' + itemId, {headers: {'ngrok-skip-browser-warning': 'true'}})
        .then(function(r) { return r.text(); })
        .then(function(html) {
            content.innerHTML = html;
            content.querySelectorAll('script').forEach(function(oldScript) {
                var newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        })
        .catch(function() { content.innerHTML = '<p class="text-center text-red-500 py-4">Error cargando deal info</p>'; });
};

/* --- Save last URL for tab persistence --- */
window._lastInventoryUrl = buildInvUrl({page: _invPage});
</script>

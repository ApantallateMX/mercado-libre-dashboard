<!-- KPIs -->
<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
    <div onclick="document.getElementById('restock-section').scrollIntoView({behavior:'smooth'})"
         class="bg-white rounded-lg shadow p-4 border-l-4 border-orange-400 cursor-pointer hover:shadow-md hover:bg-orange-50/30 transition">
        <p class="text-xs text-gray-500">Sin Stock (con BM)</p>
        <p class="text-2xl font-bold text-orange-600">{{ restock_count }}</p>
        <p class="text-[10px] text-gray-400">Con ventas recientes</p>
    </div>
    <div onclick="document.getElementById('restock-section').scrollIntoView({behavior:'smooth'})"
         class="bg-white rounded-lg shadow p-4 border-l-4 border-orange-400 cursor-pointer hover:shadow-md hover:bg-orange-50/30 transition">
        <p class="text-xs text-gray-500">Revenue Perdido (30d)</p>
        <p class="text-2xl font-bold text-orange-600">${{ "{:,.0f}".format(lost_revenue) }}</p>
        <p class="text-[10px] text-gray-400">Click para ver</p>
    </div>
    <div onclick="document.getElementById('risk-section').scrollIntoView({behavior:'smooth'})"
         class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-400 cursor-pointer hover:shadow-md hover:bg-yellow-50/30 transition">
        <p class="text-xs text-gray-500">Riesgo Sobreventa</p>
        <p class="text-2xl font-bold text-yellow-600">{{ risk_count }}</p>
        <p class="text-[10px] text-gray-400">{{ risk_stock }} unidades en riesgo</p>
    </div>
    <div onclick="document.getElementById('activate-section').scrollIntoView({behavior:'smooth'})"
         class="bg-white rounded-lg shadow p-4 border-l-4 border-green-400 cursor-pointer hover:shadow-md hover:bg-green-50/30 transition">
        <p class="text-xs text-gray-500">Oportunidad Activar</p>
        <p class="text-2xl font-bold text-green-600">{{ activate_count }}</p>
        <p class="text-[10px] text-gray-400">MeLi=0, BM disponible</p>
    </div>
    <div onclick="document.getElementById('activate-section').scrollIntoView({behavior:'smooth'})"
         class="bg-white rounded-lg shadow p-4 border-l-4 border-green-400 cursor-pointer hover:shadow-md hover:bg-green-50/30 transition">
        <p class="text-xs text-gray-500">Stock BM Disponible</p>
        <p class="text-2xl font-bold text-green-600">{{ activate_stock }}</p>
        <p class="text-[10px] text-gray-400">Unidades para activar</p>
    </div>
    <div onclick="document.getElementById('critical-section').scrollIntoView({behavior:'smooth'})"
         class="bg-white rounded-lg shadow p-4 border-l-4 border-red-400 cursor-pointer hover:shadow-md hover:bg-red-50/30 transition">
        <p class="text-xs text-gray-500">Stock Cr√≠tico (&lt;{{ threshold }})</p>
        <p class="text-2xl font-bold text-red-600">{{ critical_count }}</p>
        <p class="text-[10px] text-gray-400">{{ critical_bm_total }} uds. BM disponible</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-gray-300">
        <p class="text-xs text-gray-500">Total Alertas</p>
        <p class="text-2xl font-bold text-gray-700">{{ restock_count + risk_count + activate_count + critical_count }}</p>
        <p class="text-[10px] text-gray-400">Acciones pendientes</p>
    </div>
</div>

<!-- ===== Seccion A: Reabastecer ===== -->
<div class="mb-8" id="restock-section">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <div class="w-1 h-6 bg-orange-400 rounded"></div>
            <h3 class="text-sm md:text-base font-bold text-gray-800">Reabastecer</h3>
            <span class="text-xs text-gray-400">(MeLi=0, BM disponible)</span>
        </div>
        {% if restock %}
        <button onclick="bulkSyncRestock()" id="bulk-restock-btn"
                class="px-3 py-1.5 bg-purple-600 text-white text-xs font-bold rounded-lg hover:bg-purple-700 active:bg-purple-800 transition">
            Sincronizar Todos ({{ restock|length }})
        </button>
        {% endif %}
    </div>

    {% if restock %}
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2">
        {% for p in restock %}
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-orange-300" id="restock-m-{{ p.id }}">
            <div class="flex gap-3">
                {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="w-12 h-12 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-2">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                <div>
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </div>
                <div><span class="text-gray-500">Ventas:</span> <span class="font-bold">{{ p.get('units', 0) }}</span></div>
                <div><span class="text-gray-500">MeLi:</span> <span class="font-bold text-red-600">0</span></div>
                <div><span class="text-gray-500">BM Disp:</span> <span class="font-bold text-green-600">{{ p.get('_bm_avail', 0) }}</span>{% if p.get('_bm_reserved', 0) > 0 %} <span class="text-[10px] text-orange-500">Res:{{ p._bm_reserved }}</span>{% endif %}</div>
                {% if p.get('_bm_mty') is not none %}
                <div class="text-[10px] text-gray-400">MTY:{{ p._bm_mty }} CDMX:{{ p.get('_bm_cdmx', 0) }} TJ:{{ p.get('_bm_tj', 0) }}</div>
                {% endif %}
            </div>
            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100 flex-wrap">
                {% if p.get('is_full') %}
                <div class="flex-1 flex flex-col gap-1">
                    <span class="flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-[10px] font-semibold">
                        ‚ö†Ô∏è FULL ‚Äî cambia log√≠stica en Seller Center primero
                    </span>
                    <div class="flex gap-1">
                        <a href="https://articulo.mercadolibre.com.mx/{{ p.id | replace('MLM', 'MLM-') }}" target="_blank"
                           class="flex-1 py-1.5 text-center text-xs bg-blue-500 text-white rounded-lg font-medium">
                            Ver en MeLi ‚Üó
                        </a>
                        <button onclick="syncFullItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                                class="flex-1 py-1.5 text-xs bg-orange-500 text-white rounded-lg font-medium active:bg-orange-600">
                            Ya cambi√© ‚Üí Sync
                        </button>
                    </div>
                </div>
                {% elif p.get('has_variations') %}
                <button onclick="syncVariationStocks('{{ p.id }}', this)"
                        data-variations='{{ p.variations | tojson }}'
                        class="flex-1 py-1.5 text-xs bg-indigo-600 text-white rounded-lg font-medium active:bg-indigo-700 min-h-[36px]"
                        title="Sincroniza cada variacion con su propio SKU en BM (seguro)">
                    Sync Var. ({{ p.variations|length }})
                </button>
                {% else %}
                <button onclick="syncRestockItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                        class="flex-1 py-1.5 text-xs bg-purple-600 text-white rounded-lg font-medium active:bg-purple-700 min-h-[36px]">
                    Sync 60%
                </button>
                {% endif %}
                <button onclick="openEditModal('{{ p.id }}')"
                        class="flex-1 py-1.5 text-xs bg-gray-200 text-gray-700 rounded-lg font-medium active:bg-gray-300 min-h-[36px]">
                    Editar
                </button>
                <span id="restock-msg-{{ p.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-orange-50 border-b">
                <tr>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">Producto</th>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">ID / SKU</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Precio</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Retail USD</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Ventas 30d</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Stock MeLi</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">BM Disponible</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">MTY</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">CDMX</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">TJ</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for p in restock %}
                <tr class="hover:bg-orange-50/30" id="restock-d-{{ p.id }}">
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            {% if p.thumbnail %}
                            <img src="{{ p.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <div>
                                <span class="text-gray-800 truncate max-w-[200px] text-xs block" title="{{ p.title }}">{{ p.title[:50] }}</span>
                                {% if p.get('has_variations') %}
                                <span class="text-[10px] text-indigo-600 font-medium cursor-pointer underline decoration-dotted"
                                      data-variations='{{ p.variations | tojson }}'
                                      onclick="showVarStockPanel('{{ p.id }}', this)"
                                      title="Ver stock por variacion">{{ p.variations|length }} variaciones üëÅ</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-blue-600 font-mono font-semibold">{{ p.id }}</span>
                            <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.original_price and p.original_price > p.price %}
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        {% else %}
                        <span class="text-xs font-semibold text-gray-700">${{ "{:,.0f}".format(p.price) }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.get('_bm_retail_price') and p._bm_retail_price > 0 and p._bm_retail_price < 9999 %}
                        <span class="text-xs text-blue-600 font-mono">${{ "{:,.0f}".format(p._bm_retail_price) }}</span>
                        {% else %}
                        <span class="text-xs text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-gray-800">{{ p.get('units', 0) }}</td>
                    <td class="px-3 py-2 text-right font-bold text-red-600">{{ p.get('available_quantity', 0) }}</td>
                    <td class="px-3 py-2 text-right font-bold {{ 'text-green-600' if p.get('_bm_avail', 0) > 0 else 'text-gray-400' }}">
                        {% if p.get('has_variations') %}
                        <span class="text-indigo-500 text-[10px] cursor-pointer underline decoration-dotted"
                              data-variations='{{ p.variations | tojson }}'
                              onclick="showVarStockPanel('{{ p.id }}', this)"
                              title="Ver stock BM por variacion">por var. üëÅ</span>
                        {% else %}
                        {{ p.get('_bm_avail', 0) }}
                        {% if p.get('_bm_reserved', 0) > 0 %}<div class="text-[10px] text-orange-500 font-normal">Res:{{ p._bm_reserved }}</div>{% endif %}
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_mty', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_cdmx', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_tj') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_tj', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-center">
                        {% if p.get('is_full') %}
                        <div class="flex flex-col items-center gap-1">
                            <span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px] font-semibold whitespace-nowrap">‚ö†Ô∏è FULL</span>
                            <a href="https://articulo.mercadolibre.com.mx/{{ p.id | replace('MLM', 'MLM-') }}" target="_blank"
                               class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs font-medium whitespace-nowrap">Ver en MeLi ‚Üó</a>
                            <button onclick="syncFullItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                                    class="px-2 py-1 bg-orange-500 text-white rounded hover:bg-orange-600 text-xs font-medium whitespace-nowrap">
                                Ya cambi√© ‚Üí Sync
                            </button>
                            <span id="restock-msg-d-{{ p.id }}" class="text-[10px]"></span>
                        </div>
                        {% else %}
                        <div class="flex items-center justify-center gap-1">
                            {% if p.get('has_variations') %}
                            <button onclick="syncVariationStocks('{{ p.id }}', this)"
                                    data-variations='{{ p.variations | tojson }}'
                                    class="px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-xs font-medium transition"
                                    title="Sync seguro por variacion">
                                Sync Var.
                            </button>
                            {% else %}
                            <button onclick="syncRestockItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                                    class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs font-medium transition">
                                Sync 60%
                            </button>
                            {% endif %}
                            <button onclick="openEditModal('{{ p.id }}')"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs font-medium transition">
                                Editar
                            </button>
                            <span id="restock-msg-d-{{ p.id }}" class="text-[10px] ml-1"></span>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">
        Todos los productos con ventas tienen stock en MeLi
    </div>
    {% endif %}
    <span id="bulk-restock-msg" class="text-xs mt-2 block text-center"></span>
</div>

<!-- ===== Seccion B: Riesgo Sobreventa ===== -->
<div class="mb-8" id="risk-section">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <div class="w-1 h-6 bg-yellow-400 rounded"></div>
            <h3 class="text-sm md:text-base font-bold text-gray-800">Riesgo Sobreventa</h3>
            <span class="text-xs text-gray-400">(MeLi>0, BM=0, no FULL)</span>
        </div>
        {% if oversell_risk %}
        <div class="flex gap-2">
            <button onclick="bulkStockZeroRisk()" id="bulk-zero-btn"
                    class="px-3 py-1.5 bg-red-500 text-white text-xs font-bold rounded-lg hover:bg-red-600 active:bg-red-700 transition">
                Stock -> 0 Todos ({{ oversell_risk|length }})
            </button>
            <button onclick="bulkPauseRisk()" id="bulk-pause-btn"
                    class="px-3 py-1.5 bg-yellow-500 text-white text-xs font-bold rounded-lg hover:bg-yellow-600 active:bg-yellow-700 transition">
                Pausar Todos ({{ oversell_risk|length }})
            </button>
        </div>
        {% endif %}
    </div>

    {% if oversell_risk %}
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2">
        {% for p in oversell_risk %}
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-yellow-300" id="risk-m-{{ p.id }}">
            <div class="flex gap-3">
                {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="w-12 h-12 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-2">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                <div>
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </div>
                <div>
                    <span class="text-gray-500">MeLi:</span>
                    {% if p.get('has_variations') %}
                    <span class="text-indigo-500 text-[10px] cursor-pointer underline decoration-dotted"
                          data-variations='{{ p.variations | tojson }}'
                          onclick="showVarStockPanel('{{ p.id }}', this)"
                          title="Ver stock MeLi por variacion">por var. üëÅ</span>
                    {% else %}
                    <span class="font-bold text-yellow-600">{{ p.available_quantity }}</span>
                    {% endif %}
                </div>
                <div><span class="text-gray-500">BM:</span> <span class="font-bold text-red-600">{{ p.get('_bm_total', 0) or 0 }}</span></div>
                <div><span class="text-gray-500">Ventas:</span> <span class="font-bold">{{ p.get('units', 0) }}</span></div>
            </div>
            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                {% if p.get('has_variations') %}
                <!-- Multi-variacion: NO poner todo en 0; usar sync por variacion -->
                <button onclick="syncVariationStocks('{{ p.id }}', this)"
                        data-variations='{{ p.variations | tojson }}'
                        class="flex-1 py-1.5 text-xs bg-indigo-600 text-white rounded-lg font-medium active:bg-indigo-700 min-h-[36px]"
                        title="Sincroniza cada variacion con su propio stock BM">
                    Sync Var. ({{ p.variations|length }})
                </button>
                {% else %}
                <button onclick="setStockZero('{{ p.id }}', this)"
                        class="flex-1 py-1.5 text-xs bg-red-500 text-white rounded-lg font-medium active:bg-red-600 min-h-[36px]">
                    Stock -> 0
                </button>
                {% endif %}
                <button onclick="pauseItem('{{ p.id }}', this)"
                        class="flex-1 py-1.5 text-xs bg-yellow-500 text-white rounded-lg font-medium active:bg-yellow-600 min-h-[36px]">
                    Pausar
                </button>
                <span id="risk-msg-{{ p.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-yellow-50 border-b">
                <tr>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">Producto</th>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">ID / SKU</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Precio</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Retail USD</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Stock MeLi</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">BM Disponible</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Ventas 30d</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for p in oversell_risk %}
                <tr class="{{ 'bg-indigo-50/40' if p.get('has_variations') else 'hover:bg-yellow-50/30' }}" id="risk-d-{{ p.id }}">
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            {% if p.thumbnail %}
                            <img src="{{ p.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <div>
                                <span class="text-gray-800 truncate max-w-[200px] text-xs block" title="{{ p.title }}">{{ p.title[:50] }}</span>
                                {% if p.get('has_variations') %}
                                <span class="text-[10px] text-indigo-600 font-medium cursor-pointer underline decoration-dotted"
                                      data-variations='{{ p.variations | tojson }}'
                                      onclick="showVarStockPanel('{{ p.id }}', this)"
                                      title="Ver stock por variacion">{{ p.variations|length }} variaciones üëÅ</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-blue-600 font-mono font-semibold">{{ p.id }}</span>
                            <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.original_price and p.original_price > p.price %}
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        {% else %}
                        <span class="text-xs font-semibold text-gray-700">${{ "{:,.0f}".format(p.price) }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.get('_bm_retail_price') and p._bm_retail_price > 0 and p._bm_retail_price < 9999 %}
                        <span class="text-xs text-blue-600 font-mono">${{ "{:,.0f}".format(p._bm_retail_price) }}</span>
                        {% else %}
                        <span class="text-xs text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-yellow-600">
                        {% if p.get('has_variations') %}
                        <span class="text-indigo-500 text-[10px] font-normal cursor-pointer underline decoration-dotted"
                              data-variations='{{ p.variations | tojson }}'
                              onclick="showVarStockPanel('{{ p.id }}', this)"
                              title="Ver stock MeLi por variacion">por var. üëÅ</span>
                        {% else %}
                        {{ p.available_quantity }}
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-red-600">
                        {% if p.get('has_variations') %}
                        <span class="text-indigo-500 text-[10px] font-normal cursor-pointer underline decoration-dotted"
                              data-variations='{{ p.variations | tojson }}'
                              onclick="showVarStockPanel('{{ p.id }}', this)"
                              title="Ver stock BM por variacion">por var. üëÅ</span>
                        {% else %}
                        {{ p.get('_bm_avail', 0) or 0 }}
                        {% if p.get('_bm_reserved', 0) > 0 %}<div class="text-[10px] text-orange-500 font-normal">Res:{{ p._bm_reserved }}</div>{% endif %}
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-gray-800">{{ p.get('units', 0) }}</td>
                    <td class="px-3 py-2 text-center">
                        <div class="flex items-center justify-center gap-1 flex-wrap">
                            {% if p.get('has_variations') %}
                            <button onclick="syncVariationStocks('{{ p.id }}', this)"
                                    data-variations='{{ p.variations | tojson }}'
                                    class="px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-xs font-medium transition"
                                    title="Sync por variacion ‚Äî seguro">
                                Sync Var.
                            </button>
                            {% else %}
                            <button onclick="setStockZero('{{ p.id }}', this)"
                                    class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs font-medium transition">
                                Stock -> 0
                            </button>
                            {% endif %}
                            <button onclick="pauseItem('{{ p.id }}', this)"
                                    class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs font-medium transition">
                                Pausar
                            </button>
                            <span id="risk-msg-d-{{ p.id }}" class="text-[10px] ml-1"></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">
        No hay productos con riesgo de sobreventa
    </div>
    {% endif %}
    <span id="bulk-pause-msg" class="text-xs mt-2 block text-center"></span>
</div>

<!-- ===== Seccion D: Stock Cr√≠tico ===== -->
<div class="mb-8" id="critical-section">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <div class="w-1 h-6 bg-red-400 rounded"></div>
            <h3 class="text-sm md:text-base font-bold text-gray-800">Stock Cr√≠tico</h3>
            <span class="text-xs text-gray-400">(MeLi activo, BM &lt; {{ threshold }} uds.)</span>
        </div>
        {% if critical %}
        <button onclick="bulkConcentrateCritical()" id="bulk-critical-btn"
                class="px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded-lg hover:bg-red-700 active:bg-red-800 transition">
            Concentrar An√°lisis ({{ critical|length }})
        </button>
        {% endif %}
    </div>

    {% if critical %}
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2">
        {% for p in critical %}
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-red-300" id="crit-m-{{ p.id }}">
            <div class="flex gap-3">
                {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="w-12 h-12 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-2">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                <div>
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </div>
                {% if p.get('_bm_retail_price') and p._bm_retail_price > 0 and p._bm_retail_price < 9999 %}
                <div><span class="text-gray-500">Retail:</span> <span class="font-bold text-blue-600">${{ "{:,.0f}".format(p._bm_retail_price) }}</span></div>
                {% endif %}
                <div><span class="text-gray-500">Ventas:</span> <span class="font-bold">{{ p.get('units', 0) }}</span></div>
                <div><span class="text-gray-500">MeLi:</span> <span class="font-bold text-yellow-600">{{ p.available_quantity }}</span></div>
                <div><span class="text-gray-500">BM Disp:</span> <span class="font-bold text-red-600">{{ p.get('_bm_avail', 0) }}</span></div>
                {% if p.get('_bm_mty') is not none %}
                <div class="text-[10px] text-gray-400">MTY:{{ p._bm_mty }} CDMX:{{ p.get('_bm_cdmx', 0) }}</div>
                {% endif %}
            </div>
            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                {% if p.sku %}
                <button onclick="concentrateItem('{{ p.sku }}', '{{ p.title[:40] }}', {{ p.get('_bm_avail', 0) }}, this)"
                        class="flex-1 py-1.5 text-xs bg-red-600 text-white rounded-lg font-medium active:bg-red-700 min-h-[36px]">
                    Concentrar
                </button>
                {% endif %}
                <button onclick="syncRestockItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                        class="flex-1 py-1.5 text-xs bg-purple-600 text-white rounded-lg font-medium active:bg-purple-700 min-h-[36px]">
                    Sync BM
                </button>
                <span id="crit-msg-{{ p.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-red-50 border-b">
                <tr>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">Producto</th>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">ID / SKU</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Precio</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Retail USD</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Ventas 30d</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Stock MeLi</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">BM Disp.</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">MTY</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">CDMX</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for p in critical %}
                <tr class="hover:bg-red-50/30" id="crit-d-{{ p.id }}">
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            {% if p.thumbnail %}
                            <img src="{{ p.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <span class="text-gray-800 truncate max-w-[200px] text-xs" title="{{ p.title }}">{{ p.title[:50] }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-blue-600 font-mono font-semibold">{{ p.id }}</span>
                            <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.original_price and p.original_price > p.price %}
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        {% else %}
                        <span class="text-xs font-semibold text-gray-700">${{ "{:,.0f}".format(p.price) }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.get('_bm_retail_price') and p._bm_retail_price > 0 and p._bm_retail_price < 9999 %}
                        <span class="text-xs text-blue-600 font-mono">${{ "{:,.0f}".format(p._bm_retail_price) }}</span>
                        {% else %}
                        <span class="text-xs text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-gray-800">{{ p.get('units', 0) }}</td>
                    <td class="px-3 py-2 text-right font-bold text-yellow-600">{{ p.available_quantity }}</td>
                    <td class="px-3 py-2 text-right">
                        <span class="font-bold {{ 'text-red-600' if (p.get('_bm_avail') or 0) <= 3 else 'text-orange-500' }}">{{ p.get('_bm_avail', 0) }}</span>
                    </td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_mty', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_cdmx', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-center">
                        <div class="flex items-center justify-center gap-1 flex-wrap">
                            {% if p.sku %}
                            <button onclick="concentrateItem('{{ p.sku }}', '{{ p.title[:30]|replace("'","") }}', {{ p.get('_bm_avail', 0) }}, this)"
                                    class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs font-medium transition">
                                Concentrar
                            </button>
                            {% endif %}
                            <button onclick="syncRestockItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                                    class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs font-medium transition">
                                Sync BM
                            </button>
                            <span id="crit-msg-d-{{ p.id }}" class="text-[10px] ml-1"></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">
        No hay productos con stock cr√≠tico (BM &lt; {{ threshold }} unidades activas en MeLi)
    </div>
    {% endif %}
    <span id="bulk-critical-msg" class="text-xs mt-2 block text-center"></span>
</div>

<!-- ===== Seccion C: Activar ===== -->
<div class="mb-6" id="activate-section">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <div class="w-1 h-6 bg-green-400 rounded"></div>
            <h3 class="text-sm md:text-base font-bold text-gray-800">Activar</h3>
            <span class="text-xs text-gray-400">(MeLi=0, BM disponible, sin ventas recientes)</span>
        </div>
        {% if activate %}
        <button onclick="bulkActivateAll()" id="bulk-activate-btn"
                class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 active:bg-green-800 transition">
            Activar Todos ({{ activate|length }})
        </button>
        {% endif %}
    </div>

    {% if activate %}
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2">
        {% for p in activate %}
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-green-300" id="act-m-{{ p.id }}">
            <div class="flex gap-3">
                {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="w-12 h-12 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-2">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                <div>
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </div>
                <div><span class="text-gray-500">MeLi:</span> <span class="font-bold text-red-600">0</span></div>
                <div><span class="text-gray-500">BM Disp:</span> <span class="font-bold text-green-600">{{ p.get('_bm_avail', 0) }}</span>{% if p.get('_bm_reserved', 0) > 0 %} <span class="text-[10px] text-orange-500">Res:{{ p._bm_reserved }}</span>{% endif %}</div>
                {% if p.get('_bm_mty') is not none %}
                <div class="text-[10px] text-gray-400">MTY:{{ p._bm_mty }} CDMX:{{ p.get('_bm_cdmx', 0) }} TJ:{{ p.get('_bm_tj', 0) }}</div>
                {% endif %}
                <div>
                    <span class="text-gray-500">Status:</span>
                    <span class="font-bold {{ 'text-yellow-600' if p.status == 'paused' else 'text-gray-600' }}">{{ p.status }}</span>
                </div>
            </div>
            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                <button onclick="activateItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, '{{ p.status }}', this)"
                        class="flex-1 py-1.5 text-xs bg-green-600 text-white rounded-lg font-medium active:bg-green-700 min-h-[36px]">
                    Sync + Activar
                </button>
                <button onclick="openEditModal('{{ p.id }}')"
                        class="flex-1 py-1.5 text-xs bg-gray-200 text-gray-700 rounded-lg font-medium active:bg-gray-300 min-h-[36px]">
                    Editar
                </button>
                <span id="act-msg-{{ p.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-green-50 border-b">
                <tr>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">Producto</th>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">ID / SKU</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Precio</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Retail USD</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Status</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">BM Disponible</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">MTY</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">CDMX</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">TJ</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for p in activate %}
                <tr class="hover:bg-green-50/30" id="act-d-{{ p.id }}">
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            {% if p.thumbnail %}
                            <img src="{{ p.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <span class="text-gray-800 truncate max-w-[200px] text-xs" title="{{ p.title }}">{{ p.title[:50] }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-blue-600 font-mono font-semibold">{{ p.id }}</span>
                            <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.original_price and p.original_price > p.price %}
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        {% else %}
                        <span class="text-xs font-semibold text-gray-700">${{ "{:,.0f}".format(p.price) }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.get('_bm_retail_price') and p._bm_retail_price > 0 and p._bm_retail_price < 9999 %}
                        <span class="text-xs text-blue-600 font-mono">${{ "{:,.0f}".format(p._bm_retail_price) }}</span>
                        {% else %}
                        <span class="text-xs text-gray-300">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-center">
                        {% if p.status == 'paused' %}
                        <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full text-[10px] font-medium">Pausado</span>
                        {% elif p.status == 'active' %}
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-[10px] font-medium">Activo</span>
                        {% else %}
                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-[10px] font-medium">{{ p.status }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-green-600">{{ p.get('_bm_avail', 0) }}{% if p.get('_bm_reserved', 0) > 0 %}<div class="text-[10px] text-orange-500 font-normal">Res:{{ p._bm_reserved }}</div>{% endif %}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_mty', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_cdmx', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_tj') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_tj', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="activateItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, '{{ p.status }}', this)"
                                    class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-medium transition">
                                Sync + Activar
                            </button>
                            <button onclick="openEditModal('{{ p.id }}')"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs font-medium transition">
                                Editar
                            </button>
                            <span id="act-msg-d-{{ p.id }}" class="text-[10px] ml-1"></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">
        No hay productos para activar (todos los productos con stock BM ya estan activos en MeLi)
    </div>
    {% endif %}
    <span id="bulk-activate-msg" class="text-xs mt-2 block text-center"></span>
</div>

<script>
// --- Helpers ---
function _updateSectionCounts() {
    var rCount = document.querySelectorAll('[id^="restock-d-"]').length;
    var kCount = document.querySelectorAll('[id^="risk-d-"]').length;
    var aCount = document.querySelectorAll('[id^="act-d-"]').length;
    var rb = document.getElementById('bulk-restock-btn');
    if (rb) rb.textContent = 'Sincronizar Todos (' + rCount + ')';
    var zb = document.getElementById('bulk-zero-btn');
    if (zb) zb.textContent = 'Stock -> 0 Todos (' + kCount + ')';
    var pb = document.getElementById('bulk-pause-btn');
    if (pb) pb.textContent = 'Pausar Todos (' + kCount + ')';
    var ab = document.getElementById('bulk-activate-btn');
    if (ab) ab.textContent = 'Activar Todos (' + aCount + ')';
}

function _removeStockRows(itemId) {
    ['restock-m', 'restock-d', 'risk-m', 'risk-d', 'crit-m', 'crit-d', 'act-m', 'act-d'].forEach(function(pfx) {
        var r = document.getElementById(pfx + '-' + itemId);
        if (r) {
            r.style.transition = 'opacity 0.4s';
            r.style.opacity = '0';
            setTimeout(function() {
                if (r.parentNode) r.parentNode.removeChild(r);
                _updateSectionCounts();
            }, 450);
        }
    });
}

// Helper FULL: sync stock directo (para cuando ya se cambi√≥ log√≠stica en Seller Center)
function _setFullMsg(itemId, msg, cls) {
    document.querySelectorAll('[id="restock-msg-' + itemId + '"],[id="restock-msg-d-' + itemId + '"]').forEach(function(el) {
        el.textContent = msg; el.className = cls;
    });
}
window.syncFullItem = function(itemId, bmQty, btn) {
    btn.disabled = true;
    btn.textContent = 'Sincronizando...';
    var safeQty = Math.floor(bmQty * 0.6);
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: safeQty})
    })
    .then(function(r) {
        return r.text().then(function(t) {
            if (!r.ok) {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error ' + r.status); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error('Error ' + r.status); }
            }
        });
    })
    .then(function() { setTimeout(function() { _removeStockRows(itemId); }, 800); })
    .catch(function(e) {
        btn.disabled = false;
        btn.textContent = 'Ya cambi√© ‚Üí Sync';
        var errMsg = e.message || 'Error';
        _setFullMsg(itemId, errMsg, 'text-[10px] text-red-600 block mt-1');
        var isFull = errMsg.toLowerCase().indexOf('cannot update') >= 0 || errMsg.toLowerCase().indexOf('not modifiable') >= 0;
        alert(isFull
            ? 'El item sigue siendo FULL en MeLi.\n\nPasos:\n1. Clic en "Ver en MeLi ‚Üó"\n2. Editar ‚Üí cambiar log√≠stica a "Env√≠o por cuenta propia"\n3. Guardar en MeLi\n4. Volver aqu√≠ y clic en "Ya cambi√© ‚Üí Sync"'
            : 'Error al sincronizar ' + itemId + ':\n' + errMsg);
    });
};

// --- Restock: sync 60% of BM total ---
function syncRestockItem(itemId, bmTotal, btn) {
    var safeQty = Math.floor(bmTotal * 0.6);
    btn.disabled = true;
    btn.textContent = '...';
    var msgEl = document.getElementById('restock-msg-' + itemId) || document.getElementById('restock-msg-d-' + itemId);
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: safeQty})
    })
    .then(function(r) {
        if (r.ok) {
            btn.textContent = 'OK (' + safeQty + ')';
            if (msgEl) { msgEl.textContent = 'Stock: ' + safeQty; msgEl.className = 'text-[10px] ml-1 text-green-600 font-semibold'; }
            setTimeout(function() { _removeStockRows(itemId); }, 1000);
        } else {
            return r.text().then(function(t) {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
            });
        }
    })
    .catch(function(e) {
        btn.textContent = 'Error';
        btn.disabled = false;
        if (msgEl) { msgEl.textContent = e.message; msgEl.className = 'text-[10px] ml-1 text-red-600'; }
    });
}

function bulkSyncRestock() {
    var allItems = [
        {% for p in restock %}
        {% if not p.get('is_full') and not p.get('has_variations') %}{id: '{{ p.id }}', bm: {{ p.get('_bm_avail', 0) }} }{% if not loop.last %},{% endif %}{% endif %}
        {% endfor %}
    ].filter(Boolean);
    // Filtrar solo los que siguen en DOM (no procesados a√∫n)
    var items = allItems.filter(function(x) {
        return document.getElementById('restock-d-' + x.id) || document.getElementById('restock-m-' + x.id);
    });
    if (!items.length) { alert('No hay items pendientes en Reabastecer.'); return; }
    var btn = document.getElementById('bulk-restock-btn');
    var msg = document.getElementById('bulk-restock-msg');
    btn.disabled = true;
    btn.textContent = 'Sincronizando...';
    var done = 0, errors = 0, total = items.length;
    function updateProgress() {
        msg.textContent = done + '/' + total + (errors > 0 ? ' (' + errors + ' errores)' : '');
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    items.forEach(function(item) {
        var qty = Math.floor(item.bm * 0.6);
        fetch('/api/items/' + item.id + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: qty})
        })
        .then(function(r) {
            done++;
            if (!r.ok) errors++;
            else { setTimeout(function() { _removeStockRows(item.id); }, 800); }
            updateProgress();
            if (done === total) {
                btn.textContent = errors > 0 ? done + ' OK / ' + errors + ' err' : 'Completado';
                btn.className = btn.className.replace('bg-purple-600', errors > 0 ? 'bg-yellow-500' : 'bg-green-600');
            }
        })
        .catch(function() { done++; errors++; updateProgress(); });
    });
}

// --- Risk: set stock to 0 ---
function _setRiskMsg(itemId, msg, cls) {
    document.querySelectorAll('[id="risk-msg-' + itemId + '"], [id="risk-msg-d-' + itemId + '"]').forEach(function(el) {
        el.textContent = msg; el.className = cls;
    });
}
function setStockZero(itemId, btn) {
    btn.disabled = true;
    btn.textContent = '...';
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: 0})
    })
    .then(function(r) {
        if (r.ok) {
            btn.textContent = 'OK';
            _setRiskMsg(itemId, 'Stock‚Üí0', 'text-[10px] ml-1 text-green-600 font-semibold');
            setTimeout(function() { _removeStockRows(itemId); }, 1000);
        } else {
            return r.text().then(function(t) {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
            });
        }
    })
    .catch(function(e) {
        btn.textContent = 'Error';
        btn.disabled = false;
        _setRiskMsg(itemId, e.message, 'text-[10px] ml-1 text-red-600');
        alert('Error Stock‚Üí0 ' + itemId + ':\n' + e.message);
    });
}

// --- Risk: pause item ---
function pauseItem(itemId, btn) {
    btn.disabled = true;
    btn.textContent = '...';
    var msgEl = document.getElementById('risk-msg-' + itemId) || document.getElementById('risk-msg-d-' + itemId);
    fetch('/api/items/' + itemId + '/status', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({status: 'paused'})
    })
    .then(function(r) {
        if (r.ok) {
            btn.textContent = 'Pausado';
            if (msgEl) { msgEl.textContent = 'Pausado'; msgEl.className = 'text-[10px] ml-1 text-green-600 font-semibold'; }
            setTimeout(function() { _removeStockRows(itemId); }, 1000);
        } else {
            return r.text().then(function(t) {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
            });
        }
    })
    .catch(function(e) {
        btn.textContent = 'Error';
        btn.disabled = false;
        if (msgEl) { msgEl.textContent = e.message; msgEl.className = 'text-[10px] ml-1 text-red-600'; }
    });
}

// --- Bulk set stock to 0 for all risk items (solo los visibles en DOM, no variaciones) ---
function bulkStockZeroRisk() {
    var allInfo = [
        {% for p in oversell_risk %}
        {id: '{{ p.id }}', hv: {{ 'true' if p.get('has_variations') else 'false' }} }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ];
    var pending = allInfo.filter(function(x) {
        return document.getElementById('risk-d-' + x.id) || document.getElementById('risk-m-' + x.id);
    });
    var items = pending.filter(function(x) { return !x.hv; }).map(function(x) { return x.id; });
    var varCount = pending.filter(function(x) { return x.hv; }).length;
    if (!pending.length) { alert('No hay items pendientes en Riesgo Sobreventa.'); return; }
    if (!items.length) {
        alert('Todos los items en Riesgo tienen variaciones.\nUsa el bot√≥n "Sync Var." en cada uno para ajustar el stock por variaci√≥n (las que tienen BM=0 quedar√°n en 0 en MeLi).');
        return;
    }
    var note = varCount > 0 ? '\n\n‚ö†Ô∏è ' + varCount + ' item(s) con variaciones se omitir√°n\n   ‚Üí Usa "Sync Var." individualmente para ellos' : '';
    if (!confirm('Poner stock en 0 para ' + items.length + ' productos sin variaciones?' + note)) return;
    var btn = document.getElementById('bulk-zero-btn');
    var msg = document.getElementById('bulk-pause-msg');
    btn.disabled = true;
    btn.textContent = 'Procesando...';
    var done = 0, errors = 0, total = items.length;
    function updateProgress() {
        var ok = done - errors;
        msg.textContent = 'Stock->0: ' + ok + ' OK / ' + errors + ' err (' + done + '/' + total + ')';
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    items.forEach(function(itemId) {
        fetch('/api/items/' + itemId + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: 0})
        })
        .then(function(r) {
            done++;
            if (!r.ok) errors++;
            else { setTimeout(function() { _removeStockRows(itemId); }, 800); }
            updateProgress();
            if (done === total) {
                var ok = done - errors;
                btn.textContent = errors > 0 ? ok + ' OK / ' + errors + ' err' : 'Completado';
                btn.className = btn.className.replace('bg-red-500', errors > 0 ? 'bg-yellow-500' : 'bg-green-600');
            }
        })
        .catch(function() { done++; errors++; updateProgress(); });
    });
}

// --- Bulk pause all risk items (solo los visibles en DOM) ---
function bulkPauseRisk() {
    var allIds = [{% for p in oversell_risk %}'{{ p.id }}'{{ ',' if not loop.last else '' }}{% endfor %}];
    var items = allIds.filter(function(id) {
        return document.getElementById('risk-d-' + id) || document.getElementById('risk-m-' + id);
    });
    if (!items.length) { alert('No hay items pendientes en Riesgo Sobreventa.'); return; }
    if (!confirm('Pausar ' + items.length + ' productos en riesgo de sobreventa?\n\n(Solo los a√∫n no procesados)')) return;
    var btn = document.getElementById('bulk-pause-btn');
    var msg = document.getElementById('bulk-pause-msg');
    btn.disabled = true;
    btn.textContent = 'Pausando...';
    var done = 0, errors = 0, total = items.length;
    function updateProgress() {
        var ok = done - errors;
        msg.textContent = 'Pausar: ' + ok + ' OK / ' + errors + ' err (' + done + '/' + total + ')';
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    items.forEach(function(itemId) {
        fetch('/api/items/' + itemId + '/status', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({status: 'paused'})
        })
        .then(function(r) {
            done++;
            if (!r.ok) errors++;
            else { setTimeout(function() { _removeStockRows(itemId); }, 800); }
            updateProgress();
            if (done === total) {
                var ok = done - errors;
                btn.textContent = errors > 0 ? ok + ' OK / ' + errors + ' err' : 'Completado';
                btn.className = btn.className.replace('bg-yellow-500', errors > 0 ? 'bg-yellow-600' : 'bg-green-600');
            }
        })
        .catch(function() { done++; errors++; updateProgress(); });
    });
}

// --- Activate: sync stock 60% + activate if paused ---
function activateItem(itemId, bmTotal, status, btn) {
    var safeQty = Math.max(1, Math.floor(bmTotal * 0.6));
    btn.disabled = true;
    btn.textContent = '...';
    var msgEl = document.getElementById('act-msg-' + itemId) || document.getElementById('act-msg-d-' + itemId);
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: safeQty})
    })
    .then(function(r) {
        if (!r.ok) return r.text().then(function(t) {
            try { var d = JSON.parse(t); throw new Error(d.detail || 'Error stock'); }
            catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
        });
        if (status === 'paused') {
            return fetch('/api/items/' + itemId + '/status', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                body: JSON.stringify({status: 'active'})
            }).then(function(r2) {
                if (!r2.ok && msgEl) { msgEl.textContent = 'Stock OK, activar fallo'; msgEl.className = 'text-[10px] ml-1 text-yellow-600'; }
                return 'done';
            });
        }
        return 'done';
    })
    .then(function() {
        btn.textContent = 'OK (' + safeQty + ')';
        if (msgEl) { msgEl.textContent = 'Stock: ' + safeQty + (status === 'paused' ? ' + Activado' : ''); msgEl.className = 'text-[10px] ml-1 text-green-600 font-semibold'; }
        setTimeout(function() { _removeStockRows(itemId); }, 1000);
    })
    .catch(function(e) {
        btn.textContent = 'Error';
        btn.disabled = false;
        if (msgEl) { msgEl.textContent = e.message; msgEl.className = 'text-[10px] ml-1 text-red-600'; }
    });
}

// --- Helpers de panel flotante ---
function _getOrCreatePanel(anchorEl, panelId) {
    var panel = document.getElementById(panelId);
    if (!panel) {
        panel = document.createElement('div');
        panel.id = panelId;
        panel.style.cssText = 'position:absolute;z-index:100;background:#fff;border:1px solid #c7d2fe;border-radius:10px;padding:10px 12px;font-size:11px;box-shadow:0 6px 20px rgba(0,0,0,.18);min-width:260px;max-width:380px;right:0;top:calc(100% + 6px)';
        anchorEl.parentElement.style.position = 'relative';
        anchorEl.parentElement.appendChild(panel);
    }
    panel.style.display = 'block';
    // Cerrar al click fuera
    setTimeout(function() {
        function closeMe(e) {
            if (!panel.contains(e.target) && e.target !== anchorEl) {
                panel.style.display = 'none';
                document.removeEventListener('click', closeMe);
            }
        }
        document.addEventListener('click', closeMe);
    }, 150);
    return panel;
}

function _closeBtn(panelId) {
    return '<span style="float:right;cursor:pointer;color:#94a3b8;font-size:13px;line-height:1" onclick="document.getElementById(\'' + panelId + '\').style.display=\'none\'">‚úï</span>';
}

function _varRow(v, showSync) {
    var icon = v.error ? '‚ùå' : (v.bm_total === 0 ? '‚ö†Ô∏è' : '‚úÖ');
    var combo = (v.combo || 'Var ' + v.variation_id);
    var sku = v.sku || v.sku_label || '';
    var skuHtml = sku ? '<div style="color:#64748b;font-size:10px">' + sku + '</div>' : '';
    var detail = v.error
        ? '<span style="color:#dc2626;font-size:10px">' + v.error + '</span>'
        : '<span>BM <b>' + v.bm_total + '</b> ‚Üí <b>' + v.meli_qty + '</b></span>';
    return '<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid #f1f5f9">'
        + '<span>' + icon + '</span>'
        + '<div style="flex:1"><div style="font-weight:500">' + combo + '</div>' + skuHtml + '</div>'
        + '<div style="text-align:right;white-space:nowrap">' + detail + '</div></div>';
}

// --- Ver stock MeLi por variacion (sin llamada API, datos del template) ---
function showVarStockPanel(itemId, triggerEl) {
    var vars = [];
    try { vars = JSON.parse(triggerEl.getAttribute('data-variations') || '[]'); } catch(e) {}
    var panelId = 'vp-meli-' + itemId;
    var panel = _getOrCreatePanel(triggerEl, panelId);

    var hasBm = vars.some(function(v) { return typeof v._bm_total !== 'undefined'; });
    var rows = vars.map(function(v) {
        var combo = v.combo || ('Var ' + v.id);
        var sku = v.sku || '';
        var skuHtml = sku ? '<div style="color:#64748b;font-size:10px">' + sku + '</div>' : '<div style="color:#f59e0b;font-size:10px">Sin SKU</div>';
        var stock = typeof v.stock !== 'undefined' ? v.stock : '?';
        var stockColor = stock > 0 ? '#16a34a' : '#dc2626';
        var bmHtml = hasBm
            ? '<div style="text-align:right;margin-left:8px"><span style="color:' + ((v._bm_total||0) > 0 ? '#2563eb' : '#dc2626') + ';font-weight:700">' + (v._bm_total||0) + '</span><div style="color:#94a3b8;font-size:9px">BM</div></div>'
            : '';
        return '<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid #f1f5f9">'
            + '<div style="flex:1"><div style="font-weight:500">' + combo + '</div>' + skuHtml + '</div>'
            + '<div style="text-align:right"><span style="color:' + stockColor + ';font-weight:700">' + stock + '</span><div style="color:#94a3b8;font-size:9px">MeLi</div></div>'
            + bmHtml
            + '</div>';
    }).join('');

    panel.innerHTML = '<div style="font-weight:700;color:#4338ca;margin-bottom:6px">Stock por variacion ' + _closeBtn(panelId) + '</div>'
        + rows
        + (hasBm ? '' : '<div style="color:#94a3b8;font-size:10px;margin-top:6px">BM: haz clic en "Sync Var." para ver stock BM</div>');
}

// --- Sync per-variation: 2 pasos (preview BM ‚Üí confirmar ‚Üí sync real) ---
function syncVariationStocks(itemId, btn) {
    var knownVariations = [];
    try { knownVariations = JSON.parse(btn.getAttribute('data-variations') || '[]'); } catch(e) {}
    var panelId = 'vp-sync-' + itemId;
    var panel = _getOrCreatePanel(btn, panelId);
    panel.innerHTML = '<div style="color:#6366f1;font-weight:600">Consultando BM... ‚è≥</div>';
    btn.disabled = true;
    var origText = btn.textContent.trim();
    btn.textContent = 'Cargando...';

    // Paso 1: dry_run ‚Üí obtener BM sin sincronizar
    fetch('/api/items/' + itemId + '/sync-variation-stocks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({pct: 0.6, dry_run: true, variations: knownVariations})
    })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(res) {
        btn.disabled = false;
        btn.textContent = origText;
        if (!res.ok) throw new Error(res.data.detail || 'Error');
        var results = res.data.results || [];
        var hasErrors = results.some(function(v) { return v.error; });

        // Encabezado
        var headerColor = hasErrors ? '#b45309' : '#4338ca';
        var html = '<div style="font-weight:700;color:' + headerColor + ';margin-bottom:6px">Stock BM por variacion ' + _closeBtn(panelId) + '</div>';

        // Tabla con header
        html += '<div style="display:flex;font-size:10px;color:#94a3b8;padding:2px 0;border-bottom:2px solid #e0e7ff;gap:6px">'
            + '<div style="flex:1">Variacion / SKU</div>'
            + '<div style="width:40px;text-align:center">MeLi</div>'
            + '<div style="width:40px;text-align:center">BM</div>'
            + '<div style="width:50px;text-align:center">‚Üí 60%</div>'
            + '</div>';

        results.forEach(function(v) {
            var icon = v.error ? '‚ùå' : (v.bm_total === 0 ? '‚ö†Ô∏è' : '‚úÖ');
            var combo = (v.combo || 'Var ' + v.variation_id);
            var sku = v.sku || '';
            var skuHtml = sku ? '<div style="color:#64748b;font-size:10px">' + sku + '</div>' : '';
            var detail = v.error
                ? '<div style="color:#dc2626;font-size:10px;grid-column:span 3">' + v.error + '</div>'
                : '<div style="width:40px;text-align:center;color:#f59e0b;font-weight:700">' + v.meli_stock + '</div>'
                  + '<div style="width:40px;text-align:center;color:#2563eb;font-weight:700">' + v.bm_total + '</div>'
                  + '<div style="width:50px;text-align:center;color:#16a34a;font-weight:700">' + v.meli_qty + '</div>';
            html += '<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid #f1f5f9">'
                + '<span>' + icon + '</span>'
                + '<div style="flex:1"><div style="font-weight:500">' + combo + '</div>' + skuHtml + '</div>'
                + (!v.error ? detail : '<div style="flex:1;color:#dc2626;font-size:10px">' + v.error + '</div>')
                + '</div>';
        });

        // Bot√≥n confirmar (solo si hay algo que actualizar)
        var hasUpdatable = results.some(function(v) { return !v.error; });
        if (hasUpdatable) {
            html += '<button onclick="confirmSyncVariations(\'' + itemId + '\', this)" '
                + 'style="margin-top:8px;width:100%;padding:6px;background:#4f46e5;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer">'
                + '‚úì Confirmar Sync 60% en MeLi</button>';
        }
        panel.innerHTML = html;

        // Guardar datos para confirmar
        panel._syncVars = knownVariations;
        panel._syncBtn = btn;
    })
    .catch(function(e) {
        btn.disabled = false;
        btn.textContent = origText;
        panel.innerHTML = '<span style="color:#dc2626">Error: ' + e.message + '</span>';
    });
}

function confirmSyncVariations(itemId, confirmBtn) {
    var panelId = 'vp-sync-' + itemId;
    var panel = document.getElementById(panelId);
    var knownVariations = panel ? (panel._syncVars || []) : [];
    var origBtn = panel ? panel._syncBtn : null;

    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Sincronizando...';

    fetch('/api/items/' + itemId + '/sync-variation-stocks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({pct: 0.6, dry_run: false, variations: knownVariations})
    })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(res) {
        if (!res.ok) throw new Error(res.data.detail || 'Error');
        var results = res.data.results || [];
        var updated = results.filter(function(v) { return v.updated; }).length;
        var errors  = results.filter(function(v) { return v.error; }).length;
        var summary = updated + '/' + results.length + ' OK' + (errors > 0 ? ', ' + errors + ' err' : '');

        confirmBtn.textContent = '‚úì ' + summary;
        confirmBtn.style.background = errors > 0 ? '#d97706' : '#16a34a';

        if (origBtn) {
            origBtn.textContent = summary;
            origBtn.className = origBtn.className
                .replace('bg-indigo-600', errors > 0 ? 'bg-yellow-500' : 'bg-green-600')
                .replace('hover:bg-indigo-700', '').replace('active:bg-indigo-700', '');
        }
        // Quitar fila siempre que el usuario confirm√≥ (aunque algunas var. tengan error)
        // Si hay errores parciales el bot√≥n ya muestra el resumen "X/3 OK, 1 err"
        setTimeout(function() { _removeStockRows(itemId); }, 1200);
    })
    .catch(function(e) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Error: ' + e.message;
        confirmBtn.style.background = '#dc2626';
    });
}

// --- Stock Cr√≠tico: Concentrar SKU en mejor cuenta ---
function concentrateItem(sku, title, bmAvail, btn) {
    if (!sku) { alert('Este producto no tiene SKU registrado.'); return; }
    btn.disabled = true;
    var origText = btn.textContent;
    btn.textContent = 'Analizando...';
    fetch('/api/stock/concentration/preview?sku=' + encodeURIComponent(sku), {
        headers: {'ngrok-skip-browser-warning': 'true'}
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        btn.disabled = false;
        btn.textContent = origText;
        if (d.error) { alert('Error al analizar SKU ' + sku + ':\n' + d.error); return; }
        var winner = d.winner || {};
        var accounts = d.accounts || [];
        var lines = ['SKU: ' + sku + ' ‚Äî BM Disponible: ' + (d.total_bm_avail || bmAvail)];
        lines.push('');
        accounts.forEach(function(a) {
            var marker = a.user_id === winner.user_id ? '‚òÖ GANADOR' : '';
            lines.push((marker || '  ') + ' ' + (a.nickname || a.user_id) + ': ' + a.sold_30d + ' ventas / MeLi=' + (a.meli_stock || 0) + ' ' + marker);
        });
        if (!winner.user_id) {
            lines.push('');
            lines.push('Sin ganador claro (producto nuevo o sin ventas en todas las cuentas)');
            alert(lines.join('\n'));
            return;
        }
        lines.push('');
        lines.push('‚Üí Concentrar todo el stock (' + d.total_bm_avail + ') en ' + (winner.nickname || winner.user_id));
        lines.push('‚Üí Las dem√°s cuentas quedar√°n en stock = 0');
        lines.push('');
        lines.push('¬øConfirmar concentraci√≥n?');
        if (!confirm(lines.join('\n'))) return;
        btn.disabled = true;
        btn.textContent = 'Ejecutando...';
        fetch('/api/stock/concentration/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({
                sku: sku,
                winner_user_id: winner.user_id,
                total_stock: d.total_bm_avail,
                dry_run: false
            })
        })
        .then(function(r) { return r.json().then(function(data) { return {ok: r.ok, data: data}; }); })
        .then(function(res) {
            btn.disabled = false;
            if (!res.ok) { btn.textContent = 'Error'; alert('Error: ' + (res.data.detail || JSON.stringify(res.data))); return; }
            btn.textContent = 'OK';
            btn.className = btn.className.replace('bg-red-600', 'bg-green-600').replace('hover:bg-red-700', '');
            var zeroed = res.data.zeroed_accounts || [];
            var msg = 'Concentrado en ' + (winner.nickname || winner.user_id) + '\n';
            if (zeroed.length) msg += 'Stock‚Üí0 en: ' + zeroed.join(', ');
            alert(msg);
        })
        .catch(function(e) {
            btn.disabled = false;
            btn.textContent = 'Error';
            alert('Error ejecutando: ' + e.message);
        });
    })
    .catch(function(e) {
        btn.disabled = false;
        btn.textContent = origText;
        alert('Error al consultar: ' + e.message);
    });
}

function bulkConcentrateCritical() {
    var skus = [
        {% for p in critical %}
        {% if p.sku %}{ sku: '{{ p.sku }}', avail: {{ p.get('_bm_avail', 0) }} }{{ ',' if not loop.last else '' }}{% endif %}
        {% endfor %}
    ].filter(Boolean);
    if (!skus.length) { alert('No hay SKUs en la secci√≥n cr√≠tica.'); return; }
    if (!confirm('¬øAnalizar y concentrar autom√°ticamente ' + skus.length + ' SKUs con stock cr√≠tico?\n\nEsto pondr√° en 0 las cuentas con menos ventas.')) return;
    var btn = document.getElementById('bulk-critical-btn');
    var msg = document.getElementById('bulk-critical-msg');
    btn.disabled = true;
    btn.textContent = 'Procesando...';
    var done = 0, skipped = 0, errors = 0, total = skus.length;
    function updateProgress() {
        msg.textContent = 'Concentrando: ' + done + '/' + total + ' OK, ' + skipped + ' omitidos, ' + errors + ' errores';
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    function processNext(i) {
        if (i >= skus.length) {
            btn.textContent = 'Completado';
            btn.disabled = false;
            return;
        }
        var s = skus[i];
        fetch('/api/stock/concentration/preview?sku=' + encodeURIComponent(s.sku), {
            headers: {'ngrok-skip-browser-warning': 'true'}
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var winner = d.winner;
            if (!winner || !winner.user_id) { skipped++; updateProgress(); processNext(i + 1); return; }
            return fetch('/api/stock/concentration/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                body: JSON.stringify({ sku: s.sku, winner_user_id: winner.user_id, total_stock: d.total_bm_avail, dry_run: false })
            })
            .then(function(r2) { return r2.json().then(function(data) { return {ok: r2.ok, data: data}; }); })
            .then(function(res) {
                if (res.ok) done++; else errors++;
                updateProgress();
                processNext(i + 1);
            });
        })
        .catch(function() { errors++; updateProgress(); processNext(i + 1); });
    }
    processNext(0);
}

function bulkActivateAll() {
    var allItems = [
        {% for p in activate %}
        {id: '{{ p.id }}', bm: {{ p.get('_bm_total', 0) }}, status: '{{ p.status }}' }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ];
    // Solo los que siguen visibles en DOM
    var items = allItems.filter(function(x) {
        return document.getElementById('act-d-' + x.id) || document.getElementById('act-m-' + x.id);
    });
    if (!items.length) { alert('No hay items pendientes en Activar.'); return; }
    if (!confirm('Activar ' + items.length + ' productos?\n\nSe sincronizara 60% del stock BM y se activaran los pausados.')) return;
    var btn = document.getElementById('bulk-activate-btn');
    var msg = document.getElementById('bulk-activate-msg');
    btn.disabled = true;
    btn.textContent = 'Activando...';
    var done = 0, errors = 0, total = items.length;
    function updateProgress() {
        msg.textContent = done + '/' + total + (errors > 0 ? ' (' + errors + ' errores)' : '');
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    items.forEach(function(item) {
        var qty = Math.max(1, Math.floor(item.bm * 0.6));
        fetch('/api/items/' + item.id + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: qty})
        })
        .then(function(r) {
            if (!r.ok) throw new Error('stock fail');
            if (item.status === 'paused') {
                return fetch('/api/items/' + item.id + '/status', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                    body: JSON.stringify({status: 'active'})
                });
            }
        })
        .then(function() {
            done++;
            setTimeout(function() { _removeStockRows(item.id); }, 800);
            updateProgress();
            if (done === total) {
                btn.textContent = errors > 0 ? done + ' OK / ' + errors + ' err' : 'Completado';
                btn.className = btn.className.replace('bg-green-600', errors > 0 ? 'bg-yellow-500' : 'bg-gray-400');
            }
        })
        .catch(function() { done++; errors++; updateProgress(); });
    });
}
</script>

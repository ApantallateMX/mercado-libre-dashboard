<div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
    <div>
        <h2 class="text-lg font-semibold text-gray-800">
            <span class="inline-flex items-center gap-2">
                <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Productos en Fulfillment (FULL)
            </span>
        </h2>
        <p class="text-sm text-gray-500">Stock gestionado por MeLi en sus bodegas</p>
    </div>
    <!-- Filtros -->
    <div class="flex gap-2">
        <button onclick="loadFullTab('all')"
                class="px-3 py-1.5 rounded text-sm font-medium transition {{ 'bg-cyan-500 text-white' if stock_filter == 'all' else 'bg-gray-100 text-gray-600 hover:bg-gray-200' }}">
            Todos ({{ products|length if stock_filter == 'all' else '-' }})
        </button>
        <button onclick="loadFullTab('with_stock')"
                class="px-3 py-1.5 rounded text-sm font-medium transition {{ 'bg-green-500 text-white' if stock_filter == 'with_stock' else 'bg-gray-100 text-gray-600 hover:bg-gray-200' }}">
            Con stock
        </button>
        <button onclick="loadFullTab('no_stock')"
                class="px-3 py-1.5 rounded text-sm font-medium transition {{ 'bg-red-500 text-white' if stock_filter == 'no_stock' else 'bg-gray-100 text-gray-600 hover:bg-gray-200' }}">
            Sin stock
        </button>
    </div>
</div>

{% if products %}
<!-- Resumen rapido -->
{% set total_stock = products|map(attribute='available_quantity')|sum %}
{% set with_stock = products|selectattr('available_quantity', 'gt', 0)|list|length %}
{% set no_stock = products|rejectattr('available_quantity', 'gt', 0)|list|length %}
{% set total_units = products|map(attribute='units')|sum if products[0].get('units') is defined else 0 %}
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div class="bg-cyan-50 rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-cyan-700">{{ products|length }}</div>
        <div class="text-xs text-cyan-600">Productos FULL</div>
    </div>
    <div class="bg-green-50 rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-green-700">{{ with_stock }}</div>
        <div class="text-xs text-green-600">Con stock</div>
    </div>
    <div class="bg-red-50 rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-red-700">{{ no_stock }}</div>
        <div class="text-xs text-red-600">Sin stock</div>
    </div>
    <div class="bg-blue-50 rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-blue-700">{{ "{:,}".format(total_stock) }}</div>
        <div class="text-xs text-blue-600">Unidades en FULL</div>
    </div>
</div>

<div class="bg-white rounded-lg shadow overflow-x-auto">
    <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b">
            <tr>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs">#</th>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs">Producto</th>
                <th class="text-left px-3 py-3 text-gray-600 font-medium text-xs">ID / SKU</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Stock FULL</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Vendidos (30d)</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Revenue (30d)</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Precio</th>
                <th class="text-right px-3 py-3 text-gray-600 font-medium text-xs">Costo BM</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs">Margen</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs">Deal</th>
                <th class="text-center px-3 py-3 text-gray-600 font-medium text-xs">Acciones</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for p in products %}
            <tr class="hover:bg-gray-50 {{ 'bg-red-50/40' if p.available_quantity == 0 else '' }}">
                <td class="px-3 py-3 text-gray-400 font-bold">{{ loop.index }}</td>
                <td class="px-3 py-3">
                    <div class="flex items-center gap-2">
                        {% if p.thumbnail %}
                        <img src="{{ p.thumbnail }}" class="w-10 h-10 rounded object-cover flex-shrink-0" alt="">
                        {% endif %}
                        <div class="min-w-0">
                            <span class="text-gray-800 truncate block max-w-[200px] text-xs" title="{{ p.title }}">{{ p.title }}</span>
                            {% if p.get('variations') %}
                            <button onclick="toggleVariationsFull('fv-{{ loop.index }}')"
                                    class="text-[10px] text-purple-600 hover:underline mt-0.5">
                                {{ p.variations|length }} variaciones
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td class="px-3 py-3">
                    <div class="flex flex-col">
                        <a href="{{ p.permalink }}" target="_blank"
                           class="text-xs text-blue-600 font-mono font-semibold hover:underline">{{ p.id }}</a>
                        <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                    </div>
                </td>
                <td class="px-3 py-3 text-right">
                    <div class="flex items-center justify-end gap-1.5">
                        <span class="font-bold text-lg {{ 'text-cyan-600' if p.available_quantity > 5 else 'text-yellow-600' if p.available_quantity > 0 else 'text-red-600' }}">
                            {{ p.available_quantity }}
                        </span>
                        <span class="px-1.5 py-0.5 text-[10px] font-bold bg-cyan-100 text-cyan-700 rounded">FULL</span>
                    </div>
                </td>
                <td class="px-3 py-3 text-right">
                    {% if p.get('units', 0) > 0 %}
                    <span class="font-semibold text-gray-800">{{ p.units }}</span>
                    {% else %}
                    <span class="text-red-500 font-semibold">0</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-right text-gray-700">
                    {% if p.get('revenue', 0) > 0 %}
                    ${{ "{:,.0f}".format(p.revenue) }}
                    {% else %}
                    <span class="text-gray-300">-</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-right">
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="text-green-600 font-semibold text-xs">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="text-gray-700 text-xs">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-right">
                    {% if p.get('_costo_mxn') and p._costo_mxn > 0 %}
                    <div class="flex flex-col items-end">
                        <span class="text-gray-700 text-xs font-semibold">${{ "{:,.0f}".format(p._costo_mxn) }}</span>
                        <span class="text-[10px] text-gray-400">${{ '%.2f'|format(p.get('_bm_avg_cost', 0)) }} USD</span>
                    </div>
                    {% elif p.get('_bm_has_data') %}
                    <div class="flex flex-col items-end">
                        <span class="text-orange-500 text-[10px] font-medium">Sin costo</span>
                    </div>
                    {% else %}
                    <span class="text-gray-300 text-xs">-</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-center">
                    {% if p.get('_margen_pct') is not none %}
                    <div class="flex flex-col items-center">
                        <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold
                            {% if p._margen_pct >= 20 %}bg-green-100 text-green-700
                            {% elif p._margen_pct >= 10 %}bg-yellow-100 text-yellow-700
                            {% elif p._margen_pct >= 0 %}bg-orange-100 text-orange-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ "%.1f"|format(p._margen_pct) }}%
                        </span>
                        <span class="text-[10px] text-gray-400 mt-0.5">${{ "{:,.0f}".format(p._ganancia_est) }}</span>
                    </div>
                    {% else %}
                    <span class="text-gray-300 text-xs">-</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-center">
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">
                        -{{ "%.0f"|format((1 - p.price / p.original_price) * 100) }}%
                    </span>
                    {% else %}
                    <span class="text-xs text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-3 py-3 text-center">
                    <div class="flex flex-col items-center gap-1">
                        {% if p.permalink %}
                        <a href="{{ p.permalink }}" target="_blank" class="text-blue-500 hover:text-blue-700 text-xs">Ver</a>
                        {% endif %}
                        <a href="https://www.mercadolibre.com.mx/publicaciones/{{ p.id }}/modificar" target="_blank"
                           class="text-[10px] text-gray-400 hover:text-gray-600">Editar</a>
                        <button onclick="changeToMerchant('{{ p.id }}')"
                                class="text-[10px] text-cyan-600 hover:text-cyan-800 hover:underline">
                            Quitar FULL
                        </button>
                    </div>
                </td>
            </tr>
            {% if p.get('variations') %}
            <tr id="fv-{{ loop.index }}" class="hidden bg-purple-50/30">
                <td colspan="11" class="px-6 py-2">
                    <div class="text-xs">
                        <table class="w-full">
                            <thead>
                                <tr class="text-gray-500">
                                    <th class="text-left py-1 font-medium">Variacion</th>
                                    <th class="text-left py-1 font-medium">ID Variacion</th>
                                    <th class="text-left py-1 font-medium">SKU</th>
                                    <th class="text-right py-1 font-medium">Stock</th>
                                    <th class="text-right py-1 font-medium">Precio</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-purple-100">
                                {% for v in p.variations %}
                                <tr>
                                    <td class="py-1 text-gray-700">{{ v.combo }}</td>
                                    <td class="py-1 text-blue-600 font-mono text-[10px]">{{ v.id }}</td>
                                    <td class="py-1 text-gray-500 font-mono">{{ v.sku or '-' }}</td>
                                    <td class="py-1 text-right {{ 'text-green-600' if v.stock > 0 else 'text-red-500' }}">{{ v.stock }}</td>
                                    <td class="py-1 text-right text-gray-600">${{ "{:,.0f}".format(v.price) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3 text-sm text-gray-500">
    Mostrando {{ products|length }} productos FULL
    {% if stock_filter == 'with_stock' %}con stock{% elif stock_filter == 'no_stock' %}sin stock{% endif %}
</div>
{% else %}
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
    <svg class="w-12 h-12 mx-auto mb-3 text-cyan-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
    No hay productos en Fulfillment
    {% if stock_filter != 'all' %}con este filtro{% endif %}
</div>
{% endif %}

<script>
function toggleVariationsFull(id) {
    var row = document.getElementById(id);
    if (row) row.classList.toggle('hidden');
}

function loadFullTab(filter) {
    var content = document.getElementById('tab-content');
    content.innerHTML = '<div class="flex justify-center py-12"><svg class="animate-spin h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg></div>';
    fetch('/partials/products-full?stock_filter=' + filter, {headers: {'ngrok-skip-browser-warning': 'true'}})
        .then(function(r) { return r.text(); })
        .then(function(html) {
            content.innerHTML = html;
            content.querySelectorAll('script').forEach(function(oldScript) {
                var newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
            if (window.htmx) htmx.process(content);
        })
        .catch(function(e) {
            content.innerHTML = '<div class="text-center py-8 text-red-500">Error: ' + e.message + '</div>';
        });
}
</script>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     amazon_recent_orders.html â€” Ãšltimas Ã³rdenes Amazon con detalle por item
     Variables: orders (lista de dicts SP-API Orders v0 enriquecidos con _items)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

{% if not orders %}
<p class="text-center text-gray-400 py-6 text-sm">Sin Ã³rdenes en los Ãºltimos 14 dÃ­as</p>
{% else %}
<div class="divide-y divide-gray-100">
    {% for order in orders %}
    {% set order_id   = order.get('AmazonOrderId', 'â€”') %}
    {% set status     = order.get('OrderStatus', '') %}
    {% set amount     = order.get('OrderTotal', {}).get('Amount', '0') | float %}
    {% set currency   = order.get('OrderTotal', {}).get('CurrencyCode', 'MXN') %}
    {% set raw_date   = order.get('PurchaseDate', '') %}
    {% set units_ship = order.get('NumberOfItemsShipped', 0) | int %}
    {% set units_pend = order.get('NumberOfItemsUnshipped', 0) | int %}
    {% set units      = units_ship + units_pend %}
    {% set items      = order.get('_items', []) %}
    {% set first_item = items[0] if items else {} %}
    {% set title      = first_item.get('Title', '') %}
    {% set asin       = first_item.get('ASIN', '') %}
    {% set sku        = first_item.get('SellerSKU', '') %}

    <!-- Fila principal â€” clic para expandir -->
    <div class="py-3 px-1 hover:bg-orange-50/40 transition rounded cursor-pointer"
         onclick="this.nextElementSibling.classList.toggle('hidden')">
        <div class="flex items-start justify-between gap-3">
            <!-- Izquierda: icono + info principal -->
            <div class="flex items-start gap-3 min-w-0 flex-1">
                <div class="w-9 h-9 rounded-lg bg-orange-100 flex items-center justify-center shrink-0 mt-0.5">
                    <span class="text-orange-600 text-sm font-bold">ðŸ“¦</span>
                </div>
                <div class="min-w-0">
                    <!-- TÃ­tulo del primer producto -->
                    {% if title %}
                    <p class="text-sm font-semibold text-gray-800 leading-snug truncate max-w-xs md:max-w-sm">
                        {{ title[:70] }}{% if title|length > 70 %}â€¦{% endif %}
                    </p>
                    {% else %}
                    <p class="text-sm font-semibold text-gray-600 italic">Sin descripciÃ³n disponible</p>
                    {% endif %}
                    <!-- Chips: SKU + ASIN + Fecha + Unidades -->
                    <div class="flex flex-wrap items-center gap-x-2 gap-y-0.5 mt-0.5">
                        {% if sku %}
                        <span class="text-xs font-mono text-orange-700 bg-orange-50 px-1.5 py-0.5 rounded font-semibold">SKU: {{ sku }}</span>
                        {% endif %}
                        {% if asin %}
                        <span class="text-xs font-mono text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded">ASIN: {{ asin }}</span>
                        {% endif %}
                        <span class="text-xs text-gray-400">{{ raw_date[:10] if raw_date else 'â€”' }}</span>
                        {% if units %}
                        <span class="text-xs text-gray-500">Â· {{ units }} ud{{ 's' if units != 1 else '' }}</span>
                        {% endif %}
                        {% if items|length > 1 %}
                        <span class="text-xs text-gray-400">(+{{ items|length - 1 }} producto{{ 's' if items|length - 1 != 1 else '' }} mÃ¡s)</span>
                        {% endif %}
                    </div>
                    <!-- NÃºmero de orden -->
                    <p class="text-xs text-gray-400 font-mono mt-0.5">{{ order_id }}</p>
                </div>
            </div>
            <!-- Derecha: monto + badge -->
            <div class="flex flex-col items-end gap-1.5 shrink-0">
                <span class="text-sm font-bold text-orange-700">
                    ${{ "{:,.2f}".format(amount) }}
                    <span class="text-xs font-normal text-gray-400">{{ currency }}</span>
                </span>
                {% if status == 'Shipped' %}
                    <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 font-medium">Enviado</span>
                {% elif status == 'Unshipped' %}
                    <span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 font-medium">Por enviar</span>
                {% elif status == 'Delivered' %}
                    <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800 font-medium">Entregado</span>
                {% elif status == 'Pending' %}
                    <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600 font-medium">Pendiente</span>
                {% else %}
                    <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-500 font-medium">{{ status }}</span>
                {% endif %}
                <span class="text-xs text-gray-300">â–¾ detalle</span>
            </div>
        </div>
    </div>

    <!-- Fila expandible â€” oculta por defecto -->
    <div class="hidden bg-orange-50/50 border-l-4 border-orange-300 px-4 py-4 mb-1">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

            <!-- Col 1: Productos de la orden -->
            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase mb-2 tracking-wide">Productos de la orden</p>
                {% if items %}
                {% for item in items %}
                {% set item_asin  = item.get('ASIN', 'â€”') %}
                {% set item_sku   = item.get('SellerSKU', 'â€”') %}
                {% set item_title = item.get('Title', 'Sin tÃ­tulo') %}
                {% set item_qty   = item.get('QuantityOrdered', 1) | int %}
                {% set item_price_obj = item.get('ItemPrice', {}) %}
                {% set item_price = item_price_obj.get('Amount', '0') | float if item_price_obj else 0.0 %}
                <div class="mb-3 {% if not loop.last %}pb-3 border-b border-orange-200{% endif %}">
                    <p class="text-sm font-medium text-gray-800 leading-snug">{{ item_title[:65] }}{% if item_title|length > 65 %}â€¦{% endif %}</p>
                    <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-0.5 mt-1.5 text-xs">
                        <span class="text-gray-400">ASIN:</span>
                        <span class="font-mono text-blue-700 font-semibold">{{ item_asin }}</span>
                        <span class="text-gray-400">SKU:</span>
                        <span class="font-mono text-orange-700 font-semibold">{{ item_sku }}</span>
                        <span class="text-gray-400">Cantidad:</span>
                        <span class="text-gray-700">{{ item_qty }} ud{{ 's' if item_qty != 1 else '' }}</span>
                        {% if item_price > 0 %}
                        <span class="text-gray-400">Precio unit.:</span>
                        <span class="text-gray-700 font-semibold">${{ "{:,.2f}".format(item_price) }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-xs text-gray-400 italic">Items no disponibles â€” usar SP-API v0 para ver detalle</p>
                {% endif %}
            </div>

            <!-- Col 2: Resumen de la orden -->
            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase mb-2 tracking-wide">Detalle de la orden</p>
                <div class="bg-white rounded-lg border border-orange-200 overflow-hidden text-sm">
                    <div class="px-4 py-2.5 flex justify-between border-b border-gray-100">
                        <span class="text-gray-500">No. Orden</span>
                        <span class="font-mono text-xs text-gray-700">{{ order_id }}</span>
                    </div>
                    <div class="px-4 py-2.5 flex justify-between border-b border-gray-100">
                        <span class="text-gray-500">Fecha</span>
                        <span class="text-gray-700">{{ raw_date[:19].replace('T', ' ') if raw_date else 'â€”' }}</span>
                    </div>
                    <div class="px-4 py-2.5 flex justify-between border-b border-gray-100">
                        <span class="text-gray-500">Unidades</span>
                        <span class="text-gray-700">{{ units_ship }} enviadas / {{ units_pend }} por enviar</span>
                    </div>
                    <div class="px-4 py-2.5 flex justify-between border-b border-gray-100">
                        <span class="text-gray-500">Canal</span>
                        <span class="text-gray-700">{{ order.get('SalesChannel', 'Amazon.com.mx') }}</span>
                    </div>
                    <div class="px-4 py-3 flex justify-between bg-orange-50 border-t-2 border-orange-300">
                        <span class="text-orange-800 font-bold">Total</span>
                        <span class="text-orange-800 font-bold text-base">${{ "{:,.2f}".format(amount) }} {{ currency }}</span>
                    </div>
                </div>
                <!-- Estado FBA / MFN -->
                {% set fulfillment = order.get('FulfillmentChannel', '') %}
                {% if fulfillment %}
                <p class="mt-2 text-xs text-gray-400">
                    Canal de fulfillment:
                    <strong class="{% if fulfillment == 'AFN' %}text-orange-600{% else %}text-blue-600{% endif %}">
                        {{ 'FBA (Amazon)' if fulfillment == 'AFN' else 'MFN (Vendedor)' }}
                    </strong>
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    {% endfor %}
</div>
{% endif %}

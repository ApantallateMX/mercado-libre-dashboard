{# ─── amazon_orders_table.html ───────────────────────────────────────────────
   Partial devuelto por GET /api/amazon/orders.
   Contiene: banner de 4 stats + tabla de órdenes con lazy expand de items.
   Columnas: FECHA | PRODUCTO (lazy) | SKU (lazy) | CANAL | TOTAL | ESTADO | ▼
──────────────────────────────────────────────────────────────────────────── #}

<!-- ── STATS BANNER ───────────────────────────────────────────────────────── -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">

    <div class="bg-white rounded-xl shadow p-4 border-l-4 border-[#FF9900]">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Órdenes</p>
        <p class="text-2xl font-bold text-gray-800">{{ stats.total_orders }}</p>
        <p class="text-xs text-gray-400 mt-1">{{ date_from }} → {{ date_to }}</p>
    </div>

    <div class="bg-white rounded-xl shadow p-4 border-l-4 border-[#FF9900]">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Unidades</p>
        <p class="text-2xl font-bold text-gray-800">{{ stats.total_units }}</p>
        <p class="text-xs text-gray-400 mt-1">sin canceladas</p>
    </div>

    <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Revenue Total</p>
        <p class="text-2xl font-bold text-green-700">
            ${{ "{:,.0f}".format(stats.total_revenue) }}
        </p>
        <p class="text-xs text-gray-400 mt-1">MXN · sin pendientes/canceladas</p>
    </div>

    <div class="bg-white rounded-xl shadow p-4 border-l-4 border-red-400">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Canceladas</p>
        <p class="text-2xl font-bold text-red-600">{{ stats.total_canceled }}</p>
        <p class="text-xs text-gray-400 mt-1">en el período</p>
    </div>

</div>

<!-- ── TABLA DE ÓRDENES ──────────────────────────────────────────────────── -->
{% if not orders %}
<div class="bg-white rounded-xl shadow p-10 text-center text-gray-400">
    <p class="text-lg">Sin órdenes en el período seleccionado</p>
    <p class="text-sm mt-1">Prueba con un rango de fechas más amplio</p>
</div>

{% else %}
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm" id="amz-orders-table">
            <thead>
                <tr class="bg-[#232F3E] text-gray-200 text-xs uppercase tracking-wide">
                    <th class="px-3 py-3 text-left whitespace-nowrap">Fecha (CST)</th>
                    <th class="px-3 py-3 text-left">Producto</th>
                    <th class="px-3 py-3 text-left whitespace-nowrap">SKU</th>
                    <th class="px-3 py-3 text-center whitespace-nowrap">Canal</th>
                    <th class="px-3 py-3 text-right whitespace-nowrap">Total</th>
                    <th class="px-3 py-3 text-center whitespace-nowrap">Estado</th>
                    <th class="px-3 py-3 text-center w-10">▼</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="amz-orders-tbody">
                {% for order in orders %}
                <!-- Fila principal -->
                <tr class="hover:bg-orange-50 transition" id="order-row-{{ order.order_id }}">

                    {# FECHA #}
                    <td class="px-3 py-2.5 text-gray-500 text-xs whitespace-nowrap">
                        {{ order.date }}
                    </td>

                    {# PRODUCTO — se carga via JS después del render #}
                    <td class="px-3 py-2.5 max-w-[220px]" id="prod-{{ order.order_id }}">
                        <span class="text-gray-300 text-xs italic">cargando…</span>
                    </td>

                    {# SKU — se carga via JS después del render #}
                    <td class="px-3 py-2.5" id="sku-{{ order.order_id }}">
                        <span class="text-gray-300 text-xs">—</span>
                    </td>

                    {# CANAL #}
                    <td class="px-3 py-2.5 text-center">
                        <span class="inline-block text-xs font-semibold px-2 py-0.5 rounded-full {{ order.canal_css }}">
                            {{ order.canal }}
                        </span>
                    </td>

                    {# TOTAL (amount_display tiene "—" para Pending) #}
                    <td class="px-3 py-2.5 text-right font-bold
                               {% if order.amount > 0 %}text-green-700{% else %}text-gray-400{% endif %}">
                        {{ order.amount_display }}
                    </td>

                    {# ESTADO #}
                    <td class="px-3 py-2.5 text-center">
                        <span class="inline-block text-xs font-medium px-2 py-0.5 rounded-full {{ order.status_css }}">
                            {{ order.status }}
                        </span>
                    </td>

                    {# DETALLE — botón expand #}
                    <td class="px-3 py-2.5 text-center">
                        <button
                            onclick="toggleOrderItems('{{ order.order_id }}')"
                            id="btn-{{ order.order_id }}"
                            data-amount="{{ order.amount }}"
                            data-status="{{ order.status }}"
                            data-canal="{{ order.canal }}"
                            data-date="{{ order.date }}"
                            data-units="{{ order.units }}"
                            data-currency="{{ order.currency }}"
                            class="w-7 h-7 flex items-center justify-center mx-auto rounded border border-gray-200
                                   text-[#146EB4] hover:text-[#FF9900] hover:border-[#FF9900] transition text-xs font-bold">
                            ▼
                        </button>
                    </td>
                </tr>

                <!-- Fila expandida — placeholder que persiste en DOM -->
                <tr id="expand-{{ order.order_id }}" class="hidden">
                    <td colspan="7" class="p-0"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pie de tabla -->
    <div class="px-4 py-3 bg-gray-50 border-t text-xs text-gray-400 flex justify-between items-center">
        <span>
            {{ orders | length }} órden{% if orders | length != 1 %}es{% endif %} ·
            período {{ date_from }} → {{ date_to }}
        </span>
        <span class="text-[#FF9900] font-semibold">Amazon SP-API</span>
    </div>
</div>

<!-- ── Nota: órdenes Pendiente ────────────────────────────────────────────── -->
{% set pending_count = orders | selectattr("status_raw", "equalto", "Pending") | list | length %}
{% if pending_count > 0 %}
<p class="text-xs text-gray-400 mt-2 text-right">
    ℹ️ {{ pending_count }} orden{% if pending_count != 1 %}es{% endif %} Pendiente
    no tienen total aún (Amazon no lo expone hasta confirmar el pago)
</p>
{% endif %}
{% endif %}

<!-- ── JS: Toggle + lazy load de producto/SKU ────────────────────────────── -->
<script>
(function () {

    // ── Toggle expand de items ───────────────────────────────────────────────
    window.toggleOrderItems = async function (orderId) {
        const expandRow = document.getElementById('expand-' + orderId);
        const btn       = document.getElementById('btn-'    + orderId);
        if (!expandRow || !btn) return;

        if (expandRow.dataset.loaded === 'true') {
            const hidden = expandRow.classList.contains('hidden');
            expandRow.classList.toggle('hidden', !hidden);
            btn.textContent = hidden ? '▲' : '▼';
            return;
        }

        btn.textContent = '⏳';
        btn.disabled    = true;

        try {
            const params = new URLSearchParams({
                amount:   btn.dataset.amount   || '0',
                status:   btn.dataset.status   || '',
                canal:    btn.dataset.canal    || '',
                date:     btn.dataset.date     || '',
                units:    btn.dataset.units    || '0',
                currency: btn.dataset.currency || 'MXN',
            });
            const resp = await fetch('/api/amazon/orders/' + orderId + '/items?' + params);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const html = await resp.text();

            const td = expandRow.querySelector('td');
            if (td) td.innerHTML = html;

            expandRow.dataset.loaded = 'true';
            expandRow.classList.remove('hidden');
            btn.textContent = '▲';
            btn.disabled    = false;
            expandRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (e) {
            btn.textContent = '✕';
            btn.disabled    = false;
            console.error('[Amazon] items error:', e);
        }
    };

    // ── Lazy load Producto + SKU para todas las filas visibles ───────────────
    // Respeta rate limit: máx 2 concurrent, 1.1s entre lotes
    const _preview_loaded = new Set();

    async function _fetchPreview(orderId) {
        if (_preview_loaded.has(orderId)) return;
        _preview_loaded.add(orderId);

        const prodCell = document.getElementById('prod-' + orderId);
        const skuCell  = document.getElementById('sku-'  + orderId);
        if (!prodCell || !skuCell) return;

        try {
            const resp = await fetch('/api/amazon/orders/' + orderId + '/preview');
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const d = await resp.json();

            if (d.title && d.title !== '—') {
                const extra = d.items_count > 1
                    ? ` <span class="text-gray-400">(+${d.items_count - 1} más)</span>` : '';
                prodCell.innerHTML =
                    `<span class="text-gray-800 text-xs leading-snug block truncate max-w-[200px]"
                           title="${d.title}">${d.title}</span>${extra}`;
            } else {
                prodCell.innerHTML = '<span class="text-gray-400 text-xs">—</span>';
            }

            skuCell.innerHTML = d.sku !== '—'
                ? `<span class="font-mono text-xs font-semibold text-[#146EB4]">${d.sku}</span>`
                : '<span class="text-gray-400 text-xs">—</span>';

        } catch (e) {
            prodCell.innerHTML = '<span class="text-gray-400 text-xs">—</span>';
        }
    }

    async function _enrichVisibleRows() {
        // Solo las primeras 15 filas — Amazon burst capacity = 30 req
        // 3 concurrentes × 5 lotes = 15, aprovecha el burst sin llegar al límite sostenido
        const rows = Array.from(document.querySelectorAll('tr[id^="order-row-"]')).slice(0, 15);
        const BATCH = 3;
        const DELAY = 800;  // ms entre lotes

        for (let i = 0; i < rows.length; i += BATCH) {
            const batch = rows.slice(i, i + BATCH);
            const ids   = batch.map(r => r.id.replace('order-row-', ''));
            await Promise.all(ids.map(_fetchPreview));
            if (i + BATCH < rows.length) {
                await new Promise(r => setTimeout(r, DELAY));
            }
        }
    }

    // Iniciar enriquecimiento 400ms después del render
    setTimeout(_enrichVisibleRows, 400);

})();
</script>

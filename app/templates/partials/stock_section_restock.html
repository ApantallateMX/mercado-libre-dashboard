<!-- OOB KPI updates -->
<div id="kpi-restock-count" hx-swap-oob="true"
     class="bg-white rounded-lg shadow p-4 border-l-4 border-orange-400 cursor-pointer hover:shadow-md hover:bg-orange-50/30 transition"
     onclick="document.getElementById('restock-section').scrollIntoView({behavior:'smooth'})">
    <p class="text-xs text-gray-500">Sin Stock (con BM)</p>
    <p class="text-2xl font-bold text-orange-600">{{ restock_count }}</p>
    <p class="text-[10px] text-gray-400">Con ventas recientes</p>
</div>
<div id="kpi-restock-revenue" hx-swap-oob="true"
     class="bg-white rounded-lg shadow p-4 border-l-4 border-orange-400 cursor-pointer hover:shadow-md hover:bg-orange-50/30 transition"
     onclick="document.getElementById('restock-section').scrollIntoView({behavior:'smooth'})">
    <p class="text-xs text-gray-500">Revenue Perdido (30d)</p>
    <p class="text-2xl font-bold text-orange-600">${{ "{:,.0f}".format(lost_revenue) }}</p>
    <p class="text-[10px] text-gray-400">Click para ver</p>
</div>
<div id="kpi-activate-count" hx-swap-oob="true"
     class="bg-white rounded-lg shadow p-4 border-l-4 border-green-400 cursor-pointer hover:shadow-md hover:bg-green-50/30 transition"
     onclick="document.getElementById('activate-section').scrollIntoView({behavior:'smooth'})">
    <p class="text-xs text-gray-500">Oportunidad Activar</p>
    <p class="text-2xl font-bold text-green-600">{{ activate_count }}</p>
    <p class="text-[10px] text-gray-400">MeLi=0, BM disponible</p>
</div>
<div id="kpi-activate-stock" hx-swap-oob="true"
     class="bg-white rounded-lg shadow p-4 border-l-4 border-green-400 cursor-pointer hover:shadow-md hover:bg-green-50/30 transition"
     onclick="document.getElementById('activate-section').scrollIntoView({behavior:'smooth'})">
    <p class="text-xs text-gray-500">Stock BM Disponible</p>
    <p class="text-2xl font-bold text-green-600">{{ activate_stock }}</p>
    <p class="text-[10px] text-gray-400">Unidades para activar</p>
</div>

<!-- ===== Main content: Restock + Activate ===== -->
<div>

<!-- ===== Seccion A: Reabastecer ===== -->
<div class="mb-8" id="restock-section">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <div class="w-1 h-6 bg-orange-400 rounded"></div>
            <h3 class="text-sm md:text-base font-bold text-gray-800">Reabastecer</h3>
            <span class="text-xs text-gray-400">(MeLi=0, BM disponible)</span>
        </div>
        {% if restock %}
        <button onclick="bulkSyncRestock()" id="bulk-restock-btn"
                class="px-3 py-1.5 bg-purple-600 text-white text-xs font-bold rounded-lg hover:bg-purple-700 active:bg-purple-800 transition">
            Sincronizar Todos ({{ restock|length }})
        </button>
        {% endif %}
    </div>

    {% if restock %}
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2">
        {% for p in restock %}
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-orange-300" id="restock-m-{{ p.id }}">
            <div class="flex gap-3">
                {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="w-12 h-12 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-2">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                <div>
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </div>
                <div><span class="text-gray-500">Ventas:</span> <span class="font-bold">{{ p.get('units', 0) }}</span></div>
                <div><span class="text-gray-500">MeLi:</span> <span class="font-bold text-red-600">0</span></div>
                <div><span class="text-gray-500">BM Disp:</span> <span class="font-bold text-green-600">{{ p.get('_bm_avail', 0) }}</span></div>
                {% if p.get('_bm_mty') is not none %}
                <div class="text-[10px] text-gray-400">MTY:{{ p._bm_mty }} CDMX:{{ p.get('_bm_cdmx', 0) }} TJ:{{ p.get('_bm_tj', 0) }}</div>
                {% endif %}
            </div>
            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                <button onclick="syncRestockItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                        class="flex-1 py-1.5 text-xs bg-purple-600 text-white rounded-lg font-medium active:bg-purple-700 min-h-[36px]">
                    Sync BM
                </button>
                <button onclick="openEditModal('{{ p.id }}')"
                        class="flex-1 py-1.5 text-xs bg-gray-200 text-gray-700 rounded-lg font-medium active:bg-gray-300 min-h-[36px]">
                    Editar
                </button>
                <span id="restock-msg-{{ p.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-orange-50 border-b">
                <tr>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">Producto</th>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">ID / SKU</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Precio</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Retail USD</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Ventas 30d</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Stock MeLi</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">BM Disp.</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">MTY</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">CDMX</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">TJ</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for p in restock %}
                <tr class="hover:bg-orange-50/30" id="restock-d-{{ p.id }}">
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            {% if p.thumbnail %}
                            <img src="{{ p.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <span class="text-gray-800 truncate max-w-[200px] text-xs" title="{{ p.title }}">{{ p.title[:50] }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-blue-600 font-mono font-semibold">{{ p.id }}</span>
                            <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.original_price and p.original_price > p.price %}
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        {% else %}
                        <span class="text-xs font-semibold text-gray-700">${{ "{:,.0f}".format(p.price) }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.get('_bm_retail_price') and p._bm_retail_price > 0 and p._bm_retail_price < 9999 %}
                        <span class="text-xs text-blue-600 font-mono">${{ "{:,.0f}".format(p._bm_retail_price) }}</span>
                        {% else %}
                        <span class="text-xs text-gray-300">—</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-gray-800">{{ p.get('units', 0) }}</td>
                    <td class="px-3 py-2 text-right font-bold text-red-600">0</td>
                    <td class="px-3 py-2 text-right font-bold text-green-600">{{ p.get('_bm_avail', 0) }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_mty', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_cdmx', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_tj') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_tj', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="syncRestockItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, this)"
                                    class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs font-medium transition">
                                Sync BM
                            </button>
                            <button onclick="openEditModal('{{ p.id }}')"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs font-medium transition">
                                Editar
                            </button>
                            <span id="restock-msg-d-{{ p.id }}" class="text-[10px] ml-1"></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">
        Todos los productos con ventas tienen stock en MeLi
    </div>
    {% endif %}
    <span id="bulk-restock-msg" class="text-xs mt-2 block text-center"></span>
</div>

<!-- ===== Seccion C: Activar ===== -->
<div class="mb-6" id="activate-section">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <div class="w-1 h-6 bg-green-400 rounded"></div>
            <h3 class="text-sm md:text-base font-bold text-gray-800">Activar</h3>
            <span class="text-xs text-gray-400">(MeLi=0, BM disponible, sin ventas recientes)</span>
        </div>
        {% if activate %}
        <button onclick="bulkActivateAll()" id="bulk-activate-btn"
                class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 active:bg-green-800 transition">
            Activar Todos ({{ activate|length }})
        </button>
        {% endif %}
    </div>

    {% if activate %}
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2">
        {% for p in activate %}
        <div class="bg-white rounded-lg shadow p-3 border-l-4 border-green-300" id="act-m-{{ p.id }}">
            <div class="flex gap-3">
                {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="w-12 h-12 rounded object-cover flex-shrink-0" alt="">
                {% endif %}
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-gray-800 line-clamp-2">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">{{ p.id }}{% if p.sku %} | {{ p.sku }}{% endif %}</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                <div>
                    {% if p.original_price and p.original_price > p.price %}
                    <span class="text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                    <span class="font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                    {% else %}
                    <span class="font-bold text-gray-800">${{ "{:,.0f}".format(p.price) }}</span>
                    {% endif %}
                </div>
                <div><span class="text-gray-500">MeLi:</span> <span class="font-bold text-red-600">0</span></div>
                <div><span class="text-gray-500">BM Disp:</span> <span class="font-bold text-green-600">{{ p.get('_bm_avail', 0) }}</span></div>
                {% if p.get('_bm_mty') is not none %}
                <div class="text-[10px] text-gray-400">MTY:{{ p._bm_mty }} CDMX:{{ p.get('_bm_cdmx', 0) }} TJ:{{ p.get('_bm_tj', 0) }}</div>
                {% endif %}
                <div>
                    <span class="text-gray-500">Status:</span>
                    <span class="font-bold {{ 'text-yellow-600' if p.status == 'paused' else 'text-gray-600' }}">{{ p.status }}</span>
                </div>
            </div>
            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                <button onclick="activateItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, '{{ p.status }}', this)"
                        class="flex-1 py-1.5 text-xs bg-green-600 text-white rounded-lg font-medium active:bg-green-700 min-h-[36px]">
                    Sync + Activar
                </button>
                <button onclick="openEditModal('{{ p.id }}')"
                        class="flex-1 py-1.5 text-xs bg-gray-200 text-gray-700 rounded-lg font-medium active:bg-gray-300 min-h-[36px]">
                    Editar
                </button>
                <span id="act-msg-{{ p.id }}" class="text-[10px] ml-1 self-center"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop table -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-green-50 border-b">
                <tr>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">Producto</th>
                    <th class="text-left px-3 py-2 text-gray-600 font-medium text-xs">ID / SKU</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">Precio</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Status</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">BM Disp.</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">MTY</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">CDMX</th>
                    <th class="text-right px-3 py-2 text-gray-600 font-medium text-xs">TJ</th>
                    <th class="text-center px-3 py-2 text-gray-600 font-medium text-xs">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for p in activate %}
                <tr class="hover:bg-green-50/30" id="act-d-{{ p.id }}">
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-2">
                            {% if p.thumbnail %}
                            <img src="{{ p.thumbnail }}" class="w-8 h-8 rounded object-cover flex-shrink-0" alt="">
                            {% endif %}
                            <span class="text-gray-800 truncate max-w-[200px] text-xs" title="{{ p.title }}">{{ p.title[:50] }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-blue-600 font-mono font-semibold">{{ p.id }}</span>
                            <span class="text-[10px] text-gray-400 font-mono">{{ p.sku or '-' }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right">
                        {% if p.original_price and p.original_price > p.price %}
                        <span class="text-[10px] text-gray-400 line-through">${{ "{:,.0f}".format(p.original_price) }}</span>
                        <span class="text-xs font-bold text-green-600">${{ "{:,.0f}".format(p.price) }}</span>
                        {% else %}
                        <span class="text-xs font-semibold text-gray-700">${{ "{:,.0f}".format(p.price) }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-center">
                        {% if p.status == 'paused' %}
                        <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full text-[10px] font-medium">Pausado</span>
                        {% elif p.status == 'active' %}
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-[10px] font-medium">Activo</span>
                        {% else %}
                        <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-[10px] font-medium">{{ p.status }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-green-600">{{ p.get('_bm_avail', 0) }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_mty') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_mty', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_cdmx') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_cdmx', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-right text-xs {{ 'text-green-600' if (p.get('_bm_tj') or 0) > 0 else 'text-gray-300' }}">{{ p.get('_bm_tj', 0) or 0 }}</td>
                    <td class="px-3 py-2 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="activateItem('{{ p.id }}', {{ p.get('_bm_avail', 0) }}, '{{ p.status }}', this)"
                                    class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-medium transition">
                                Sync + Activar
                            </button>
                            <button onclick="openEditModal('{{ p.id }}')"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs font-medium transition">
                                Editar
                            </button>
                            <span id="act-msg-d-{{ p.id }}" class="text-[10px] ml-1"></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">
        No hay productos para activar (todos los productos con stock BM ya estan activos en MeLi)
    </div>
    {% endif %}
    <span id="bulk-activate-msg" class="text-xs mt-2 block text-center"></span>
</div>

</div><!-- end main content wrapper -->

<script>
// Update total KPI
if (typeof _updateTotalKpi === 'function') _updateTotalKpi('restock', {{ restock_count + activate_count }});

// --- Restock: sync BM disponible (Available) ---
function syncRestockItem(itemId, bmTotal, btn) {
    var safeQty = bmTotal;  // bmTotal aquí ya es _bm_avail (disponible real)
    btn.disabled = true;
    btn.textContent = '...';
    var msgEl = document.getElementById('restock-msg-' + itemId) || document.getElementById('restock-msg-d-' + itemId);
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: safeQty})
    })
    .then(function(r) {
        if (r.ok) {
            btn.textContent = 'OK (' + safeQty + ')';
            btn.className = btn.className.replace('bg-purple-600', 'bg-green-600').replace('hover:bg-purple-700', '');
            if (msgEl) { msgEl.textContent = 'Stock: ' + safeQty; msgEl.className = 'text-[10px] ml-1 text-green-600 font-semibold'; }
            var row = document.getElementById('restock-m-' + itemId) || document.getElementById('restock-d-' + itemId);
            if (row) row.classList.add('opacity-50');
        } else {
            return r.text().then(function(t) {
                try { var d = JSON.parse(t); throw new Error(d.detail || 'Error'); }
                catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
            });
        }
    })
    .catch(function(e) {
        btn.textContent = 'Error';
        btn.disabled = false;
        if (msgEl) { msgEl.textContent = e.message; msgEl.className = 'text-[10px] ml-1 text-red-600'; }
    });
}

function bulkSyncRestock() {
    var items = [
        {% for p in restock %}
        {id: '{{ p.id }}', bm: {{ p.get('_bm_avail', 0) }} }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ];
    var btn = document.getElementById('bulk-restock-btn');
    var msg = document.getElementById('bulk-restock-msg');
    btn.disabled = true;
    btn.textContent = 'Sincronizando...';
    var done = 0, errors = 0, total = items.length;
    function updateProgress() {
        msg.textContent = done + '/' + total + (errors > 0 ? ' (' + errors + ' errores)' : '');
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    items.forEach(function(item) {
        var qty = item.bm;  // Usa Available directamente
        fetch('/api/items/' + item.id + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: qty})
        })
        .then(function(r) {
            done++;
            if (!r.ok) errors++;
            else {
                var row = document.getElementById('restock-m-' + item.id) || document.getElementById('restock-d-' + item.id);
                if (row) row.classList.add('opacity-50');
            }
            updateProgress();
            if (done === total) {
                btn.textContent = 'Completado';
                btn.className = btn.className.replace('bg-purple-600', 'bg-green-600');
            }
        })
        .catch(function() { done++; errors++; updateProgress(); });
    });
}

// --- Activate: sync stock BM disponible + activate if paused ---
function activateItem(itemId, bmTotal, status, btn) {
    var safeQty = Math.max(1, bmTotal);  // bmTotal aquí ya es _bm_avail
    btn.disabled = true;
    btn.textContent = '...';
    var msgEl = document.getElementById('act-msg-' + itemId) || document.getElementById('act-msg-d-' + itemId);
    fetch('/api/items/' + itemId + '/stock', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
        body: JSON.stringify({quantity: safeQty})
    })
    .then(function(r) {
        if (!r.ok) return r.text().then(function(t) {
            try { var d = JSON.parse(t); throw new Error(d.detail || 'Error stock'); }
            catch(pe) { if (pe.message && pe.message !== t) throw pe; throw new Error(t || 'Error ' + r.status); }
        });
        if (status === 'paused') {
            return fetch('/api/items/' + itemId + '/status', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                body: JSON.stringify({status: 'active'})
            }).then(function(r2) {
                if (!r2.ok && msgEl) { msgEl.textContent = 'Stock OK, activar fallo'; msgEl.className = 'text-[10px] ml-1 text-yellow-600'; }
                return 'done';
            });
        }
        return 'done';
    })
    .then(function() {
        btn.textContent = 'OK (' + safeQty + ')';
        btn.className = btn.className.replace('bg-green-600', 'bg-gray-400').replace('hover:bg-green-700', '');
        if (msgEl) { msgEl.textContent = 'Stock: ' + safeQty + (status === 'paused' ? ' + Activado' : ''); msgEl.className = 'text-[10px] ml-1 text-green-600 font-semibold'; }
        var row = document.getElementById('act-m-' + itemId) || document.getElementById('act-d-' + itemId);
        if (row) row.classList.add('opacity-50');
    })
    .catch(function(e) {
        btn.textContent = 'Error';
        btn.disabled = false;
        if (msgEl) { msgEl.textContent = e.message; msgEl.className = 'text-[10px] ml-1 text-red-600'; }
    });
}

function bulkActivateAll() {
    if (!confirm('Activar TODOS los productos?\n\nSe sincronizara 60% del stock BM y se activaran los pausados.\n\n' + {{ activate|length }} + ' productos seran afectados.')) return;
    var items = [
        {% for p in activate %}
        {id: '{{ p.id }}', bm: {{ p.get('_bm_avail', 0) }}, status: '{{ p.status }}' }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ];
    var btn = document.getElementById('bulk-activate-btn');
    var msg = document.getElementById('bulk-activate-msg');
    btn.disabled = true;
    btn.textContent = 'Activando...';
    var done = 0, errors = 0, total = items.length;
    function updateProgress() {
        msg.textContent = done + '/' + total + (errors > 0 ? ' (' + errors + ' errores)' : '');
        msg.className = 'text-xs mt-2 block text-center ' + (errors > 0 ? 'text-red-600' : 'text-green-600');
    }
    items.forEach(function(item) {
        var qty = Math.max(1, item.bm);  // Usa Available directamente
        fetch('/api/items/' + item.id + '/stock', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({quantity: qty})
        })
        .then(function(r) {
            if (!r.ok) throw new Error('stock fail');
            if (item.status === 'paused') {
                return fetch('/api/items/' + item.id + '/status', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                    body: JSON.stringify({status: 'active'})
                });
            }
        })
        .then(function() {
            done++;
            var row = document.getElementById('act-m-' + item.id) || document.getElementById('act-d-' + item.id);
            if (row) row.classList.add('opacity-50');
            updateProgress();
            if (done === total) {
                btn.textContent = 'Completado';
                btn.className = btn.className.replace('bg-green-600', 'bg-gray-400');
            }
        })
        .catch(function() { done++; errors++; updateProgress(); });
    });
}
</script>

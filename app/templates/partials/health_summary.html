{% if errors %}
<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
    <p class="text-sm font-medium text-red-700">Algunos datos no se pudieron cargar:</p>
    <ul class="text-xs text-red-600 mt-1">
        {% for err in errors %}
        <li>{{ err }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if date_from or date_to %}
<div class="mb-2">
    <span class="text-xs text-gray-400">
        Filtro activo:
        {% if date_from %}desde {{ date_from }}{% endif %}
        {% if date_to %}hasta {{ date_to }}{% endif %}
    </span>
</div>
{% endif %}

<!-- Row 1: Health Score + Reputation Badge + Power Seller -->
<div class="bg-white rounded-lg shadow p-5 mb-4">
    <div class="flex items-center gap-6 flex-wrap">
        <!-- Circular Health Score -->
        {% set score = summary.health_score %}
        {% if score >= 80 %}
            {% set score_color = '#22c55e' %}
            {% set score_bg = 'bg-green-50' %}
            {% set score_label = 'Excelente' %}
        {% elif score >= 60 %}
            {% set score_color = '#eab308' %}
            {% set score_bg = 'bg-yellow-50' %}
            {% set score_label = 'Buena' %}
        {% elif score >= 40 %}
            {% set score_color = '#f97316' %}
            {% set score_bg = 'bg-orange-50' %}
            {% set score_label = 'Regular' %}
        {% else %}
            {% set score_color = '#ef4444' %}
            {% set score_bg = 'bg-red-50' %}
            {% set score_label = 'Critica' %}
        {% endif %}
        <div class="flex-shrink-0 relative" style="width:90px;height:90px">
            <div style="width:90px;height:90px;border-radius:50%;background:conic-gradient({{ score_color }} 0deg, {{ score_color }} {{ (score * 3.6)|round }}deg, #e5e7eb {{ (score * 3.6)|round }}deg, #e5e7eb 360deg);display:flex;align-items:center;justify-content:center;">
                <div class="bg-white rounded-full flex flex-col items-center justify-center" style="width:72px;height:72px">
                    <span class="text-2xl font-bold" style="color:{{ score_color }}">{{ score }}</span>
                    <span class="text-[10px] text-gray-500 -mt-1">de 100</span>
                </div>
            </div>
        </div>
        <div>
            <p class="text-sm text-gray-500 mb-1">Score de Salud</p>
            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold {{ score_bg }}" style="color:{{ score_color }}">
                {{ score_label }}
            </span>
        </div>

        <!-- Divider -->
        <div class="hidden md:block w-px h-16 bg-gray-200"></div>

        <!-- Reputation Badge -->
        {% set level_colors = {
            '5_green': 'text-green-600 bg-green-50',
            '4_light_green': 'text-green-500 bg-green-50',
            '3_yellow': 'text-yellow-600 bg-yellow-50',
            '2_orange': 'text-orange-500 bg-orange-50',
            '1_red': 'text-red-600 bg-red-50',
        } %}
        {% set level_names = {
            '5_green': 'MercadoLider',
            '4_light_green': 'Buena',
            '3_yellow': 'Regular',
            '2_orange': 'Mala',
            '1_red': 'Critica',
        } %}
        <div>
            <p class="text-sm text-gray-500 mb-1">Reputacion</p>
            <span class="inline-block px-3 py-1 rounded-full text-lg font-bold {{ level_colors.get(summary.reputation_level, 'text-gray-800 bg-gray-100') }}">
                {{ level_names.get(summary.reputation_level, summary.reputation_level) }}
            </span>
            {% if summary.power_seller_status %}
            <span class="ml-2 px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-medium">{{ summary.power_seller_status }}</span>
            {% endif %}
        </div>

        <!-- Urgent count -->
        {% if summary.urgent_count > 0 %}
        <div class="ml-auto">
            <div class="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-4 py-2">
                <span class="flex h-3 w-3 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </span>
                <span class="text-sm font-semibold text-red-700">{{ summary.urgent_count }} requiere{{ 'n' if summary.urgent_count != 1 else '' }} atencion</span>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Row 2: 6 Metric Cards with Horizontal Gauges -->
<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
    <!-- Tasa Reclamos -->
    {% set m = summary.claims_margin %}
    <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-xs text-gray-500 mb-1">Tasa Reclamos</p>
        <p class="text-lg font-bold {% if m.status == 'green' %}text-green-600{% elif m.status == 'yellow' %}text-yellow-600{% elif m.status == 'orange' %}text-orange-500{% else %}text-red-600{% endif %}">
            {{ summary.claims_pct }}%
        </p>
        <p class="text-[10px] text-gray-400 mb-2">{{ summary.claims_value }} reclamo{{ 's' if summary.claims_value != 1 else '' }}</p>
        <!-- Gauge bar -->
        <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
            <div class="absolute inset-y-0 left-0 bg-green-400 rounded-l-full" style="width:{{ m.green_end }}%"></div>
            <div class="absolute inset-y-0 bg-yellow-400" style="left:{{ m.green_end }}%;width:{{ m.yellow_end - m.green_end }}%"></div>
            <div class="absolute inset-y-0 bg-orange-400" style="left:{{ m.yellow_end }}%;width:{{ m.red_start - m.yellow_end }}%"></div>
            <div class="absolute inset-y-0 bg-red-400 rounded-r-full" style="left:{{ m.red_start }}%;width:{{ 100 - m.red_start }}%"></div>
        </div>
        <!-- Position marker -->
        <div class="relative h-0">
            <div class="absolute -top-2 w-0 h-0" style="left:calc({{ m.gauge_position }}% - 4px);border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid #374151"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-3">{{ m.margin_label }}</p>
    </div>

    <!-- Tasa Cancelaciones -->
    {% set m = summary.cancel_margin %}
    <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-xs text-gray-500 mb-1">Tasa Cancelaciones</p>
        <p class="text-lg font-bold {% if m.status == 'green' %}text-green-600{% elif m.status == 'yellow' %}text-yellow-600{% elif m.status == 'orange' %}text-orange-500{% else %}text-red-600{% endif %}">
            {{ summary.cancellation_pct }}%
        </p>
        <p class="text-[10px] text-gray-400 mb-2">{{ summary.cancellation_value }} cancelacion{{ 'es' if summary.cancellation_value != 1 else '' }}</p>
        <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
            <div class="absolute inset-y-0 left-0 bg-green-400 rounded-l-full" style="width:{{ m.green_end }}%"></div>
            <div class="absolute inset-y-0 bg-yellow-400" style="left:{{ m.green_end }}%;width:{{ m.yellow_end - m.green_end }}%"></div>
            <div class="absolute inset-y-0 bg-orange-400" style="left:{{ m.yellow_end }}%;width:{{ m.red_start - m.yellow_end }}%"></div>
            <div class="absolute inset-y-0 bg-red-400 rounded-r-full" style="left:{{ m.red_start }}%;width:{{ 100 - m.red_start }}%"></div>
        </div>
        <div class="relative h-0">
            <div class="absolute -top-2 w-0 h-0" style="left:calc({{ m.gauge_position }}% - 4px);border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid #374151"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-3">{{ m.margin_label }}</p>
    </div>

    <!-- Tasa Demoras -->
    {% set m = summary.delay_margin %}
    <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-xs text-gray-500 mb-1">Tasa Demoras</p>
        <p class="text-lg font-bold {% if m.status == 'green' %}text-green-600{% elif m.status == 'yellow' %}text-yellow-600{% elif m.status == 'orange' %}text-orange-500{% else %}text-red-600{% endif %}">
            {{ summary.delayed_pct }}%
        </p>
        <p class="text-[10px] text-gray-400 mb-2">{{ summary.delayed_value }} demora{{ 's' if summary.delayed_value != 1 else '' }}</p>
        <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
            <div class="absolute inset-y-0 left-0 bg-green-400 rounded-l-full" style="width:{{ m.green_end }}%"></div>
            <div class="absolute inset-y-0 bg-yellow-400" style="left:{{ m.green_end }}%;width:{{ m.yellow_end - m.green_end }}%"></div>
            <div class="absolute inset-y-0 bg-orange-400" style="left:{{ m.yellow_end }}%;width:{{ m.red_start - m.yellow_end }}%"></div>
            <div class="absolute inset-y-0 bg-red-400 rounded-r-full" style="left:{{ m.red_start }}%;width:{{ 100 - m.red_start }}%"></div>
        </div>
        <div class="relative h-0">
            <div class="absolute -top-2 w-0 h-0" style="left:calc({{ m.gauge_position }}% - 4px);border-left:4px solid transparent;border-right:4px solid transparent;border-top:5px solid #374151"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-3">{{ m.margin_label }}</p>
    </div>

    <!-- Reclamos Abiertos (clickeable) -->
    <div class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-lg transition {% if summary.open_claims > 0 %}ring-2 ring-red-300{% endif %}"
         onclick="if(window.loadTab) window.loadTab('claims')">
        <p class="text-xs text-gray-500 mb-1">Reclamos Abiertos</p>
        <p class="text-lg font-bold {% if summary.open_claims > 0 %}text-red-600{% else %}text-green-600{% endif %}">
            {{ summary.open_claims }}
        </p>
        <p class="text-[10px] text-gray-400 mb-2">&nbsp;</p>
        <div class="h-2 rounded-full {% if summary.open_claims == 0 %}bg-green-200{% elif summary.open_claims <= 2 %}bg-yellow-200{% else %}bg-red-200{% endif %}">
            <div class="h-2 rounded-full {% if summary.open_claims == 0 %}bg-green-500{% elif summary.open_claims <= 2 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                 style="width:{{ [summary.open_claims * 20, 100]|min }}%"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-3">Clic para ver &rarr;</p>
    </div>

    <!-- Preguntas sin responder (clickeable) -->
    <div class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-lg transition {% if summary.unanswered_questions > 0 %}ring-2 ring-yellow-300{% endif %}"
         onclick="if(window.loadTab) window.loadTab('questions')">
        <p class="text-xs text-gray-500 mb-1">Preguntas Pendientes</p>
        <p class="text-lg font-bold {% if summary.unanswered_questions > 0 %}text-yellow-600{% else %}text-green-600{% endif %}">
            {{ summary.unanswered_questions }}
        </p>
        <p class="text-[10px] text-gray-400 mb-2">&nbsp;</p>
        <div class="h-2 rounded-full {% if summary.unanswered_questions == 0 %}bg-green-200{% elif summary.unanswered_questions <= 3 %}bg-yellow-200{% else %}bg-red-200{% endif %}">
            <div class="h-2 rounded-full {% if summary.unanswered_questions == 0 %}bg-green-500{% elif summary.unanswered_questions <= 3 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                 style="width:{{ [summary.unanswered_questions * 10, 100]|min }}%"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-3">Clic para ver &rarr;</p>
    </div>

    <!-- Mensajes pendientes (clickeable) -->
    <div class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-lg transition"
         onclick="if(window.loadTab) window.loadTab('messages')">
        <p class="text-xs text-gray-500 mb-1">Mensajes</p>
        <p class="text-lg font-bold text-blue-600">
            {{ summary.unread_messages }}
        </p>
        <p class="text-[10px] text-gray-400 mb-2">&nbsp;</p>
        <div class="h-2 rounded-full bg-blue-100">
            <div class="h-2 rounded-full bg-blue-500" style="width:{{ [summary.unread_messages * 5, 100]|min }}%"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-3">Clic para ver &rarr;</p>
    </div>
</div>

<!-- Dynamic sidebar alerts (will be moved to sidebar via JS) -->
<div id="health-dynamic-alerts-source" class="hidden">
    <div class="bg-white rounded-lg shadow p-4 mb-4">
        <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-1">
            <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            Alertas Activas
        </h3>
        <div class="space-y-2">
            {% if summary.open_claims > 0 %}
            <div class="flex items-start gap-2 p-2 bg-red-50 rounded text-xs cursor-pointer hover:bg-red-100"
                 onclick="if(window.loadTab) window.loadTab('claims')">
                <span class="flex h-2 w-2 relative mt-1 flex-shrink-0">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                </span>
                <div>
                    <span class="font-semibold text-red-700">{{ summary.open_claims }} reclamo{{ 's' if summary.open_claims != 1 else '' }} abierto{{ 's' if summary.open_claims != 1 else '' }}</span>
                    <p class="text-red-600 text-[10px]">Resolver para evitar impacto en reputacion</p>
                </div>
            </div>
            {% endif %}

            {% if summary.unanswered_questions > 0 %}
            <div class="flex items-start gap-2 p-2 bg-yellow-50 rounded text-xs cursor-pointer hover:bg-yellow-100"
                 onclick="if(window.loadTab) window.loadTab('questions')">
                <span class="w-2 h-2 rounded-full bg-yellow-500 mt-1 flex-shrink-0"></span>
                <div>
                    <span class="font-semibold text-yellow-700">{{ summary.unanswered_questions }} pregunta{{ 's' if summary.unanswered_questions != 1 else '' }} sin responder</span>
                    <p class="text-yellow-600 text-[10px]">Responder rapido mejora la conversion</p>
                </div>
            </div>
            {% endif %}

            {% if summary.claims_margin.status in ['orange', 'red'] %}
            <div class="flex items-start gap-2 p-2 bg-orange-50 rounded text-xs">
                <span class="w-2 h-2 rounded-full bg-orange-500 mt-1 flex-shrink-0"></span>
                <div>
                    <span class="font-semibold text-orange-700">Tasa reclamos {{ summary.claims_margin.label|lower }}</span>
                    <p class="text-orange-600 text-[10px]">{{ summary.claims_margin.margin_label }}</p>
                </div>
            </div>
            {% endif %}

            {% if summary.cancel_margin.status in ['orange', 'red'] %}
            <div class="flex items-start gap-2 p-2 bg-orange-50 rounded text-xs">
                <span class="w-2 h-2 rounded-full bg-orange-500 mt-1 flex-shrink-0"></span>
                <div>
                    <span class="font-semibold text-orange-700">Tasa cancelaciones {{ summary.cancel_margin.label|lower }}</span>
                    <p class="text-orange-600 text-[10px]">{{ summary.cancel_margin.margin_label }}</p>
                </div>
            </div>
            {% endif %}

            {% if summary.delay_margin.status in ['orange', 'red'] %}
            <div class="flex items-start gap-2 p-2 bg-orange-50 rounded text-xs">
                <span class="w-2 h-2 rounded-full bg-orange-500 mt-1 flex-shrink-0"></span>
                <div>
                    <span class="font-semibold text-orange-700">Tasa demoras {{ summary.delay_margin.label|lower }}</span>
                    <p class="text-orange-600 text-[10px]">{{ summary.delay_margin.margin_label }}</p>
                </div>
            </div>
            {% endif %}

            {% if summary.open_claims == 0 and summary.unanswered_questions == 0 and summary.claims_margin.status == 'green' and summary.cancel_margin.status == 'green' and summary.delay_margin.status == 'green' %}
            <div class="flex items-start gap-2 p-2 bg-green-50 rounded text-xs">
                <svg class="w-4 h-4 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span class="font-semibold text-green-700">Todo en orden â€” sin alertas activas</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
(function() {
    var src = document.getElementById('health-dynamic-alerts-source');
    var target = document.getElementById('health-sidebar-dynamic');
    if (src && target) {
        target.innerHTML = src.innerHTML;
    }
})();
</script>

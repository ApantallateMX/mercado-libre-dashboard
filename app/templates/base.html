<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %} - Mercado Libre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [hx-indicator] .htmx-indicator { display: none; }
        [hx-indicator].htmx-request .htmx-indicator { display: inline; }
        /* Mobile touch targets & prevent iOS zoom on focus */
        @media (max-width: 767px) {
            input, select, textarea, button { min-height: 44px; font-size: 16px; }
            input[type="checkbox"], input[type="radio"] { min-height: auto; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    {% if user %}
    <nav class="bg-yellow-400 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-14 md:h-16 items-center">
                <!-- Logo + hamburger -->
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="md:hidden p-2.5 -ml-2 rounded-lg hover:bg-yellow-500 active:bg-yellow-600" aria-label="Menu">
                        <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <a href="/dashboard" class="font-bold text-lg md:text-xl text-gray-800">MeLi</a>
                </div>
                <!-- Desktop nav links -->
                <div class="hidden md:flex items-center space-x-5 text-sm">
                    <a href="/multi-dashboard" class="text-gray-700 hover:text-gray-900 {% if active == 'multi_dashboard' %}font-semibold{% endif %} flex items-center gap-1">
                        <span class="text-yellow-600">⊕</span> Vista General
                    </a>
                    <a href="/inventory-global" class="text-gray-700 hover:text-gray-900 {% if active == 'inventory_global' %}font-semibold{% endif %} flex items-center gap-1">
                        <span class="text-indigo-500">▦</span> Inv. Global
                    </a>
                    <a href="/dashboard" class="text-gray-700 hover:text-gray-900 {% if active == 'dashboard' %}font-semibold{% endif %}">Dashboard</a>
                    <a href="/orders" class="text-gray-700 hover:text-gray-900 {% if active == 'orders' %}font-semibold{% endif %}">Ventas</a>
                    <a href="/items" class="text-gray-700 hover:text-gray-900 {% if active == 'items' %}font-semibold{% endif %}">Productos</a>
                    <a href="/items-health" class="text-gray-700 hover:text-gray-900 {% if active == 'items_health' %}font-semibold{% endif %}">Optimizar</a>
                    <a href="/sku-sales" class="text-gray-700 hover:text-gray-900 {% if active == 'sku_sales' %}font-semibold{% endif %}">SKU Ventas</a>
                    <a href="/sku-compare" class="text-gray-700 hover:text-gray-900 {% if active == 'sku_compare' %}font-semibold{% endif %}">Comparativa</a>
                    <a href="/sku-inventory" class="text-gray-700 hover:text-gray-900 {% if active == 'sku_inventory' %}font-semibold{% endif %}">Lanzar</a>
                    <a href="/ads" class="text-gray-700 hover:text-gray-900 {% if active == 'ads' %}font-semibold{% endif %}">Ads</a>
                    <a href="/health" class="text-gray-700 hover:text-gray-900 relative {% if active == 'health' %}font-semibold{% endif %}">
                        Salud
                        <span id="health-badge" class="hidden absolute -top-1 -right-3 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold"></span>
                    </a>
                </div>
                <!-- ══ Selector de cuentas multi-plataforma (desktop) ══
                     Muestra dos secciones separadas:
                     1. MERCADO LIBRE — cuentas MeLi con badge amarillo
                     2. AMAZON       — cuentas Amazon con badge naranja
                     Cada plataforma tiene su propia cookie activa:
                     - active_account_id  → MeLi
                     - active_amazon_id   → Amazon
                -->
                <div class="flex items-center gap-2">
                    <div class="relative" id="account-menu-wrap">
                        <!-- Botón principal — muestra cuenta MeLi activa -->
                        <button type="button"
                            onclick="document.getElementById('account-dropdown').classList.toggle('hidden')"
                            class="flex items-center gap-1.5 text-gray-700 text-sm hover:text-gray-900 cursor-pointer select-none bg-yellow-300 hover:bg-yellow-200 px-3 py-1.5 rounded-lg transition">
                            <!-- Badge de plataforma MeLi -->
                            <span class="text-xs font-bold text-yellow-700">ML</span>
                            <span class="max-w-[110px] truncate font-medium">{{ user.nickname }}</span>
                            {% if amazon_accounts %}
                            <!-- Indicador de que también hay cuentas Amazon conectadas -->
                            <span class="text-xs font-bold bg-orange-500 text-white px-1 rounded">AMZ</span>
                            {% endif %}
                            <svg class="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>

                        <!-- Dropdown con ambas plataformas -->
                        <div id="account-dropdown" class="hidden absolute right-0 top-full mt-1 bg-white rounded-xl shadow-xl border border-gray-100 z-50 min-w-[240px] py-2">

                            <!-- ─── SECCIÓN MERCADO LIBRE ─────────────────── -->
                            <div class="px-4 py-1.5 flex items-center gap-2">
                                <span class="text-xs font-bold bg-yellow-400 text-gray-800 px-1.5 py-0.5 rounded">ML</span>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Mercado Libre</p>
                            </div>
                            {% for account in accounts %}
                            <form action="/auth/switch-account" method="POST">
                                <input type="hidden" name="user_id" value="{{ account.user_id }}">
                                <button type="submit" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-left hover:bg-yellow-50 transition-colors">
                                    {% if account.user_id == active_user_id %}
                                    <span class="w-5 h-5 rounded-full bg-yellow-400 flex items-center justify-center text-xs font-bold text-gray-800 shrink-0">✓</span>
                                    {% else %}
                                    <span class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-400 shrink-0">○</span>
                                    {% endif %}
                                    <span class="{% if account.user_id == active_user_id %}font-semibold text-gray-800{% else %}text-gray-600{% endif %} truncate">
                                        {{ account.nickname or account.user_id }}
                                    </span>
                                </button>
                            </form>
                            {% endfor %}

                            <!-- ─── SECCIÓN AMAZON ────────────────────────── -->
                            {% if amazon_accounts %}
                            <hr class="my-1.5 border-gray-100">
                            <div class="px-4 py-1.5 flex items-center gap-2">
                                <span class="text-xs font-bold bg-orange-500 text-white px-1.5 py-0.5 rounded">AMZ</span>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Amazon</p>
                            </div>
                            {% for amz in amazon_accounts %}
                            <form action="/auth/switch-amazon" method="POST">
                                <input type="hidden" name="seller_id" value="{{ amz.seller_id }}">
                                <button type="submit" class="flex items-center gap-2 w-full px-4 py-2 text-sm text-left hover:bg-orange-50 transition-colors">
                                    {% if amz.seller_id == active_amazon_id %}
                                    <span class="w-5 h-5 rounded-full bg-orange-400 flex items-center justify-center text-xs font-bold text-white shrink-0">✓</span>
                                    {% else %}
                                    <span class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-400 shrink-0">○</span>
                                    {% endif %}
                                    <div class="flex flex-col min-w-0">
                                        <span class="{% if amz.seller_id == active_amazon_id %}font-semibold text-gray-800{% else %}text-gray-600{% endif %} truncate">
                                            {{ amz.nickname or amz.seller_id }}
                                        </span>
                                        <span class="text-xs text-gray-400">{{ amz.marketplace_name }} · {{ amz.seller_id }}</span>
                                    </div>
                                </button>
                            </form>
                            {% endfor %}
                            {% endif %}

                            <!-- ─── AGREGAR CUENTAS ───────────────────────── -->
                            <hr class="my-1.5 border-gray-100">
                            <a href="/auth/connect" class="flex items-center gap-2 px-4 py-2 text-sm text-yellow-600 hover:bg-yellow-50 transition-colors">
                                <span class="w-5 h-5 rounded-full bg-yellow-100 flex items-center justify-center text-xs font-bold text-yellow-600 shrink-0">+</span>
                                Agregar cuenta MeLi
                            </a>
                            <a href="/auth/amazon/connect" class="flex items-center gap-2 px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 transition-colors">
                                <span class="w-5 h-5 rounded-full bg-orange-100 flex items-center justify-center text-xs font-bold text-orange-600 shrink-0">+</span>
                                Agregar cuenta Amazon
                            </a>
                        </div>
                    </div>

                    <form action="/auth/logout" method="POST" class="inline">
                        <button type="submit" class="bg-gray-800 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-gray-700 transition">
                            Salir
                        </button>
                    </form>
                </div>
                <script>
                document.addEventListener('click', function(e) {
                    var wrap = document.getElementById('account-menu-wrap');
                    var dd = document.getElementById('account-dropdown');
                    if (wrap && dd && !wrap.contains(e.target)) dd.classList.add('hidden');
                });
                </script>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-yellow-500 bg-yellow-400">
            <div class="grid grid-cols-3 gap-1 px-3 py-3">
                <a href="/multi-dashboard" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'multi_dashboard' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span class="text-sm text-gray-800">General</span>
                </a>
                <a href="/inventory-global" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'inventory_global' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    <span class="text-sm text-gray-800">Inv. Global</span>
                </a>
                <a href="/dashboard" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'dashboard' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>
                    <span class="text-sm text-gray-800">Dashboard</span>
                </a>
                <a href="/orders" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'orders' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <span class="text-sm text-gray-800">Ventas</span>
                </a>
                <a href="/items" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'items' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    <span class="text-sm text-gray-800">Productos</span>
                </a>
                <a href="/items-health" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'items_health' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="text-sm text-gray-800">Optimizar</span>
                </a>
                <a href="/sku-sales" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'sku_sales' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                    <span class="text-sm text-gray-800">SKU Ventas</span>
                </a>
                <a href="/sku-compare" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'sku_compare' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span class="text-sm text-gray-800">Comparativa</span>
                </a>
                <a href="/sku-inventory" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'sku_inventory' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="text-sm text-gray-800">Lanzar</span>
                </a>
                <a href="/ads" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'ads' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/></svg>
                    <span class="text-sm text-gray-800">Ads</span>
                </a>
                <a href="/health" class="flex flex-col items-center gap-1 min-h-[48px] py-2 px-1 rounded-lg hover:bg-yellow-500 active:bg-yellow-600 {% if active == 'health' %}bg-yellow-500 font-semibold{% endif %}">
                    <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                    <span class="text-sm text-gray-800">Salud</span>
                </a>
            </div>
            <!-- ══ Selector de cuentas en móvil — multi-plataforma ══ -->
            <div class="px-3 pb-3 border-t border-yellow-500 pt-3">

                <!-- Sección Mercado Libre -->
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-bold bg-yellow-500 text-gray-800 px-1.5 py-0.5 rounded">ML</span>
                    <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Mercado Libre</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    {% for account in accounts %}
                    <form action="/auth/switch-account" method="POST">
                        <input type="hidden" name="user_id" value="{{ account.user_id }}">
                        <button type="submit" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-left transition
                            {% if account.user_id == active_user_id %}bg-yellow-500 font-bold text-gray-800{% else %}bg-yellow-300 hover:bg-yellow-400 text-gray-700{% endif %}">
                            {% if account.user_id == active_user_id %}<span class="shrink-0">✓</span>{% endif %}
                            <span class="truncate">{{ account.nickname or account.user_id }}</span>
                        </button>
                    </form>
                    {% endfor %}
                </div>

                <!-- Sección Amazon (solo si hay cuentas conectadas) -->
                {% if amazon_accounts %}
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-bold bg-orange-500 text-white px-1.5 py-0.5 rounded">AMZ</span>
                    <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Amazon</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    {% for amz in amazon_accounts %}
                    <form action="/auth/switch-amazon" method="POST">
                        <input type="hidden" name="seller_id" value="{{ amz.seller_id }}">
                        <button type="submit" class="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-left transition
                            {% if amz.seller_id == active_amazon_id %}bg-orange-400 font-bold text-white{% else %}bg-orange-100 hover:bg-orange-200 text-gray-700{% endif %}">
                            {% if amz.seller_id == active_amazon_id %}<span class="shrink-0">✓</span>{% endif %}
                            <span class="truncate">{{ amz.nickname or amz.seller_id }}</span>
                        </button>
                    </form>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

    </nav>
    <!-- Notification Toast Container -->
    <div id="notif-container" class="fixed top-4 left-4 right-4 md:left-auto md:right-4 md:max-w-sm z-50 flex flex-col gap-2"></div>
    {% endif %}

    <main class="max-w-7xl mx-auto py-3 px-2 md:py-6 md:px-4">
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}{% endblock %}

    <script src="/static/js/notifications.js"></script>
</body>
</html>
